<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a237e">
    <meta http-equiv="Permissions-Policy" content="camera=*, microphone=()">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Inventario 2026 - Industronic</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, where, updateDoc, doc, orderBy, getDocs, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBUXMdQCrVGnUHcHwykw0HN-FcO7y_cMhI",
            authDomain: "inventario-industronic.firebaseapp.com",
            projectId: "inventario-industronic",
            storageBucket: "inventario-industronic.firebasestorage.app",
            messagingSenderId: "147085153787",
            appId: "1:147085153787:web:cdb6895bfa687ce44e275e"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Hacer disponible globalmente
        window.firebaseDB = db;
        window.firebaseCollections = { collection, addDoc, onSnapshot, query, where, updateDoc, doc, orderBy, getDocs, setDoc };
    </script>
    
    <!-- Google Sheets API Configuration -->
    <script>
        // Google Apps Script Web App URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxo7Ick23HPDqtThOqkrcddcEZUHe_bS0Npgex_UnegCC7vk9pNpCAufFYYlmU3kPZs/exec';
        
        // Funci√≥n para escribir en Google Sheets via Apps Script
        async function escribirEnGoogleSheets(registros) {
            if (!Array.isArray(registros) || registros.length === 0) return false;
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        registros: registros
                    })
                });
                
                console.log('‚úÖ Datos enviados a Google Sheets:', registros.length, 'registros');
                return true;
                
            } catch (error) {
                console.error('‚ùå Error al escribir en Google Sheets:', error);
                return false;
            }
        }
        
        // Hacer disponible globalmente
        window.escribirEnGoogleSheets = escribirEnGoogleSheets;
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(180deg, #1565c0 0%, #1565c0 40%, #e3f2fd 40%, #e3f2fd 100%);
            min-height: 100vh;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            width: 100%;
            min-height: auto;
            background: transparent;
        }

        /* Header principal - Card flotante */
        .header-main {
            background: white;
            padding: 40px 24px 32px;
            text-align: center;
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            margin-bottom: 20px;
        }

        .header-main h1 {
            color: #1565c0;
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .header-main h2 {
            color: #1565c0;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .header-main p {
            color: #757575;
            font-size: 14px;
            font-weight: 500;
        }

        /* Logo circular - INDUSTRONIC */
        .logo-circle {
            width: 80px;
            height: 80px;
            background: #1565c0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 28px;
            font-weight: 700;
            color: white;
            letter-spacing: 2px;
            padding: 0 4px;
        }

        .logo-circle .i-flip {
            display: inline-block;
            transform: rotate(180deg);
            margin-left: -2px;
        }

        /* Content area - Card flotante */
        .content-white {
            background: white;
            min-height: auto;
            padding: 24px 20px 32px;
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        /* User cards grid - 2x2 */
        .user-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 0;
        }

        .user-card {
            background: #f5f5f5;
            border-radius: 16px;
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            position: relative;
        }

        .user-card:hover {
            background: #eeeeee;
            transform: translateY(-2px);
        }

        .user-card:active {
            transform: scale(0.98);
        }

        .user-card .icon {
            font-size: 36px;
            margin-bottom: 12px;
        }

        .user-card h3 {
            color: #1a237e;
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .user-card p {
            color: #9e9e9e;
            font-size: 12px;
            font-weight: 500;
        }

        .user-card.needs-password::after {
            content: "üîí";
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
        }

        /* Buttons */
        .btn-primary {
            background: #1a237e;
            color: white;
            font-weight: 700;
            padding: 16px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.3);
        }

        .btn-primary:active {
            transform: scale(0.98);
            background: #0d1742;
        }

        .btn-success {
            background: #4caf50;
            color: white;
            font-weight: 600;
            padding: 14px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 15px;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .btn-secondary {
            background: white;
            color: #1a237e;
            font-weight: 600;
            padding: 14px 24px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            width: 100%;
            font-size: 15px;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        /* Header interno */
        .header-inner {
            background: #1a237e;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }

        .header-inner h1 {
            font-size: 17px;
            font-weight: 700;
            flex: 1;
        }

        .btn-back {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            background: white;
            border-radius: 8px;
            padding: 4px;
            margin: 16px;
            border: 1px solid #e0e0e0;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 600;
            color: #757575;
            transition: all 0.2s;
            font-size: 14px;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .tab-btn.active {
            background: #1a237e;
            color: white;
        }

        /* Scan area */
        .scan-area {
            padding: 0 16px;
        }

        .scan-box {
            background: white;
            border-radius: 8px;
            padding: 32px 20px;
            text-align: center;
            border: 2px dashed #e0e0e0;
            margin-bottom: 20px;
        }

        .scan-icon {
            font-size: 56px;
            margin-bottom: 16px;
        }

        .scan-box h3 {
            color: #1a237e;
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .scan-box p {
            color: #757575;
            font-size: 14px;
            font-weight: 500;
        }

        /* QR Reader container */
        #qr-reader {
            width: 100%;
            margin: 16px 0;
        }

        #qr-reader__dashboard_section_swaplink {
            display: none !important;
        }

        /* Lista de escaneados */
        .scanned-list {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 80px;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f5f5f5;
        }

        .list-header h3 {
            color: #1a237e;
            font-size: 15px;
            font-weight: 700;
        }

        .count-badge {
            background: #1a237e;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .scanned-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .scanned-item .info {
            flex: 1;
        }

        .scanned-item .folio {
            font-weight: 700;
            color: #1a237e;
            font-size: 15px;
        }

        .scanned-item .details {
            font-size: 12px;
            color: #757575;
            font-weight: 500;
        }

        .scanned-item .qty {
            font-weight: 700;
            color: #4caf50;
            font-size: 15px;
        }

        .btn-remove {
            background: #f44336;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 32px 16px;
            color: #9e9e9e;
            font-size: 14px;
        }

        /* Confirm bar */
        .confirm-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 500px;
            width: 100%;
            background: white;
            padding: 16px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: none;
        }

        .confirm-bar.show {
            display: block;
        }

        /* Form manual */
        .form-manual {
            padding: 0 16px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            color: #424242;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 500;
            background: white;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #1a237e;
        }

        .two-cols {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Screens */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* User selection */
        .user-selection {
            margin-bottom: 24px;
        }

        .user-selection h3 {
            color: #1a237e;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            text-align: center;
        }

        .user-list {
            display: grid;
            gap: 10px;
        }

        .user-option {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 14px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            color: #424242;
        }

        .user-option.selected {
            border-color: #1a237e;
            background: #e8eaf6;
            color: #1a237e;
        }

        .user-option .icon {
            font-size: 18px;
        }

        /* Menu cards */
        .menu-grid {
            display: grid;
            gap: 12px;
            padding: 0 16px;
        }

        .menu-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            border: 1px solid #e0e0e0;
        }

        .menu-card:active {
            transform: scale(0.98);
        }

        .icon-box {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }

        .icon-box.blue { background: #e3f2fd; }
        .icon-box.green { background: #e8f5e9; }
        .icon-box.gray { background: #f5f5f5; }
        .icon-box.orange { background: #fff3e0; }
        .icon-box.purple { background: #f3e5f5; }

        .menu-card .text {
            flex: 1;
        }

        .menu-card h3 {
            color: #1a237e;
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .menu-card p {
            color: #757575;
            font-size: 12px;
            font-weight: 500;
        }

        .menu-card .arrow {
            color: #bdbdbd;
            font-size: 20px;
        }

        /* Control de Almacenes y Segundo Conteo */
        .almacen-control-item, .segundo-conteo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .almacen-control-item:last-child, .segundo-conteo-item:last-child {
            border-bottom: none;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #1a237e;
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* Registros cards - ESTILO P√ÅGINA UBICACIONES */
        .registro-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin: 0 16px 12px;
            border: 1px solid #e0e0e0;
        }

        .registro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .registro-folio {
            font-size: 20px;
            font-weight: 800;
            color: #1a237e;
            letter-spacing: 0.5px;
        }

        .registro-badge {
            background: #fff3cd;
            color: #856404;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .registro-badge.positivo {
            background: #f8d7da;
            color: #721c24;
        }

        .registro-badge.duplicado {
            background: #fff3cd;
            color: #856404;
        }

        .registro-badge.almacen {
            background: #e0e0e0;
            color: #616161;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .registro-nota {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            padding: 8px 12px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #856404;
        }

        .registro-nota strong {
            font-weight: 700;
        }

        .registro-sap {
            color: #1976d2;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 6px;
            letter-spacing: 0.3px;
        }

        .registro-desc {
            color: #757575;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .registro-meta {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #616161;
            padding-top: 12px;
            border-top: 1px solid #f5f5f5;
            align-items: center;
        }

        .registro-meta strong {
            color: #212121;
            font-weight: 700;
        }

        .registro-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .btn-icon {
            background: #f5f5f5;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-icon.delete {
            background: #ffebee;
        }

        /* Dashboard */
        .progress-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 16px;
            border: 1px solid #e0e0e0;
        }

        .progress-bar {
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #1a237e;
            border-radius: 6px;
        }

        .stats-row {
            display: flex;
            gap: 12px;
            margin: 16px;
        }

        .stats-row .stat-card {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .stats-row .stat-card .icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .stats-row .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #1a237e;
        }

        .stats-row .stat-card .label {
            font-size: 11px;
            color: #757575;
            font-weight: 600;
        }

        .almacen-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 16px;
            border: 1px solid #e0e0e0;
        }

        .almacen-card h3 {
            color: #1a237e;
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .almacen-item {
            margin-bottom: 14px;
        }

        .almacen-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .almacen-name {
            color: #424242;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .almacen-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .almacen-percent {
            color: #757575;
            font-weight: 500;
        }

        .almacen-bar {
            height: 6px;
            background: #f5f5f5;
            border-radius: 3px;
            overflow: hidden;
        }

        .almacen-fill {
            height: 100%;
        }

        /* Success overlay */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .success-overlay.show {
            display: flex;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #4caf50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            color: white;
            margin-bottom: 16px;
        }

        .success-overlay h2 {
            color: white;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .success-overlay p {
            color: rgba(255,255,255,0.8);
            font-size: 15px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
        }

        .modal-content h3 {
            color: #1a237e;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Form scan */
        .scan-form {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 0 16px 20px;
            border: 1px solid #e0e0e0;
        }

        .scan-form h4 {
            color: #1a237e;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .field-readonly {
            margin-bottom: 12px;
        }

        .field-readonly label {
            display: block;
            color: #757575;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .field-readonly .value {
            color: #212121;
            font-size: 14px;
            font-weight: 600;
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        /* Upload area */
        .upload-area {
            background: white;
            border-radius: 8px;
            padding: 28px 20px;
            text-align: center;
            border: 2px dashed #e0e0e0;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .upload-area .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .upload-area h4 {
            color: #1a237e;
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .upload-area p {
            color: #757575;
            font-size: 12px;
        }

        .file-preview {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 14px;
            margin-top: 12px;
            display: none;
        }

        .file-preview.show {
            display: block;
        }

        .file-preview .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-preview .file-icon {
            font-size: 28px;
        }

        .file-preview .file-name {
            flex: 1;
            font-weight: 600;
            color: #1a237e;
            font-size: 13px;
        }

        .file-preview .file-remove {
            background: #f44336;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Search box */
        /* Search box mejorado con filtros */
        .search-container {
            padding: 16px;
        }

        .search-box {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 14px;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .search-box button {
            background: #1a237e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 20px;
            cursor: pointer;
        }

        .filter-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-chip {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: #616161;
            transition: all 0.2s;
        }

        .filter-chip.active {
            background: #1a237e;
            color: white;
            border-color: #1a237e;
        }

        .filter-dropdown {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
            margin-top: 8px;
            display: none;
        }

        .filter-dropdown.show {
            display: block;
        }

        .filter-option {
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            color: #424242;
        }

        .filter-option:hover {
            background: #f5f5f5;
        }

        .filter-option.selected {
            background: #e8eaf6;
            color: #1a237e;
            font-weight: 600;
        }

        .results-count {
            padding: 8px 16px;
            color: white;
            font-size: 13px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ========== PANTALLA LOGIN ========== -->
        <div id="screen-login" class="screen active">
            <div class="header-main">
                <div class="logo-circle">i<span class="i-flip">i</span></div>
                <h1>Inventario 2026</h1>
                <p>Selecciona tu tipo de acceso</p>
            </div>

            <div class="content-white">
                <div class="user-grid">
                    <div class="user-card" onclick="showScreen('capturista-login')">
                        <div class="icon">üì±</div>
                        <h3>Capturista</h3>
                        <p>Captura de marbetes</p>
                    </div>

                    <div class="user-card needs-password" onclick="showPasswordModal('auditoria-conteo')">
                        <div class="icon">üîç</div>
                        <h3>Auditor√≠a de Conteo</h3>
                        <p>üîí Clave</p>
                    </div>

                    <div class="user-card needs-password" onclick="showPasswordModal('mesa')">
                        <div class="icon">üìã</div>
                        <h3>Mesa Control</h3>
                        <p>üîí Clave</p>
                    </div>

                    <div class="user-card needs-password" onclick="showPasswordModal('auditoria')">
                        <div class="icon">‚≠ê</div>
                        <h3>Auditor√≠a</h3>
                        <p>üîí Clave</p>
                    </div>

                    <div class="user-card" onclick="showScreen('dashboard')">
                        <div class="icon">üìä</div>
                        <h3>Dashboard</h3>
                        <p>Reportes y avance</p>
                    </div>

                    <div class="user-card" onclick="showScreen('buscador-sap')">
                        <div class="icon">üì¶</div>
                        <h3>Buscador SAP</h3>
                        <p>Consulta vs Kardex</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== LOGIN CAPTURISTA ========== -->
        <div id="screen-capturista-login" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="showScreen('login')">‚Üê</button>
                <h1>Selecciona tu nombre</h1>
            </div>

            <div class="content-white">
                <div class="user-selection">
                    <h3>¬øQui√©n eres?</h3>
                    
                    <!-- Buscador -->
                    <input type="text" id="search-user" placeholder="üîç Buscar por nombre..." 
                           onkeyup="filtrarUsuarios()" 
                           style="width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                    
                    <div class="user-list" id="user-list">
                        <div class="user-option" onclick="selectUser(this, 'ANA CECILIA ESCALANTE HERRERA')">
                            <span class="icon">üë§</span>
                            ANA CECILIA ESCALANTE HERRERA
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'ANDREA CASTRO ROMERO')">
                            <span class="icon">üë§</span>
                            ANDREA CASTRO ROMERO
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'ANGIE NOHEMI MARTINEZ GUEVARA')">
                            <span class="icon">üë§</span>
                            ANGIE NOHEMI MARTINEZ GUEVARA
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'BRENDA ABIGAIL AGUI√ëAGA GALLARDO')">
                            <span class="icon">üë§</span>
                            BRENDA ABIGAIL AGUI√ëAGA GALLARDO
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'CARMEN DEL ROCIO CAMARA URIETA')">
                            <span class="icon">üë§</span>
                            CARMEN DEL ROCIO CAMARA URIETA
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'DANIEL OMAR ARENAS SOLORIO')">
                            <span class="icon">üë§</span>
                            DANIEL OMAR ARENAS SOLORIO
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'EVELIN YAHAIRA RUIZ ESPINOSA')">
                            <span class="icon">üë§</span>
                            EVELIN YAHAIRA RUIZ ESPINOSA
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'INGRID GONZALEZ SAUCEDO')">
                            <span class="icon">üë§</span>
                            INGRID GONZALEZ SAUCEDO
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'JAHYR CASTRO')">
                            <span class="icon">üë§</span>
                            JAHYR CASTRO
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'JENNIFER GERALDINE FLORES SANCHEZ')">
                            <span class="icon">üë§</span>
                            JENNIFER GERALDINE FLORES SANCHEZ
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'MARIO ALBERTO LOPEZ SAUCEDO')">
                            <span class="icon">üë§</span>
                            MARIO ALBERTO LOPEZ SAUCEDO
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'OSCAR BUTANDA')">
                            <span class="icon">üë§</span>
                            OSCAR BUTANDA
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'PAOLA YAMILETH GARCIA SANCHEZ')">
                            <span class="icon">üë§</span>
                            PAOLA YAMILETH GARCIA SANCHEZ
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'PATRICIO MAXIMILIANO CARRILLO RAMIREZ')">
                            <span class="icon">üë§</span>
                            PATRICIO MAXIMILIANO CARRILLO RAMIREZ
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'SANDRA ANTONIO BENITO')">
                            <span class="icon">üë§</span>
                            SANDRA ANTONIO BENITO
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'JOSE NAPOLEON PEREZ')">
                            <span class="icon">üë§</span>
                            JOSE NAPOLEON PEREZ
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'JESUS GABRIEL FLORES')">
                            <span class="icon">üë§</span>
                            JESUS GABRIEL FLORES
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'AMALIA DOMINGUEZ')">
                            <span class="icon">üë§</span>
                            AMALIA DOMINGUEZ
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'HILARY NAHOMI GARCIA')">
                            <span class="icon">üë§</span>
                            HILARY NAHOMI GARCIA
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'BLANCA ALICIA AVALOS ROMO')">
                            <span class="icon">üë§</span>
                            BLANCA ALICIA AVALOS ROMO
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'EDSON ALEJANDRO ENCINIA HERNANDEZ')">
                            <span class="icon">üë§</span>
                            EDSON ALEJANDRO ENCINIA HERNANDEZ
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'ENRIQUE CORTEZ RIOS')">
                            <span class="icon">üë§</span>
                            ENRIQUE CORTEZ RIOS
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'ENRIQUE FERNANDO GARCIA MORENO')">
                            <span class="icon">üë§</span>
                            ENRIQUE FERNANDO GARCIA MORENO
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'ERICK ORLANDO CORTEZ GONZALEZ')">
                            <span class="icon">üë§</span>
                            ERICK ORLANDO CORTEZ GONZALEZ
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'HIRAM ENRIQUE CORTEZ GARZA')">
                            <span class="icon">üë§</span>
                            HIRAM ENRIQUE CORTEZ GARZA
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'LOLIS PEREZ SIMANCAS')">
                            <span class="icon">üë§</span>
                            LOLIS PEREZ SIMANCAS
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'YARELLI GUADALUPE HERNANDEZ GARCIA')">
                            <span class="icon">üë§</span>
                            YARELLI GUADALUPE HERNANDEZ GARCIA
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'MARIO (CALIDAD)')">
                            <span class="icon">üë§</span>
                            MARIO (CALIDAD)
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'USUARIO GENERICO 1')">
                            <span class="icon">üë§</span>
                            USUARIO GENERICO 1
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'USUARIO GENERICO 2')">
                            <span class="icon">üë§</span>
                            USUARIO GENERICO 2
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'USUARIO GENERICO 3')">
                            <span class="icon">üë§</span>
                            USUARIO GENERICO 3
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'AUDITOR GENERICO 1')">
                            <span class="icon">üë§</span>
                            AUDITOR GENERICO 1
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'AUDITOR GENERICO 2')">
                            <span class="icon">üë§</span>
                            AUDITOR GENERICO 2
                        </div>
                        <div class="user-option" onclick="selectUser(this, 'AUDITOR GENERICO 3')">
                            <span class="icon">üë§</span>
                            AUDITOR GENERICO 3
                        </div>
                    </div>
                </div>

                <button class="btn-primary" onclick="enterAsCapturista()">
                    Continuar ‚Üí
                </button>
            </div>
        </div>

        <!-- ========== LOGIN AUDITOR√çA DE CONTEO ========== -->
        <div id="screen-auditoria-conteo-login" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="showScreen('login')">‚Üê</button>
                <h1>Auditor√≠a de Conteo</h1>
            </div>

            <div class="content-white">
                <div class="user-selection">
                    <h3>Selecciona tu nombre</h3>
                    
                    <input type="text" id="search-auditor" placeholder="üîç Buscar auditor..." 
                           onkeyup="filtrarAuditores()" 
                           style="width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                    
                    <div class="user-list" id="auditor-list">
                        <div class="user-option" onclick="selectAuditor(this, 'BLANCA ALICIA AVALOS ROMO')">
                            <span class="icon">üîç</span>
                            BLANCA ALICIA AVALOS ROMO
                        </div>
                        <div class="user-option" onclick="selectAuditor(this, 'EDSON ALEJANDRO ENCINIA HERNANDEZ')">
                            <span class="icon">üîç</span>
                            EDSON ALEJANDRO ENCINIA HERNANDEZ
                        </div>
                        <div class="user-option" onclick="selectAuditor(this, 'ENRIQUE CORTEZ RIOS')">
                            <span class="icon">üîç</span>
                            ENRIQUE CORTEZ RIOS
                        </div>
                        <div class="user-option" onclick="selectAuditor(this, 'ENRIQUE FERNANDO GARCIA MORENO')">
                            <span class="icon">üîç</span>
                            ENRIQUE FERNANDO GARCIA MORENO
                        </div>
                        <div class="user-option" onclick="selectAuditor(this, 'ERICK ORLANDO CORTEZ GONZALEZ')">
                            <span class="icon">üîç</span>
                            ERICK ORLANDO CORTEZ GONZALEZ
                        </div>
                        <div class="user-option" onclick="selectAuditor(this, 'HIRAM ENRIQUE CORTEZ GARZA')">
                            <span class="icon">üîç</span>
                            HIRAM ENRIQUE CORTEZ GARZA
                        </div>
                        <div class="user-option" onclick="selectAuditor(this, 'LOLIS PEREZ SIMANCAS')">
                            <span class="icon">üîç</span>
                            LOLIS PEREZ SIMANCAS
                        </div>
                        <div class="user-option" onclick="selectAuditor(this, 'YARELLI GUADALUPE HERNANDEZ GARCIA')">
                            <span class="icon">üîç</span>
                            YARELLI GUADALUPE HERNANDEZ GARCIA
                        </div>
                        <div class="user-option" onclick="selectAuditor(this, 'DANIEL OMAR ARENAS SOLORIO')">
                            <span class="icon">üîç</span>
                            DANIEL OMAR ARENAS SOLORIO
                        </div>
                        <div class="user-option" onclick="selectAuditor(this, 'JOSE NAPOLEON PEREZ')">
                            <span class="icon">üîç</span>
                            JOSE NAPOLEON PEREZ
                        </div>
                        <div class="user-option" onclick="selectAuditor(this, 'MARIO (CALIDAD)')">
                            <span class="icon">üîç</span>
                            MARIO (CALIDAD)
                        </div>
                        <div class="user-option" onclick="selectAuditor(this, 'AUDITOR GENERICO 1')">
                            <span class="icon">üîç</span>
                            AUDITOR GENERICO 1
                        </div>
                        <div class="user-option" onclick="selectAuditor(this, 'AUDITOR GENERICO 2')">
                            <span class="icon">üîç</span>
                            AUDITOR GENERICO 2
                        </div>
                        <div class="user-option" onclick="selectAuditor(this, 'AUDITOR GENERICO 3')">
                            <span class="icon">üîç</span>
                            AUDITOR GENERICO 3
                        </div>
                    </div>
                </div>

                <button class="btn-primary" onclick="enterAsAuditorConteo()">
                    Continuar ‚Üí
                </button>
            </div>
        </div>

        <!-- ========== MEN√ö AUDITOR√çA DE CONTEO ========== -->
        <div id="screen-menu-auditoria-conteo" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="showScreen('login')">‚Üê</button>
                <h1 id="auditor-name">Auditor√≠a de Conteo</h1>
            </div>

            <div class="content-white">
                <h3 style="padding: 0 16px; margin-bottom: 16px;">Mis SAPs Asignados</h3>
                <div id="mis-saps-asignados" style="padding: 0 16px;"></div>
            </div>
        </div>

        <!-- ========== VALIDAR SAP ========== -->
        <div id="screen-validar-sap" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="showScreen('menu-auditoria-conteo')">‚Üê</button>
                <h1 id="validar-sap-titulo">Validar SAP</h1>
            </div>

            <div class="content-white" style="padding: 20px;">
                <div id="info-sap-validar"></div>
                <div id="folios-sap-validar" style="margin-top: 24px;"></div>
            </div>
        </div>

        <!-- ========== VALIDAR FOLIO ========== -->
        <div id="screen-validar-folio" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="volverValidarSAP()">‚Üê</button>
                <h1>Validar Folio</h1>
            </div>

            <div class="content-white" style="padding: 20px;">
                <div id="form-validacion-folio"></div>
            </div>
        </div>

        <!-- ========== MEN√ö CAPTURISTA ========== -->
        <div id="screen-menu-capturista" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="showScreen('login')">‚Üê</button>
                <h1 id="capturista-name">Capturista</h1>
            </div>

            <div class="content-white">
                <div class="menu-grid">
                    <div class="menu-card" onclick="showScreen('capture')">
                        <div class="icon-box blue">üì±</div>
                        <div class="text">
                            <h3>Capturar</h3>
                            <p>Escanear o captura manual</p>
                        </div>
                        <span class="arrow">‚Ä∫</span>
                    </div>

                    <div class="menu-card" onclick="showScreen('mis-registros')">
                        <div class="icon-box green">üìù</div>
                        <div class="text">
                            <h3>Mis Registros</h3>
                            <p>Ver y editar mis capturas</p>
                        </div>
                        <span class="arrow">‚Ä∫</span>
                    </div>

                    <div class="menu-card" onclick="showScreen('dashboard')">
                        <div class="icon-box purple">üìä</div>
                        <div class="text">
                            <h3>Dashboard</h3>
                            <p>Ver avance general</p>
                        </div>
                        <span class="arrow">‚Ä∫</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== PANTALLA CAPTURA ========== -->
        <div id="screen-capture" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="showScreen('menu-capturista')">‚Üê</button>
                <h1>Captura</h1>
            </div>

            <div class="tabs-container">
                <button class="tab-btn active" onclick="switchTab('escanear')">
                    üì± Escanear QR
                </button>
                <button class="tab-btn" onclick="switchTab('qr-sap')">
                    üîß QR SAP (Taller)
                </button>
                <button class="tab-btn" onclick="switchTab('manual')">
                    ‚úèÔ∏è Manual
                </button>
            </div>

            <!-- Tab Escanear -->
            <div id="tab-escanear" class="scan-area">
                <div class="scan-box" id="scan-button" onclick="startScanning()">
                    <div class="scan-icon">üì±</div>
                    <h3>Escanear C√≥digo QR</h3>
                    <p>Toca aqu√≠ para activar c√°mara</p>
                </div>

                <!-- QR Reader -->
                <div id="qr-reader" style="display: none;"></div>

                <!-- Formulario prellenado -->
                <div id="scan-form-container" style="display: none;">
                    <div class="scan-form">
                        <h4>Datos del Marbete</h4>
                        
                        <div class="input-group">
                            <label>Folio *</label>
                            <input type="text" id="form-folio" readonly style="background: #f5f5f5; border: 2px solid #e0e0e0; padding: 12px; border-radius: 8px; font-size: 14px; width: 100%; box-sizing: border-box;">
                        </div>
                        
                        <div class="input-group">
                            <label>Almac√©n *</label>
                            <select id="form-almacen-select">
                                <option value="00">00 - L√≠neas Producci√≥n</option>
                                <option value="01">01 - Materia Prima</option>
                                <option value="01-MAQUILA">MAQUILA (√Årea 01)</option>
                                <option value="30">30 - Transformadores</option>
                                <option value="31">31 - Placas</option>
                                <option value="32">32 - Arneses</option>
                                <option value="33">33 - Gabinetes</option>
                            </select>
                        </div>
                        
                        <div class="field-readonly">
                            <label>C√≥digo SAP</label>
                            <div class="value" id="form-sap">-</div>
                        </div>
                        
                        <div class="field-readonly">
                            <label>Descripci√≥n</label>
                            <div class="value" id="form-desc">-</div>
                        </div>

                        <div class="input-group">
                            <label>Cantidad *</label>
                            <input type="number" id="form-cantidad" placeholder="Ingresa cantidad" step="0.01">
                        </div>

                        <div class="input-group">
                            <label>Ubicaci√≥n (Opcional)</label>
                            <input type="text" id="form-ubicacion" placeholder="Ej: Rack A-5">
                        </div>

                        <div class="input-group">
                            <label>¬øQui√©n cont√≥? *</label>
                            <input type="text" id="form-contador" placeholder="Ej: Juan P√©rez">
                        </div>

                        <div class="two-cols">
                            <button class="btn-secondary" onclick="cancelarFormulario()">Cancelar</button>
                            <button id="btn-guardar-qr" class="btn-success" onclick="guardarQRDirecto()">‚úì Guardar Registro</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab QR SAP (Taller - Solo Almac√©n 33) -->
            <div id="tab-qr-sap" class="scan-area" style="display: none;">
                <div style="background: #fff3e0; border-radius: 12px; padding: 16px; margin: 16px; border-left: 4px solid #ff9800;">
                    <h3 style="color: #e65100; margin: 0 0 8px 0;">üîß MODO TALLER (Almac√©n 33)</h3>
                    <p style="font-size: 13px; color: #424242; margin: 0;">Escanea c√≥digo SAP del rack, llena el formulario y guarda directamente.</p>
                </div>
                
                <!-- FORMULARIO TALLER -->
                <div style="background: white; border-radius: 12px; padding: 20px; margin: 16px; border: 2px solid #e0e0e0;">
                    
                    <!-- Folio -->
                    <div class="input-group" style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1a237e;">Folio del Marbete *</label>
                        <input type="text" id="taller-folio" placeholder="Ej: G-001" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                    
                    <!-- Almac√©n (FIJO) -->
                    <div class="input-group" style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1a237e;">Almac√©n</label>
                        <select id="taller-almacen" disabled style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: #f5f5f5; box-sizing: border-box;">
                            <option value="33" selected>33 - Gabinetes (Taller)</option>
                        </select>
                    </div>
                    
                    <!-- C√≥digo SAP con bot√≥n de c√°mara -->
                    <div class="input-group" style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1a237e;">C√≥digo SAP *</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="taller-sap" placeholder="Ej: 263234" readonly style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: #f5f5f5; box-sizing: border-box;">
                            <button id="btn-escanear-sap-taller" onclick="activarCamaraTaller()" style="padding: 12px 20px; background: #1976d2; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                üì∑ Escanear
                            </button>
                        </div>
                        <div id="qr-reader-taller" style="margin-top: 12px; display: none; border-radius: 8px; overflow: hidden;"></div>
                    </div>
                    
                    <!-- Descripci√≥n (auto-llenada) -->
                    <div class="input-group" style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1a237e;">Descripci√≥n</label>
                        <div id="taller-desc" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: #f9f9f9; color: #666; min-height: 44px;">
                            Escanea el c√≥digo SAP para ver la descripci√≥n
                        </div>
                    </div>
                    
                    <!-- Cantidad -->
                    <div class="input-group" style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1a237e;">Cantidad *</label>
                        <input type="number" id="taller-cantidad" placeholder="Ej: 10" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                    
                    <!-- Unidad de Medida (auto-llenada) -->
                    <div class="input-group" style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1a237e;">Unidad</label>
                        <input type="text" id="taller-unidad" readonly value="PZA" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: #f5f5f5; box-sizing: border-box;">
                    </div>
                    
                    <!-- Ubicaci√≥n -->
                    <div class="input-group" style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1a237e;">Ubicaci√≥n *</label>
                        <input type="text" id="taller-ubicacion" placeholder="Ej: Rack A-5" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                    
                    <!-- Qui√©n cont√≥ -->
                    <div class="input-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1a237e;">¬øQui√©n cont√≥? *</label>
                        <input type="text" id="taller-contador" placeholder="Ej: Juan P√©rez" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                    
                    <!-- Bot√≥n Guardar Directo -->
                    <button id="btn-guardar-taller" onclick="guardarRegistroTaller()" style="width: 100%; padding: 16px; background: #4caf50; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer;">
                        ‚úì Guardar Registro
                    </button>
                </div>
            </div>

            <!-- Tab Manual -->
            <div id="tab-manual" class="form-manual" style="display: none;">
                <div class="input-group">
                    <label>Folio *</label>
                    <input type="text" id="manual-folio" placeholder="Ej: F7">
                </div>

                <div class="input-group">
                    <label>Almac√©n *</label>
                    <select id="manual-almacen">
                        <option value="00">00 - L√≠neas Producci√≥n</option>
                        <option value="01">01 - Materia Prima</option>
                        <option value="01-MAQUILA">MAQUILA (√Årea 01)</option>
                        <option value="30">30 - Transformadores</option>
                        <option value="31">31 - Placas</option>
                        <option value="32">32 - Arneses</option>
                        <option value="33">33 - Gabinetes</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>C√≥digo SAP *</label>
                    <input type="text" id="manual-sap" placeholder="Ej: 2002398" onblur="autocompletarDescripcion()">
                </div>
                
                <div class="input-group">
                    <label>Descripci√≥n</label>
                    <input type="text" id="manual-descripcion" placeholder="Se completa autom√°ticamente" readonly style="background: #f5f5f5;">
                </div>

                <div class="two-cols">
                    <div class="input-group">
                        <label>Cantidad *</label>
                        <input type="number" id="manual-cantidad" placeholder="0.00" step="0.01">
                    </div>

                    <div class="input-group">
                        <label>Ubicaci√≥n</label>
                        <input type="text" id="manual-ubicacion" placeholder="Rack">
                    </div>
                </div>

                <div class="input-group">
                    <label>¬øQui√©n cont√≥? *</label>
                    <input type="text" id="manual-contador" placeholder="Ej: Juan P√©rez">
                </div>

                <button id="btn-guardar-manual" class="btn-primary" onclick="guardarManualDirecto()" style="margin-top: 8px;">
                    ‚úì Guardar Registro
                </button>
            </div>
        </div>

        <!-- ========== MIS REGISTROS (CAPTURISTA) ========== -->
        <div id="screen-mis-registros" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="showScreen('menu-capturista')">‚Üê</button>
                <h1>Mis Registros</h1>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="search-mis-registros" placeholder="Buscar por folio o SAP...">
                    <button onclick="filtrarMisRegistros()">üîç</button>
                </div>

                <!-- PESTA√ëAS: Activos | Editados -->
                <div class="filter-chips">
                    <div class="filter-chip active" onclick="filtrarMisRegistrosPorTipo('activos')">
                        üü¢ Activos
                    </div>
                    <div class="filter-chip" onclick="filtrarMisRegistrosPorTipo('editados')">
                        üü° Editados
                    </div>
                </div>
            </div>

            <div class="results-count" id="count-mis-registros">0 registros encontrados</div>

            <div style="background: #f5f5f5; min-height: calc(100vh - 180px); padding: 8px 0;" id="container-mis-registros">
                <div style="text-align: center; padding: 40px; color: #9e9e9e;">No hay registros a√∫n</div>
            </div>
        </div>

        <!-- ========== DASHBOARD ========== -->
        <div id="screen-dashboard" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="showScreen('login')">‚Üê</button>
                <h1>Dashboard</h1>
                <button class="btn-back" onclick="actualizarDashboard()">üîÑ</button>
            </div>

            <div style="background: #f5f5f5; min-height: calc(100vh - 60px); padding-bottom: 20px;">
                <div class="progress-card">
                    <div style="text-align: center; margin-bottom: 14px;">
                        <span id="dash-total" style="font-size: 38px; font-weight: 800; color: #1a237e;">0</span>
                        <span style="font-size: 18px; color: #9e9e9e;"> / <span id="dash-esperado">0</span></span>
                    </div>
                    <div class="progress-bar" style="height: 12px; margin-bottom: 8px;">
                        <div id="dash-progress-bar" class="progress-fill" style="width: 0%;"></div>
                    </div>
                    <p id="dash-porcentaje" style="text-align: center; color: #1a237e; font-weight: 600; font-size: 14px;">0% completado</p>
                </div>

                <div class="stats-row">
                    <div class="stat-card">
                        <div class="icon">‚ö†Ô∏è</div>
                        <div id="dash-positivos" class="value" style="color: #f57c00;">0</div>
                        <div class="label">Positivos</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">üìà</div>
                        <div id="dash-velocidad" class="value" style="color: #1976d2;">~0</div>
                        <div class="label">escaneos/hora</div>
                    </div>
                </div>

                <div class="almacen-card">
                    <h3>üì¶ Avance por Almac√©n</h3>
                    <div id="almacenes-dashboard"></div>
                </div>

                <div class="almacen-card">
                    <h3>üë• Top Usuarios</h3>
                    <div id="top-usuarios-dashboard"></div>
                </div>

                <!-- Botones de acci√≥n -->
                <div style="padding: 0 20px 20px;">
                    <button class="btn-primary" onclick="verComparativo()" style="margin-bottom: 12px;">
                        üìä Ver Comparativo SAP vs F√≠sico
                    </button>
                    <button class="btn-secondary" onclick="verPositivos()">
                        ‚ùì Ver C√≥digos Positivos
                    </button>
                </div>
            </div>
        </div>

        <!-- ========== BUSCADOR SAP ========== -->
        <div id="screen-buscador-sap" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="showScreen('mesa')">‚Üê</button>
                <h1>üîç Buscador SAP</h1>
            </div>

            <div style="background: white; padding: 20px;">
                <div class="input-group" style="margin-bottom: 24px;">
                    <label style="font-size: 14px; font-weight: 700; color: #1a237e; margin-bottom: 8px;">Buscar SAP:</label>
                    <input type="text" id="input-buscar-sap" placeholder="Ej: 2002398" style="width: 100%; padding: 14px; border: 2px solid #90caf9; border-radius: 8px; font-size: 16px;" onkeyup="if(event.key==='Enter') buscarSAP()">
                    <button class="btn-primary" onclick="buscarSAP()" style="margin-top: 12px; width: 100%;">
                        üîç Buscar
                    </button>
                </div>

                <div id="resultado-buscador-sap"></div>
            </div>
        </div>

        <!-- ========== MEN√ö MESA DE CONTROL ========== -->
        <div id="screen-mesa" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="showScreen('login')">‚Üê</button>
                <h1>Mesa de Control</h1>
            </div>

            <!-- Panel de Control de Fases -->
            <div style="background: white; border-radius: 16px; padding: 20px; margin: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 2px solid #e3f2fd;">
                <h2 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 700; color: #1a237e;">üìä Control de Fases del Inventario</h2>
                
                <!-- Selector de Almac√©n -->
                <div style="margin-bottom: 16px;">
                    <label style="font-size: 13px; color: #757575; margin-bottom: 4px; display: block;">Ver almac√©n:</label>
                    <select id="select-almacen-fases" onchange="actualizarPanelPorAlmacen()" style="width: 100%; padding: 10px; border: 2px solid #90caf9; border-radius: 8px; font-size: 14px; color: #1a237e; font-weight: 600;">
                        <option value="01">01 - Materia Prima</option>
                        <option value="01-MAQUILA">MAQUILA (√Årea 01)</option>
                        <option value="30">30 - Transformadores</option>
                        <option value="31">31 - Placas</option>
                        <option value="32">32 - Arneses</option>
                        <option value="33">33 - Gabinetes</option>
                    </select>
                </div>
                
                <!-- Fase 1: Captura -->
                <div style="background: #f5f5f5; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 2px solid #e0e0e0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <span style="font-size: 20px;">üì±</span>
                            <strong style="margin-left: 8px; color: #1a237e;">FASE 1: Captura</strong>
                        </div>
                        <span id="status-fase1-alm" style="background: #c8e6c9; color: #2e7d32; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700;">ACTIVA</span>
                    </div>
                    <div style="font-size: 13px; color: #424242; margin-bottom: 12px;">
                        Capturados: <strong id="count-captura-alm" style="color: #1a237e;">0</strong> registros
                    </div>
                    <button id="btn-bloquear-alm" class="btn-secondary" onclick="toggleBloqueoAlmacen()" style="width: 100%; background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; font-size: 13px;">
                        üîí Bloquear Captura de Este Almac√©n
                    </button>
                </div>
                
                <!-- Fase 2: Duplicados -->
                <div style="background: #f5f5f5; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 2px solid #e0e0e0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <span style="font-size: 20px;">‚ö†Ô∏è</span>
                            <strong style="margin-left: 8px; color: #1a237e;">FASE 2: Resolver Duplicados</strong>
                        </div>
                        <span id="status-fase2-alm" style="background: #fff9c4; color: #f57f17; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700;">PENDIENTE</span>
                    </div>
                    <div style="font-size: 13px; color: #424242; margin-bottom: 12px;">
                        Duplicados: <strong id="count-dup-alm" style="color: #1a237e;">0</strong> pendientes
                    </div>
                    <button class="btn-secondary" onclick="abrirDuplicadosPorAlmacen()" style="width: 100%; background: #fff3e0; color: #e65100; border: 1px solid #ffb74d; font-size: 13px;">
                        ‚ö†Ô∏è Resolver Duplicados de Este Almac√©n
                    </button>
                </div>
                
                <!-- Fase 3: Auditor√≠a -->
                <div style="background: #f5f5f5; border-radius: 12px; padding: 16px; border: 2px solid #e0e0e0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <span style="font-size: 20px;">üîç</span>
                            <strong style="margin-left: 8px; color: #1a237e;">FASE 3: Auditor√≠a de Conteo</strong>
                        </div>
                        <span id="status-fase3-alm" style="background: #fff9c4; color: #f57f17; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700;">ASIGNADA</span>
                    </div>
                    <div style="font-size: 13px; color: #424242; margin-bottom: 12px;">
                        SAPs asignados: <strong id="count-saps-alm" style="color: #1a237e;">0</strong><br>
                        <span id="info-liberacion-alm" style="font-size: 12px; color: #757575;">Visibilidad bloqueada hasta resolver duplicados</span>
                    </div>
                    <button class="btn-secondary" onclick="abrirAsignarPorAlmacen()" style="width: 100%; background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; font-size: 13px; margin-bottom: 8px;">
                        üîç Asignar SAPs a Auditar
                    </button>
                    <button id="btn-liberar-alm" class="btn-primary" onclick="liberarAuditoriaPorAlmacen()" style="width: 100%; background: #bdbdbd; color: white; opacity: 0.6; cursor: not-allowed; font-size: 13px; font-weight: 700; margin-bottom: 12px;" disabled>
                        üîì Liberar Visibilidad para Auditores
                    </button>
                    
                    <!-- PROGRESO INTEGRADO -->
                    <div id="progreso-auditoria-alm" style="display: none; background: white; border-radius: 8px; padding: 12px; margin-top: 12px; border: 2px solid #4caf50;">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </div>

            <div class="content-white">
                <div class="menu-grid">
                    <div class="menu-card" onclick="showScreen('registros', 'mesa')">
                        <div class="icon-box blue">üìã</div>
                        <div class="text">
                            <h3>Todos los Registros</h3>
                            <p>Ver y editar cualquier registro</p>
                        </div>
                        <span class="arrow">‚Ä∫</span>
                    </div>

                    <div class="menu-card" onclick="abrirPositivos()">
                        <div class="icon-box purple">‚ùì</div>
                        <div class="text">
                            <h3>Positivos</h3>
                            <p>C√≥digos no encontrados en SAP</p>
                        </div>
                        <span class="arrow">‚Ä∫</span>
                    </div>

                    <div class="menu-card" onclick="abrirComparativo()">
                        <div class="icon-box blue">üìä</div>
                        <div class="text">
                            <h3>Comparativo</h3>
                            <p>SAP vs Inventario F√≠sico</p>
                        </div>
                        <span class="arrow">‚Ä∫</span>
                    </div>

                    <div class="menu-card" onclick="abrirHistorial('mesa')">
                        <div class="icon-box gray">üìú</div>
                        <div class="text">
                            <h3>Historial de Cambios</h3>
                            <p>Auditor√≠a de modificaciones</p>
                        </div>
                        <span class="arrow">‚Ä∫</span>
                    </div>

                    <div class="menu-card" onclick="showScreen('dashboard')">
                        <div class="icon-box green">üìä</div>
                        <div class="text">
                            <h3>Dashboard</h3>
                            <p>Avance en tiempo real</p>
                        </div>
                        <span class="arrow">‚Ä∫</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== ASIGNAR SAPS A AUDITAR ========== -->
        <div id="screen-asignar-saps" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="showScreen('mesa')">‚Üê</button>
                <h1>Asignar SAPs a Auditar</h1>
            </div>

            <div class="content-white" style="padding: 20px;">
                <div class="input-group" style="margin-bottom: 16px;">
                    <label><strong>1. Selecciona el Almac√©n</strong></label>
                    <select id="almacen-auditoria" onchange="mostrarAuditoresAlmacen()" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                        <option value="">-- Selecciona Almac√©n --</option>
                        <option value="01">01 - MP + MAQUILA</option>
                        <option value="30">30 - Transformadores</option>
                        <option value="31">31 - Placas</option>
                        <option value="32">32 - Arneses</option>
                        <option value="33">33 - Gabinetes</option>
                    </select>
                </div>

                <div id="info-auditores-almacen" style="background: #e3f2fd; border-radius: 8px; padding: 12px; margin-bottom: 16px; display: none;">
                    <h4 style="color: #1565c0; margin-bottom: 8px;">üë• Auditores asignados a este almac√©n:</h4>
                    <div id="lista-auditores-almacen" style="font-size: 13px; color: #424242;"></div>
                </div>
                
                <h3 style="margin-bottom: 8px;"><strong>2. Ingresa SAPs a auditar</strong></h3>
                <p style="font-size: 13px; color: #757575; margin-bottom: 12px;">Un SAP por l√≠nea</p>
                <textarea id="saps-input" rows="10" placeholder="Ej:
2002398
2000187
2001234" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 14px;"></textarea>
                
                <button class="btn-primary" onclick="asignarSAPsAuditores()" style="margin-top: 16px; width: 100%;">
                    Asignar a Auditores del Almac√©n
                </button>

                <div id="resumen-asignacion" style="margin-top: 24px;"></div>
                
                <div style="margin-top: 24px;">
                    <h3>SAPs Actualmente Asignados</h3>
                    <div id="lista-saps-asignados" style="margin-top: 12px;"></div>
                </div>
            </div>
        </div>

        <!-- ========== TODOS LOS REGISTROS ========== -->
        <div id="screen-registros" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="regresarDeRegistros()">‚Üê</button>
                <h1>Todos los Registros</h1>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="search-registros" placeholder="Buscar por folio o SAP..." onkeyup="buscarRegistros()">
                    <button onclick="buscarRegistros()">üîç</button>
                </div>

                <div class="filter-chips">
                    <div class="filter-chip active" onclick="toggleFilter(this, 'todos')">Todos</div>
                    <div class="filter-chip" onclick="toggleFilter(this, 'duplicados')">‚ö†Ô∏è Duplicados</div>
                    <div class="filter-chip" onclick="toggleFilter(this, 'almacen')">üì¶ Almac√©n</div>
                    <div class="filter-chip" onclick="toggleFilter(this, 'usuario')">üë§ Usuario</div>
                </div>

                <div id="filter-almacen" class="filter-dropdown">
                    <div class="filter-option selected" onclick="selectAlmacen('todos')">Todos los almacenes</div>
                    <div class="filter-option" onclick="selectAlmacen('00')">00 - L√≠neas Producci√≥n</div>
                    <div class="filter-option" onclick="selectAlmacen('01')">01 - Materia Prima</div>
                    <div class="filter-option" onclick="selectAlmacen('30')">30 - Transformadores</div>
                    <div class="filter-option" onclick="selectAlmacen('31')">31 - Placas</div>
                    <div class="filter-option" onclick="selectAlmacen('32')">32 - Arneses</div>
                    <div class="filter-option" onclick="selectAlmacen('33')">33 - Gabinetes</div>
                </div>

                <div id="filter-usuario" class="filter-dropdown">
                    <div class="filter-option selected" onclick="selectUsuario('todos')">Todos los usuarios</div>
                    <div class="filter-option" onclick="selectUsuario('Sandra Antonio')">Sandra Antonio</div>
                    <div class="filter-option" onclick="selectUsuario('Jahyr Castro')">Jahyr Castro</div>
                    <div class="filter-option" onclick="selectUsuario('Angie Mart√≠nez')">Angie Mart√≠nez</div>
                    <div class="filter-option" onclick="selectUsuario('Ingrid Gonz√°lez')">Ingrid Gonz√°lez</div>
                    <div class="filter-option" onclick="selectUsuario('Edson Encinia')">Edson Encinia</div>
                    <div class="filter-option" onclick="selectUsuario('Enrique Garc√≠a')">Enrique Garc√≠a</div>
                </div>
            </div>

            <div class="results-count" id="count-registros">0 registros encontrados</div>

            <div style="background: #f5f5f5; min-height: calc(100vh - 200px); padding: 8px 0;" id="container-todos-registros">
                <div style="text-align: center; padding: 40px; color: #9e9e9e;">No hay registros a√∫n</div>
            </div>
        </div>

        <!-- ========== DUPLICADOS - RESOLUCI√ìN ========== -->
        <div id="screen-duplicados" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="volverAMesa()">‚Üê</button>
                <h1 id="titulo-duplicados">Duplicados</h1>
            </div>

            <div style="background: #fff3cd; padding: 16px; border-bottom: 2px solid #ffc107;">
                <div style="font-size: 13px; color: #856404;">
                    ‚ö†Ô∏è <strong>Pendientes:</strong> <span id="count-dup-header">0</span> duplicados por resolver
                </div>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="search-duplicados" placeholder="Buscar por folio o SAP..." onkeyup="buscarDuplicados()">
                    <button onclick="buscarDuplicados()">üîç</button>
                </div>

                <div class="filter-chips">
                    <div class="filter-chip active" onclick="toggleFilterDuplicados(this, 'todos')">Todos</div>
                    <div class="filter-chip" onclick="toggleFilterDuplicados(this, 'almacen')">üì¶ Almac√©n</div>
                    <div class="filter-chip" onclick="toggleFilterDuplicados(this, 'resueltos')">‚úÖ Ver Resueltos</div>
                </div>

                <div id="filter-almacen-dup" class="filter-dropdown">
                    <div class="filter-option selected" onclick="selectAlmacenDup('todos')">Todos los almacenes</div>
                    <div class="filter-option" onclick="selectAlmacenDup('01')">01 - Resto MP</div>
                    <div class="filter-option" onclick="selectAlmacenDup('30')">30 - Transformadores</div>
                    <div class="filter-option" onclick="selectAlmacenDup('31')">31 - Placas</div>
                    <div class="filter-option" onclick="selectAlmacenDup('32')">32 - Arneses</div>
                    <div class="filter-option" onclick="selectAlmacenDup('33')">33 - Gabinetes</div>
                    <div class="filter-option" onclick="selectAlmacenDup('MAQUILA')">MAQUILA</div>
                </div>
            </div>

            <div class="results-count" id="count-duplicados">0 duplicados encontrados</div>

            <div style="background: #f5f5f5; min-height: calc(100vh - 200px); padding: 8px 0;" id="container-duplicados">
                <div style="text-align: center; padding: 40px; color: #9e9e9e;">Cargando...</div>
            </div>
        </div>

        <!-- ========== POSITIVOS - SOLO VISUALIZACI√ìN ========== -->
        <div id="screen-positivos-vista" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="volverAMesa()">‚Üê</button>
                <h1>Positivos (Referencia)</h1>
            </div>

            <div style="background: #f3e5f5; padding: 16px; border-bottom: 2px solid #9c27b0;">
                <div style="font-size: 13px; color: #4a148c;">
                    ‚ÑπÔ∏è Solo para referencia. Los positivos se mantienen en el inventario.
                </div>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="search-positivos" placeholder="Buscar por SAP..." onkeyup="buscarPositivos()">
                    <button onclick="buscarPositivos()">üîç</button>
                </div>

                <div class="filter-chips">
                    <div class="filter-chip active" onclick="toggleFilterPositivos(this, 'todos')">Todos</div>
                    <div class="filter-chip" onclick="toggleFilterPositivos(this, 'almacen')">üì¶ Almac√©n</div>
                </div>

                <div id="filter-almacen-pos" class="filter-dropdown">
                    <div class="filter-option selected" onclick="selectAlmacenPos('todos')">Todos los almacenes</div>
                    <div class="filter-option" onclick="selectAlmacenPos('01')">01 - Resto MP</div>
                    <div class="filter-option" onclick="selectAlmacenPos('30')">30 - Transformadores</div>
                    <div class="filter-option" onclick="selectAlmacenPos('31')">31 - Placas</div>
                    <div class="filter-option" onclick="selectAlmacenPos('32')">32 - Arneses</div>
                    <div class="filter-option" onclick="selectAlmacenPos('33')">33 - Gabinetes</div>
                    <div class="filter-option" onclick="selectAlmacenPos('MAQUILA')">MAQUILA</div>
                </div>
            </div>

            <div class="results-count" id="count-positivos">0 positivos encontrados</div>

            <div style="background: #f5f5f5; min-height: calc(100vh - 200px); padding: 8px 0;" id="container-positivos">
                <div style="text-align: center; padding: 40px; color: #9e9e9e;">Cargando...</div>
            </div>
        </div>

        <!-- ========== COMPARATIVO SAP VS F√çSICO ========== -->
        <div id="screen-comparativo-vista" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="showScreen('mesa')">‚Üê</button>
                <h1>Comparativo SAP vs F√≠sico</h1>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="search-comparativo" placeholder="Buscar por SAP..." onkeyup="buscarComparativo()">
                    <button onclick="buscarComparativo()">üîç</button>
                </div>

                <div class="filter-chips">
                    <div class="filter-chip active" onclick="toggleFilterComparativo(this, 'todos')">Top 10</div>
                    <div class="filter-chip" onclick="toggleFilterComparativo(this, 'almacen')">üì¶ Almac√©n</div>
                    <div class="filter-chip" onclick="toggleFilterComparativo(this, 'ordenar')">üìä Ordenar</div>
                </div>

                <div id="filter-almacen-comp" class="filter-dropdown">
                    <div class="filter-option selected" onclick="selectAlmacenComp('todos')">Todos los almacenes</div>
                    <div class="filter-option" onclick="selectAlmacenComp('00')">00 - L√≠neas Producci√≥n</div>
                    <div class="filter-option" onclick="selectAlmacenComp('01')">01 - Resto MP</div>
                    <div class="filter-option" onclick="selectAlmacenComp('30')">30 - Transformadores</div>
                    <div class="filter-option" onclick="selectAlmacenComp('31')">31 - Placas</div>
                    <div class="filter-option" onclick="selectAlmacenComp('32')">32 - Arneses</div>
                    <div class="filter-option" onclick="selectAlmacenComp('33')">33 - Gabinetes</div>
                    <div class="filter-option" onclick="selectAlmacenComp('MAQUILA')">MAQUILA</div>
                </div>

                <div id="filter-ordenar-comp" class="filter-dropdown">
                    <div class="filter-option selected" onclick="selectOrdenComp('costo')">Mayor Dif. en Costo</div>
                    <div class="filter-option" onclick="selectOrdenComp('cantidad')">Mayor Dif. en Cantidad</div>
                    <div class="filter-option" onclick="selectOrdenComp('porcentaje')">Mayor Dif. en %</div>
                </div>
            </div>

            <div style="padding: 12px 16px; background: #e3f2fd; border-bottom: 1px solid #90caf9;">
                <div style="font-size: 13px; color: #1565c0;">
                    <span id="stats-comp-total">0 art√≠culos</span> ‚Ä¢ 
                    <span id="stats-comp-dif">0 con diferencias</span>
                </div>
            </div>

            <div style="background: #f5f5f5; min-height: calc(100vh - 200px); padding: 8px 0;" id="container-comparativo">
                <div style="text-align: center; padding: 40px; color: #9e9e9e;">Cargando...</div>
            </div>

            <div style="padding: 16px; background: white; border-top: 2px solid #e0e0e0;">
                <button class="btn-primary" onclick="descargarComparativoSAP()" style="width: 100%;">
                    üì• Descargar Comparativo Completo
                </button>
            </div>
        </div>

        <!-- ========== HISTORIAL DE CAMBIOS ========== -->
        <div id="screen-historial" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="volverDesdeHistorial()">‚Üê</button>
                <h1>Historial de Cambios</h1>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="search-historial" placeholder="Buscar por folio o SAP..." onkeyup="buscarHistorial()">
                    <button onclick="buscarHistorial()">üîç</button>
                </div>

                <div class="filter-chips">
                    <div class="filter-chip active" onclick="toggleFilterHistorial(this, 'todos')">Todos</div>
                    <div class="filter-chip" onclick="toggleFilterHistorial(this, 'almacen')">üì¶ Almac√©n</div>
                    <div class="filter-chip" onclick="toggleFilterHistorial(this, 'usuario')">üë§ Usuario</div>
                    <div class="filter-chip" onclick="toggleFilterHistorial(this, 'accion')">‚öôÔ∏è Acci√≥n</div>
                </div>

                <div id="filter-almacen-hist" class="filter-dropdown">
                    <div class="filter-option selected" onclick="selectAlmacenHist('todos')">Todos los almacenes</div>
                    <div class="filter-option" onclick="selectAlmacenHist('00')">00 - L√≠neas Producci√≥n</div>
                    <div class="filter-option" onclick="selectAlmacenHist('01')">01 - Resto MP</div>
                    <div class="filter-option" onclick="selectAlmacenHist('30')">30 - Transformadores</div>
                    <div class="filter-option" onclick="selectAlmacenHist('31')">31 - Placas</div>
                    <div class="filter-option" onclick="selectAlmacenHist('32')">32 - Arneses</div>
                    <div class="filter-option" onclick="selectAlmacenHist('33')">33 - Gabinetes</div>
                    <div class="filter-option" onclick="selectAlmacenHist('MAQUILA')">MAQUILA</div>
                </div>

                <div id="filter-usuario-hist" class="filter-dropdown">
                    <div class="filter-option selected" onclick="selectUsuarioHist('todos')">Todos los usuarios</div>
                    <div id="usuarios-hist-list"></div>
                </div>

                <div id="filter-accion-hist" class="filter-dropdown">
                    <div class="filter-option selected" onclick="selectAccionHist('todos')">Todas las acciones</div>
                    <div class="filter-option" onclick="selectAccionHist('EDITADO')">‚úèÔ∏è Editados</div>
                    <div class="filter-option" onclick="selectAccionHist('ELIMINADO')">üóëÔ∏è Eliminados</div>
                </div>
            </div>

            <div class="results-count" id="count-historial">0 cambios encontrados</div>

            <div style="background: #f5f5f5; min-height: calc(100vh - 200px); padding: 8px 0;" id="container-historial">
                <div style="text-align: center; padding: 40px; color: #9e9e9e;">Cargando...</div>
            </div>
        </div>

        <!-- ========== MEN√ö AUDITOR√çA ========== -->
        <div id="screen-auditoria" class="screen">
            <div class="header-inner">
                <button class="btn-back" onclick="showScreen('login')">‚Üê</button>
                <h1>Auditor√≠a</h1>
            </div>

            <div class="content-white">
                <div style="padding: 0 16px;">
                    <!-- Upload Kardex -->
                    <div class="upload-area" onclick="document.getElementById('file-kardex').click()">
                        <div class="icon">üìä</div>
                        <h4>Kardex SAP</h4>
                        <p>Cargar archivo Excel con inventario te√≥rico</p>
                        <input type="file" id="file-kardex" accept=".xlsx,.xls" style="display: none;" onchange="handleFileUpload(this, 'kardex')">
                    </div>
                    <div id="preview-kardex" class="file-preview">
                        <div class="file-info">
                            <div class="file-icon">üìÑ</div>
                            <div class="file-name" id="name-kardex">-</div>
                            <button class="file-remove" onclick="removeFile('kardex')">‚úï</button>
                        </div>
                    </div>

                    <!-- Upload Base Descripciones -->
                    <div class="upload-area" onclick="document.getElementById('file-descripciones').click()">
                        <div class="icon">üìö</div>
                        <h4>Base de Descripciones</h4>
                        <p>Cargar cat√°logo completo de art√≠culos</p>
                        <input type="file" id="file-descripciones" accept=".xlsx,.xls" style="display: none;" onchange="handleFileUpload(this, 'descripciones')">
                    </div>
                    <div id="preview-descripciones" class="file-preview">
                        <div class="file-info">
                            <div class="file-icon">üìÑ</div>
                            <div class="file-name" id="name-descripciones">-</div>
                            <button class="file-remove" onclick="removeFile('descripciones')">‚úï</button>
                        </div>
                    </div>
                </div>

                <!-- Control de Almacenes -->
                <div style="padding: 0 16px; margin-top: 32px;">
                    <h3 style="color: #1a237e; font-size: 16px; font-weight: 700; margin-bottom: 16px;">
                        üîí Control de Almacenes
                    </h3>
                    <div style="background: white; border-radius: 12px; padding: 16px;">
                        <div class="almacen-control-item">
                            <span>üì¶ 00 - L√≠neas Producci√≥n</span>
                            <label class="switch">
                                <input type="checkbox" id="bloqueo-00" onchange="toggleBloqueoAlmacen('00')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="almacen-control-item">
                            <span>üì¶ 01 - Materia Prima</span>
                            <label class="switch">
                                <input type="checkbox" id="bloqueo-01" onchange="toggleBloqueoAlmacen('01')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="almacen-control-item">
                            <span>üì¶ 30 - Transformadores</span>
                            <label class="switch">
                                <input type="checkbox" id="bloqueo-30" onchange="toggleBloqueoAlmacen('30')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="almacen-control-item">
                            <span>üì¶ 31 - Placas</span>
                            <label class="switch">
                                <input type="checkbox" id="bloqueo-31" onchange="toggleBloqueoAlmacen('31')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="almacen-control-item">
                            <span>üì¶ 32 - Arneses</span>
                            <label class="switch">
                                <input type="checkbox" id="bloqueo-32" onchange="toggleBloqueoAlmacen('32')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="almacen-control-item">
                            <span>üì¶ 33 - Gabinetes</span>
                            <label class="switch">
                                <input type="checkbox" id="bloqueo-33" onchange="toggleBloqueoAlmacen('33')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <p style="color: #757575; font-size: 12px; margin-top: 12px;">
                            ON = Bloqueado (no permite nuevos registros) ‚Ä¢ OFF = Abierto
                        </p>
                    </div>
                </div>

                <!-- Segundo Conteo -->
                <div style="padding: 0 16px; margin-top: 32px;">
                    <h3 style="color: #1a237e; font-size: 16px; font-weight: 700; margin-bottom: 16px;">
                        üîÑ Segundo Conteo
                    </h3>
                    <div style="background: white; border-radius: 12px; padding: 16px;">
                        <div class="segundo-conteo-item">
                            <div>
                                <strong>üì¶ 00 - L√≠neas Producci√≥n</strong>
                                <p id="status-2do-00" style="font-size: 12px; color: #757575; margin-top: 4px;">
                                    ‚ùå No liberado
                                </p>
                            </div>
                            <button class="btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="liberarSegundoConteo('00')">
                                Liberar
                            </button>
                        </div>
                        <div class="segundo-conteo-item">
                            <div>
                                <strong>üì¶ 01 - Materia Prima</strong>
                                <p id="status-2do-01" style="font-size: 12px; color: #757575; margin-top: 4px;">
                                    ‚ùå No liberado
                                </p>
                            </div>
                            <button class="btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="liberarSegundoConteo('01')">
                                Liberar
                            </button>
                        </div>
                        <div class="segundo-conteo-item">
                            <div>
                                <strong>üì¶ 30 - Transformadores</strong>
                                <p id="status-2do-30" style="font-size: 12px; color: #757575; margin-top: 4px;">
                                    ‚ùå No liberado
                                </p>
                            </div>
                            <button class="btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="liberarSegundoConteo('30')">
                                Liberar
                            </button>
                        </div>
                        <div class="segundo-conteo-item">
                            <div>
                                <strong>üì¶ 31 - Placas</strong>
                                <p id="status-2do-31" style="font-size: 12px; color: #757575; margin-top: 4px;">
                                    ‚ùå No liberado
                                </p>
                            </div>
                            <button class="btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="liberarSegundoConteo('31')">
                                Liberar
                            </button>
                        </div>
                        <div class="segundo-conteo-item">
                            <div>
                                <strong>üì¶ 32 - Arneses</strong>
                                <p id="status-2do-32" style="font-size: 12px; color: #757575; margin-top: 4px;">
                                    ‚ùå No liberado
                                </p>
                            </div>
                            <button class="btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="liberarSegundoConteo('32')">
                                Liberar
                            </button>
                        </div>
                        <div class="segundo-conteo-item">
                            <div>
                                <strong>üì¶ 33 - Gabinetes</strong>
                                <p id="status-2do-33" style="font-size: 12px; color: #757575; margin-top: 4px;">
                                    ‚ùå No liberado
                                </p>
                            </div>
                            <button class="btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="liberarSegundoConteo('33')">
                                Liberar
                            </button>
                        </div>
                    </div>

                    <!-- Botones de descarga -->
                    <div style="display: flex; gap: 12px; margin-top: 16px;">
                        <button class="btn-primary" style="flex: 1;" onclick="descargarPrimerConteo()">
                            üì• Primer Conteo
                        </button>
                        <button class="btn-primary" style="flex: 1;" onclick="descargarSegundoConteo()">
                            üì• Segundo Conteo
                        </button>
                    </div>
                </div>

                <!-- Reportes Completos -->
                <div style="padding: 0 16px; margin-top: 32px;">
                    <h3 style="color: #1a237e; font-size: 16px; font-weight: 700; margin-bottom: 16px;">
                        üìä Reportes de An√°lisis
                    </h3>
                    <div style="background: white; border-radius: 12px; padding: 16px;">
                        <button class="btn-secondary" style="width: 100%; margin-bottom: 8px;" onclick="descargarDuplicados()">
                            ‚ö†Ô∏è Reporte de Duplicados
                        </button>
                        <button class="btn-secondary" style="width: 100%; margin-bottom: 8px;" onclick="descargarPositivos()">
                            ‚ùì Reporte de Positivos
                        </button>
                        <button class="btn-secondary" style="width: 100%; margin-bottom: 8px;" onclick="descargarComparativoSAP()">
                            üìä Comparativo SAP vs F√≠sico
                        </button>
                        <button class="btn-secondary" style="width: 100%; margin-bottom: 8px;" onclick="descargarAvancePorAlmacen()">
                            üì¶ Avance por Almac√©n
                        </button>
                        <button class="btn-secondary" style="width: 100%; margin-bottom: 8px;" onclick="descargarAuditoriasConteo()">
                            üîç Auditor√≠as de Conteo
                        </button>
                        <button class="btn-secondary" style="width: 100%; margin-bottom: 8px;" onclick="descargarDiferenciasSignificativas()">
                            üö® Diferencias Significativas
                        </button>
                        <button class="btn-secondary" style="width: 100%; margin-bottom: 8px;" onclick="descargarResumenAuditores()">
                            üë• Resumen por Auditor
                        </button>
                        <button class="btn-primary" style="width: 100%; font-weight: 700;" onclick="descargarDashboardEjecutivo()">
                            üìà Dashboard Ejecutivo (Todo en Uno)
                        </button>
                    </div>
                    
                    <!-- Bot√≥n RESETEAR TODO (Firebase + Sheets + Cach√©) -->
                    <div style="margin-top: 16px; border-top: 2px solid #ffebee; padding-top: 16px;">
                        <div style="background: #fff3e0; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <div style="font-size: 12px; color: #e65100; font-weight: 700; margin-bottom: 4px;">‚ö†Ô∏è ZONA DE LIMPIEZA</div>
                            <div style="font-size: 11px; color: #757575;">Usar solo al terminar pruebas, antes del inventario real</div>
                        </div>
                        <button class="btn-secondary" style="width: 100%; background: #d32f2f; color: white; font-weight: 700; font-size: 14px; padding: 16px;" onclick="resetearTodoElSistema()">
                            üóëÔ∏è RESETEAR TODO EL SISTEMA
                        </button>
                        <div style="font-size: 10px; color: #d32f2f; text-align: center; margin-top: 8px; font-weight: 600;">
                            Borra Firebase + Google Sheets + Cach√© Local
                        </div>
                    </div>
                </div>

                <div class="menu-grid" style="margin-top: 24px;">
                    <div class="menu-card" onclick="showScreen('registros', 'auditoria')">
                        <div class="icon-box blue">üìã</div>
                        <div class="text">
                            <h3>Todos los Registros</h3>
                            <p>Ver y editar cualquier registro</p>
                        </div>
                        <span class="arrow">‚Ä∫</span>
                    </div>

                    <div class="menu-card" onclick="verComparativo()">
                        <div class="icon-box orange">üìä</div>
                        <div class="text">
                            <h3>Comparativo</h3>
                            <p>SAP vs Inventario F√≠sico</p>
                        </div>
                        <span class="arrow">‚Ä∫</span>
                    </div>

                    <div class="menu-card" onclick="verPositivos()">
                        <div class="icon-box purple">‚ùì</div>
                        <div class="text">
                            <h3>Positivos</h3>
                            <p>C√≥digos no encontrados en SAP</p>
                        </div>
                        <span class="arrow">‚Ä∫</span>
                    </div>

                    <div class="menu-card" onclick="abrirHistorial('auditoria')">
                        <div class="icon-box gray">üìú</div>
                        <div class="text">
                            <h3>Historial</h3>
                            <p>Auditor√≠a de cambios</p>
                        </div>
                        <span class="arrow">‚Ä∫</span>
                    </div>

                    <div class="menu-card" onclick="showScreen('buscador-sap')">
                        <div class="icon-box green">üîç</div>
                        <div class="text">
                            <h3>Buscador SAP</h3>
                            <p>Consulta y comparativo vs Kardex</p>
                        </div>
                        <span class="arrow">‚Ä∫</span>
                    </div>

                    <div class="menu-card" onclick="showScreen('dashboard')">
                        <div class="icon-box purple">üìà</div>
                        <div class="text">
                            <h3>Dashboard</h3>
                            <p>M√©tricas y diferencias</p>
                        </div>
                        <span class="arrow">‚Ä∫</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SUCCESS OVERLAY ========== -->
        <div id="success-overlay" class="success-overlay">
            <div style="text-align: center;">
                <div class="success-icon">‚úì</div>
                <h2>¬°Guardado!</h2>
                <p>Marbetes registrados correctamente</p>
            </div>
        </div>

        <!-- ========== MODAL PASSWORD ========== -->
        <div id="modal-password" class="modal-overlay">
            <div class="modal-content">
                <h3 id="modal-title">Ingresa la clave</h3>
                <div class="input-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="modal-pass" placeholder="****">
                </div>
                <div class="two-cols" style="margin-top: 16px;">
                    <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button class="btn-primary" onclick="validatePassword()">Entrar</button>
                </div>
            </div>
        </div>

        <!-- ========== MODAL EDITAR REGISTRO ========== -->
        <div id="modal-editar" class="modal-overlay">
            <div class="modal-content">
                <h3>‚úèÔ∏è Editar Registro</h3>
                
                <div class="input-group">
                    <label>Folio</label>
                    <input type="text" id="edit-folio" disabled style="background: #f5f5f5;">
                </div>

                <div class="input-group">
                    <label>C√≥digo SAP</label>
                    <input type="text" id="edit-sap" disabled style="background: #f5f5f5;">
                </div>

                <div class="input-group">
                    <label>Descripci√≥n</label>
                    <input type="text" id="edit-desc" disabled style="background: #f5f5f5;">
                </div>

                <div class="two-cols">
                    <div class="input-group">
                        <label>Cantidad *</label>
                        <input type="number" id="edit-cantidad" step="0.01">
                    </div>

                    <div class="input-group">
                        <label>Ubicaci√≥n</label>
                        <input type="text" id="edit-ubicacion" placeholder="Ej: Rack A-5">
                    </div>
                </div>

                <div class="two-cols" style="margin-top: 16px;">
                    <button class="btn-secondary" onclick="cerrarModalEditar()">Cancelar</button>
                    <button id="btn-guardar-edicion" class="btn-primary" onclick="guardarEdicion()">üíæ Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedUser = null;
        let currentRole = null;
        let escaneados = [];
        let currentScanData = null;
        let html5QrCode = null;
        let isScanning = false;
        let registrosGuardados = []; // Simulaci√≥n BD - Primer conteo
        let registrosSegundoConteo = []; // Segundo conteo independiente
        let currentFilter = 'todos';
        let currentAlmacen = 'todos';
        let currentUsuario = 'todos';
        
        // Bases de datos Excel
        let kardexSAP = []; // Inventario te√≥rico
        let baseDescripciones = []; // Cat√°logo de art√≠culos
        
        // Edici√≥n de registros
        let registroEnEdicion = null;
        
        // Control de almacenes y segundo conteo
        let almacenesBloqueados = {
            '00': false,
            '01': false,
            '30': false,
            '31': false,
            '32': false,
            '33': false
        };
        
        let segundoConteoLiberado = {
            '00': false,
            '01': false,
            '30': false,
            '31': false,
            '32': false,
            '33': false
        };
        
        let esSegundoConteo = false; // Flag para saber si estamos en modo segundo conteo
        let pantallaAnterior = 'login'; // Rastrear de d√≥nde viene


        // Cambiar pantalla
        function showScreen(screenId, from) {
            // Guardar de d√≥nde viene si es "registros"
            if (screenId === 'registros' && from) {
                pantallaAnterior = from;
            }
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + screenId).classList.add('active');
            
            // Renderizar registros seg√∫n la pantalla
            if (screenId === 'mis-registros') {
                renderizarMisRegistros();
            } else if (screenId === 'registros') {
                renderizarTodosRegistros();
            } else if (screenId === 'capture') {
                // Activar c√°mara autom√°ticamente al entrar a captura
                setTimeout(() => {
                    const tabEscanear = document.getElementById('tab-escanear');
                    if (tabEscanear && tabEscanear.style.display !== 'none') {
                        startScanning();
                    }
                }, 300);
            } else if (screenId === 'dashboard') {
                // Actualizar dashboard con datos reales
                actualizarDashboard();
            } else if (screenId === 'mesa') {
                // Actualizar panel de fases por almac√©n
                if (typeof actualizarPanelPorAlmacen === 'function') {
                    actualizarPanelPorAlmacen();
                }
            }
        }
        
        // Regresar de Todos los Registros
        function regresarDeRegistros() {
            showScreen(pantallaAnterior);
        }

        // Seleccionar usuario
        function selectUser(element, nombre) {
            document.querySelectorAll('.user-option').forEach(o => o.classList.remove('selected'));
            element.classList.add('selected');
            selectedUser = nombre;
        }
        
        // Filtrar usuarios en el buscador
        function filtrarUsuarios() {
            const searchValue = document.getElementById('search-user').value.toUpperCase();
            const userOptions = document.getElementById('user-list').getElementsByClassName('user-option');
            
            for (let i = 0; i < userOptions.length; i++) {
                const nombre = userOptions[i].textContent || userOptions[i].innerText;
                if (nombre.toUpperCase().indexOf(searchValue) > -1) {
                    userOptions[i].style.display = '';
                } else {
                    userOptions[i].style.display = 'none';
                }
            }
        }
        
        // Seleccionar auditor
        let selectedAuditor = null;
        function selectAuditor(element, nombre) {
            document.querySelectorAll('#auditor-list .user-option').forEach(o => o.classList.remove('selected'));
            element.classList.add('selected');
            selectedAuditor = nombre;
        }
        
        // Filtrar auditores
        function filtrarAuditores() {
            const searchValue = document.getElementById('search-auditor').value.toUpperCase();
            const auditorOptions = document.getElementById('auditor-list').getElementsByClassName('user-option');
            
            for (let i = 0; i < auditorOptions.length; i++) {
                const nombre = auditorOptions[i].textContent || auditorOptions[i].innerText;
                if (nombre.toUpperCase().indexOf(searchValue) > -1) {
                    auditorOptions[i].style.display = '';
                } else {
                    auditorOptions[i].style.display = 'none';
                }
            }
        }
        
        // Entrar como auditor de conteo
        function enterAsAuditorConteo() {
            if (!selectedAuditor) {
                alert('Por favor selecciona tu nombre');
                return;
            }
            
            // Verificar si el auditor tiene AL MENOS UN almac√©n liberado
            const misSAPs = sapsAuditoria.filter(s => s.auditor === selectedAuditor);
            
            if (misSAPs.length === 0) {
                alert('‚ö†Ô∏è No tienes SAPs asignados\n\nMesa de Control debe asignar SAPs primero.\n\nVuelve m√°s tarde.');
                return;
            }
            
            // Verificar si AL MENOS UNO de sus almacenes est√° liberado
            const misAlmacenes = [...new Set(misSAPs.map(s => s.almacen))];
            const hayAlgunAlmacenLiberado = misAlmacenes.some(alm => auditoriasLiberadasPorAlmacen[alm] === true);
            
            if (!hayAlgunAlmacenLiberado) {
                const almacenesTexto = misAlmacenes.join(', ');
                alert(`üîí Almacenes Bloqueados\n\nTienes SAPs asignados en: ${almacenesTexto}\n\nPero Mesa de Control a√∫n no ha liberado ninguno.\n\nVuelve m√°s tarde.`);
                return;
            }
            
            currentRole = 'auditoria-conteo';
            selectedUser = selectedAuditor;
            cargarSAPsAsignados();
            showScreen('menu-auditoria-conteo');
        }

        // Entrar como capturista
        function enterAsCapturista() {
            if (!selectedUser) {
                alert('Por favor selecciona tu nombre');
                return;
            }
            document.getElementById('capturista-name').textContent = selectedUser;
            showScreen('menu-capturista');
        }

        // Modal contrase√±a
        function showPasswordModal(role) {
            currentRole = role;
            const titles = {
                'mesa': 'Mesa de Control',
                'auditoria': 'Auditor√≠a',
                'auditoria-conteo': 'Auditor√≠a de Conteo',
                'admin': 'Administrador'
            };
            document.getElementById('modal-title').textContent = titles[role];
            document.getElementById('modal-password').classList.add('show');
            document.getElementById('modal-pass').value = '';
            document.getElementById('modal-pass').focus();
        }

        function closeModal() {
            document.getElementById('modal-password').classList.remove('show');
        }

        function validatePassword() {
            const pass = document.getElementById('modal-pass').value;
            if (pass.length >= 1) {
                closeModal();
                if (currentRole === 'auditoria') {
                    showScreen('auditoria');
                } else if (currentRole === 'mesa') {
                    showScreen('mesa');
                } else if (currentRole === 'auditoria-conteo') {
                    showScreen('auditoria-conteo-login');
                } else {
                    showScreen('mesa');
                }
            } else {
                alert('Ingresa la contrase√±a');
            }
        }

        // Tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Ocultar todos los tabs
            document.getElementById('tab-escanear').style.display = 'none';
            document.getElementById('tab-qr-sap').style.display = 'none';
            document.getElementById('tab-manual').style.display = 'none';
            
            if (tab === 'escanear') {
                document.getElementById('tab-escanear').style.display = 'block';
                setTimeout(() => startScanning(), 300);
            } else if (tab === 'qr-sap') {
                document.getElementById('tab-qr-sap').style.display = 'block';
                // Dejar campo contador VAC√çO (cada quien llena el suyo)
                // Enfocar en folio
                setTimeout(() => {
                    document.getElementById('taller-folio').focus();
                }, 300);
            } else if (tab === 'manual') {
                document.getElementById('tab-manual').style.display = 'block';
            }
        }

        // Iniciar escaneo QR para Taller (Almac√©n 33)
        // ========== FUNCI√ìN ANTIGUA - YA NO SE USA (nuevo flujo con formulario visible) ==========
        /*
        async function startScanningTaller() {
            const scanButton = document.getElementById('scan-button-taller');
            const qrReader = document.getElementById('qr-reader-taller');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                
                stream.getTracks().forEach(track => track.stop());
                
                scanButton.style.display = 'none';
                qrReader.style.display = 'block';

                const html5QrCodeTaller = new Html5Qrcode("qr-reader-taller");
                
                await html5QrCodeTaller.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0
                    },
                    (decodedText) => {
                        html5QrCodeTaller.stop();
                        qrReader.style.display = 'none';
                        scanButton.style.display = 'block';
                        
                        // VALIDAR que sea QR de almac√©n 33
                        if (!decodedText.includes('CODIGO :') && !decodedText.includes('CODIGO:')) {
                            alert('‚ö†Ô∏è Este QR no es v√°lido para almac√©n 33\n\nDebe contener "CODIGO : [n√∫mero]"\n\nUsa el tab "Escanear QR" para marbetes normales.');
                            return;
                        }
                        
                        procesarQR(decodedText, 'QR SAP');
                    },
                    (errorMessage) => {
                        // Ignorar errores de escaneo
                    }
                );
            } catch (err) {
                alert('Error al acceder a la c√°mara: ' + err.message);
                scanButton.style.display = 'block';
            }
        }
        */


        // Iniciar escaneo QR
        async function startScanning() {
            const scanButton = document.getElementById('scan-button');
            const qrReader = document.getElementById('qr-reader');
            
            try {
                // Solicitar permisos expl√≠citamente primero
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                
                // Detener el stream de prueba
                stream.getTracks().forEach(track => track.stop());
                
                // Ahora iniciar el lector QR
                scanButton.style.display = 'none';
                qrReader.style.display = 'block';

                html5QrCode = new Html5Qrcode("qr-reader");
                
                await html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0
                    },
                    (decodedText) => {
                        html5QrCode.stop();
                        qrReader.style.display = 'none';
                        scanButton.style.display = 'block';
                        procesarQR(decodedText, 'QR');
                    },
                    (errorMessage) => {
                        // Errores de escaneo (ignorar)
                    }
                );
            } catch (err) {
                console.error('Error c√°mara:', err);
                qrReader.style.display = 'none';
                scanButton.style.display = 'block';
                
                let mensaje = 'No se pudo acceder a la c√°mara.\n\n';
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    mensaje += '‚ö†Ô∏è Debes permitir el acceso a la c√°mara en la configuraci√≥n de tu navegador.\n\n';
                    mensaje += '1. Ve a Configuraci√≥n del sitio\n';
                    mensaje += '2. Busca "Permisos"\n';
                    mensaje += '3. Activa "C√°mara"\n';
                    mensaje += '4. Recarga la p√°gina';
                } else if (err.name === 'NotFoundError') {
                    mensaje += '‚ùå No se encontr√≥ ninguna c√°mara en este dispositivo.';
                } else if (err.name === 'NotReadableError') {
                    mensaje += '‚ö†Ô∏è La c√°mara est√° siendo usada por otra aplicaci√≥n.\n\nCierra otras apps y vuelve a intentar.';
                } else {
                    mensaje += 'Error: ' + err.message + '\n\nUsa la captura manual en su lugar.';
                }
                
                alert(mensaje);
            }
        }

        // Procesar QR escaneado
        function procesarQR(texto, metodo = 'QR') {
            console.log('üì∏ SCAN: Texto escaneado:', texto);
            
            // DETECTAR SI ES QR DE ALMAC√âN 33 (formato especial con "CODIGO :")
            if (texto.includes('CODIGO :') || texto.includes('CODIGO:')) {
                console.log('üîß SCAN: Detectado formato TALLER, redirigiendo a procesarQRAlmacen33()');
                procesarQRAlmacen33(texto);
                return;
            }
            
            console.log('üì¶ SCAN: Formato normal, procesando...');
            
            // Formato normal: F7 Materia Prima 2002398 CAPACITOR FILM 0.68 Uf 10% 310VAC RAD, MCA. W√úRTH, MOD.890334027006CS
            const partes = texto.split(' ');
            
            if (partes.length < 3) {
                if (confirm('‚ö†Ô∏è C√≥digo QR no v√°lido o da√±ado.\n\n¬øDeseas usar captura manual?')) {
                    document.getElementById('tab-qr').classList.remove('active');
                    document.getElementById('tab-manual').classList.add('active');
                    document.getElementById('tab-scan').style.display = 'none';
                    document.getElementById('tab-manual').style.display = 'block';
                }
                return;
            }

            const folio = partes[0];
            let almacen = '';
            let almacenCod = '';
            let sap = '';
            let desc = '';

            // Detectar almac√©n
            if (texto.includes('Materia Prima')) {
                almacen = '01 - Materia Prima';
                almacenCod = '01';
            } else if (texto.includes('Transformadores')) {
                almacen = '30 - Transformadores';
                almacenCod = '30';
            } else if (texto.includes('Placas')) {
                almacen = '31 - Placas';
                almacenCod = '31';
            } else if (texto.includes('Arneses')) {
                almacen = '32 - Arneses';
                almacenCod = '32';
            } else if (texto.includes('Gabinetes')) {
                almacen = '33 - Gabinetes';
                almacenCod = '33';
            }

            // VALIDAR SI ALMAC√âN EST√Å BLOQUEADO
            if (!esSegundoConteo && almacenesBloqueados[almacenCod]) {
                alert('‚ö†Ô∏è Este almac√©n ya fue cerrado por Auditor√≠a\n\nNo se pueden agregar m√°s registros al primer conteo.');
                return;
            }

            // Encontrar c√≥digo SAP (6-7 d√≠gitos)
            for (let i = 0; i < partes.length; i++) {
                if (/^\d{6,7}$/.test(partes[i])) {
                    sap = partes[i];
                    desc = partes.slice(i + 1).join(' ');
                    break;
                }
            }

            if (!sap) {
                if (confirm('‚ö†Ô∏è No se encontr√≥ c√≥digo SAP v√°lido.\n\n¬øDeseas usar captura manual?')) {
                    document.getElementById('tab-qr').classList.remove('active');
                    document.getElementById('tab-manual').classList.add('active');
                    document.getElementById('tab-scan').style.display = 'none';
                    document.getElementById('tab-manual').style.display = 'block';
                }
                return;
            }

            // VALIDAR SI EXISTE EN BASE DE DESCRIPCIONES Y OBTENER UNIDAD DE MEDIDA
            let esPositivo = false;
            let descripcionFinal = desc;
            let unidadMedida = 'PZA'; // Default
            
            if (baseDescripciones.length > 0) {
                const encontrado = baseDescripciones.find(item => item.codigo === sap);
                if (!encontrado) {
                    esPositivo = true;
                    descripcionFinal = '‚ö†Ô∏è MATERIAL NO ENCONTRADO EN SAP - ' + desc;
                } else {
                    descripcionFinal = encontrado.descripcion || desc;
                }
            }
            
            // Obtener UM del Kardex si existe
            if (kardexSAP.length > 0) {
                const itemKardex = kardexSAP.find(item => item.codigo === sap);
                if (itemKardex && itemKardex.unidadMedida) {
                    unidadMedida = itemKardex.unidadMedida;
                }
            }

            currentScanData = {
                folio: folio,
                almacen: almacen,
                almacenCod: almacenCod,
                sap: sap,
                desc: descripcionFinal,
                metodo: metodo,
                esPositivo: esPositivo,
                unidadMedida: unidadMedida
            };
            
            // Mostrar formulario
            document.getElementById('form-folio').value = folio;
            document.getElementById('form-folio').readOnly = true; // Readonly en modo normal
            document.getElementById('form-almacen-select').value = almacenCod; // Setear select
            document.getElementById('form-sap').textContent = sap + (esPositivo ? ' ‚ö†Ô∏è POSITIVO' : '');
            document.getElementById('form-desc').textContent = descripcionFinal;
            document.getElementById('form-cantidad').value = '';
            document.getElementById('form-ubicacion').value = '';
            document.getElementById('form-contador').value = '';
            
            document.getElementById('scan-form-container').style.display = 'block';
            document.getElementById('form-cantidad').focus();
        }

        // Validar duplicado
        function validarDuplicado(item) {
            // NIVEL 1: Revisar duplicados del MISMO usuario (mi usuario)
            const duplicadoMio = registrosGuardados.some(r => 
                r.usuario === selectedUser &&
                r.folio === item.folio &&
                r.almacen === item.almacen &&
                r.sap === item.sap &&
                !r.eliminado
            );
            
            const duplicadoEscaneado = escaneados.some(r => 
                r.folio === item.folio &&
                r.almacen === item.almacen &&
                r.sap === item.sap
            );
            
            // NIVEL 2: Revisar duplicados de OTRO usuario (global)
            const duplicadoOtro = registrosGuardados.find(r => 
                r.usuario !== selectedUser &&
                r.folio === item.folio &&
                r.almacen === item.almacen &&
                r.sap === item.sap &&
                !r.eliminado
            );
            
            // Retornar objeto con info de duplicado
            return {
                esDuplicado: duplicadoMio || duplicadoEscaneado || duplicadoOtro,
                duplicadoMio: duplicadoMio || duplicadoEscaneado,
                duplicadoOtro: duplicadoOtro,
                otroUsuario: duplicadoOtro ? duplicadoOtro.usuario : null
            };
        }

        // Confirmar formulario
        function confirmarFormulario() {
            const cantidad = parseFloat(document.getElementById('form-cantidad').value);
            const ubicacion = document.getElementById('form-ubicacion').value;
            const nombreContador = document.getElementById('form-contador').value.trim();
            const almacenSeleccionado = document.getElementById('form-almacen-select').value; // Leer del select
            
            // Convertir MAQUILA a 01 (f√≠sicamente es √°rea separada pero se suma como almac√©n 01)
            const almacenFinal = almacenSeleccionado === '01-MAQUILA' ? '01' : almacenSeleccionado;
            
            // Validar folio si viene vac√≠o en currentScanData (almac√©n 33)
            const folioInput = document.getElementById('form-folio').value.trim().toUpperCase();
            if (!currentScanData.folio && !folioInput) {
                alert('‚ö†Ô∏è Debes ingresar el folio del marbete');
                document.getElementById('form-folio').focus();
                return;
            }
            
            // Validar que "Qui√©n cont√≥" est√© lleno
            if (!nombreContador) {
                alert('‚ö†Ô∏è Debes indicar qui√©n hizo el conteo');
                document.getElementById('form-contador').focus();
                return;
            }
            
            // Validar cantidad
            if (cantidad === '' || cantidad === null || isNaN(cantidad)) {
                alert('Ingresa una cantidad v√°lida');
                return;
            }
            
            // Validar cantidad negativa
            if (cantidad < 0) {
                alert('La cantidad no puede ser negativa');
                return;
            }
            
            // Confirmaci√≥n si cantidad es 0
            if (cantidad === 0) {
                if (!confirm('‚ö†Ô∏è ¬øConfirmas que la cantidad es 0?\n\nEsto significa que el art√≠culo NO existe f√≠sicamente.')) {
                    return;
                }
            }
            
            const item = {
                folio: currentScanData.folio || document.getElementById('form-folio').value.trim().toUpperCase(), // Si est√° vac√≠o, leer del input (almac√©n 33)
                almacen: almacenFinal, // Usar almac√©n convertido (MAQUILA ‚Üí 01)
                sap: currentScanData.sap,
                desc: currentScanData.desc,
                cantidad: cantidad,
                ubicacion: ubicacion,
                nombreContador: nombreContador,
                metodo: currentScanData.metodo,
                usuario: selectedUser,
                unidadMedida: currentScanData.unidadMedida || 'PZA',
                esDuplicado: false,
                continuoDespuesAlerta: false,
                esPositivo: currentScanData.esPositivo || false,
                areaMaquila: almacenSeleccionado === '01-MAQUILA', // Marcar si es de maquila
                fecha: new Date().toISOString()
            };

            const resultadoDuplicado = validarDuplicado(item);
            
            if (resultadoDuplicado.esDuplicado) {
                let mensaje = '';
                
                if (resultadoDuplicado.duplicadoOtro) {
                    // NIVEL 2: Duplicado de OTRO usuario (ALERTA ROJA)
                    mensaje = `üö® CUIDADO: Este folio ya fue contado por ${resultadoDuplicado.otroUsuario}\n\nFolio: ${item.folio}\nAlmac√©n: ${item.almacen}\nSAP: ${item.sap}\n\n¬øEst√°s SEGURO que deseas continuar?`;
                } else if (resultadoDuplicado.duplicadoMio) {
                    // NIVEL 1: Duplicado del MISMO usuario (ALERTA NARANJA)
                    mensaje = `‚ö†Ô∏è ALERTA: Ya escaneaste este folio antes\n\nFolio: ${item.folio}\nAlmac√©n: ${item.almacen}\nSAP: ${item.sap}\n\n¬øDeseas continuar de todos modos?`;
                }
                
                if (confirm(mensaje)) {
                    item.esDuplicado = true;
                    item.continuoDespuesAlerta = true;
                    agregarEscaneado(item);
                    
                    // Sonido de escaneo exitoso
                    reproducirSonido('scan');
                }
            } else {
                agregarEscaneado(item);
                
                // Sonido de escaneo exitoso
                reproducirSonido('scan');
            }
            
            document.getElementById('scan-form-container').style.display = 'none';
            currentScanData = null;
        }

        function cancelarFormulario() {
            document.getElementById('scan-form-container').style.display = 'none';
            currentScanData = null;
        }

        // Agregar manual
        // Autocompletar descripci√≥n en captura manual
        function autocompletarDescripcion() {
            const sap = document.getElementById('manual-sap').value.trim();
            const descInput = document.getElementById('manual-descripcion');
            
            if (!sap) {
                descInput.value = '';
                return;
            }
            
            // Buscar en base de descripciones
            if (baseDescripciones.length > 0) {
                const encontrado = baseDescripciones.find(item => item.codigo === sap);
                if (encontrado) {
                    descInput.value = encontrado.descripcion;
                    descInput.style.color = '#000';
                } else {
                    descInput.value = '‚ö†Ô∏è C√ìDIGO NO ENCONTRADO EN SAP';
                    descInput.style.color = '#d32f2f';
                }
            } else {
                descInput.value = 'Base de descripciones no cargada';
                descInput.style.color = '#ff9800';
            }
        }
        
        function agregarManual() {
            const folio = document.getElementById('manual-folio').value.toUpperCase().trim();
            const almacenSeleccionado = document.getElementById('manual-almacen').value;
            const sap = document.getElementById('manual-sap').value.trim();
            const cantidad = parseFloat(document.getElementById('manual-cantidad').value);
            const ubicacion = document.getElementById('manual-ubicacion').value.trim();
            const nombreContador = document.getElementById('manual-contador').value.trim();

            // Convertir MAQUILA a 01
            const almacen = almacenSeleccionado === '01-MAQUILA' ? '01' : almacenSeleccionado;

            // Validar campos requeridos
            if (!folio || !sap || !almacen) {
                alert('‚ö†Ô∏è Debes llenar Folio, Almac√©n y C√≥digo SAP');
                return;
            }
            
            // Validar que "Qui√©n cont√≥" est√© lleno
            if (!nombreContador) {
                alert('‚ö†Ô∏è Debes indicar qui√©n hizo el conteo');
                document.getElementById('manual-contador').focus();
                return;
            }
            
            // Validar cantidad
            if (cantidad === '' || cantidad === null || isNaN(cantidad)) {
                alert('‚ö†Ô∏è Ingresa una cantidad v√°lida');
                return;
            }
            
            // Validar cantidad negativa
            if (cantidad < 0) {
                alert('La cantidad no puede ser negativa');
                return;
            }
            
            // Confirmaci√≥n si cantidad es 0
            if (cantidad === 0) {
                if (!confirm('‚ö†Ô∏è ¬øConfirmas que la cantidad es 0?\n\nEsto significa que el art√≠culo NO existe f√≠sicamente.')) {
                    return;
                }
            }
            
            // VALIDAR SI ALMAC√âN EST√Å BLOQUEADO
            if (!esSegundoConteo && almacenesBloqueados[almacen]) {
                alert('‚ö†Ô∏è Este almac√©n ya fue cerrado por Auditor√≠a\n\nNo se pueden agregar m√°s registros al primer conteo.');
                return;
            }
            
            // Obtener descripci√≥n y UM de la base
            let descripcion = 'Captura manual';
            let unidadMedida = 'PZA';
            let esPositivo = false;
            
            if (baseDescripciones.length > 0) {
                const encontrado = baseDescripciones.find(item => item.codigo === sap);
                if (!encontrado) {
                    esPositivo = true;
                    descripcion = '‚ö†Ô∏è MATERIAL NO ENCONTRADO EN SAP';
                } else {
                    descripcion = encontrado.descripcion || 'Captura manual';
                }
            }
            
            if (kardexSAP.length > 0) {
                const itemKardex = kardexSAP.find(item => item.codigo === sap);
                if (itemKardex && itemKardex.unidadMedida) {
                    unidadMedida = itemKardex.unidadMedida;
                }
            }

            const item = {
                folio: folio,
                almacen: almacen,
                sap: sap,
                desc: descripcion,
                cantidad: cantidad,
                ubicacion: ubicacion,
                nombreContador: nombreContador,
                metodo: 'Manual',
                usuario: selectedUser,
                unidadMedida: unidadMedida,
                esDuplicado: false,
                esPositivo: esPositivo,
                areaMaquila: almacenSeleccionado === '01-MAQUILA',
                fecha: new Date().toISOString()
            };
            
            // Validar duplicado
            const resultadoDuplicado = validarDuplicado(item);
            
            if (resultadoDuplicado.esDuplicado) {
                let mensaje = '';
                
                if (resultadoDuplicado.duplicadoOtro) {
                    // NIVEL 2: Duplicado de OTRO usuario (ALERTA ROJA)
                    mensaje = `üö® CUIDADO: Este folio ya fue contado por ${resultadoDuplicado.otroUsuario}\n\nFolio: ${item.folio}\nAlmac√©n: ${item.almacen}\nSAP: ${item.sap}\n\n¬øEst√°s SEGURO que deseas continuar?`;
                } else if (resultadoDuplicado.duplicadoMio) {
                    // NIVEL 1: Duplicado del MISMO usuario (ALERTA NARANJA)
                    mensaje = `‚ö†Ô∏è ALERTA: Ya escaneaste este folio antes\n\nFolio: ${item.folio}\nAlmac√©n: ${item.almacen}\nSAP: ${item.sap}\n\n¬øDeseas continuar de todos modos?`;
                }
                
                if (confirm(mensaje)) {
                    item.esDuplicado = true;
                    item.continuoDespuesAlerta = true;
                    agregarEscaneado(item);
                    
                    // Sonido
                    reproducirSonido('scan');
                }
            } else {
                agregarEscaneado(item);
                
                // Sonido
                reproducirSonido('scan');
            }

            // Limpiar formulario
            document.getElementById('manual-folio').value = '';
            document.getElementById('manual-sap').value = '';
            document.getElementById('manual-descripcion').value = '';
            document.getElementById('manual-descripcion').style.color = '#000';
            document.getElementById('manual-cantidad').value = '';
            document.getElementById('manual-ubicacion').value = '';
            document.getElementById('manual-contador').value = '';
        }

        // Agregar escaneado
        function agregarEscaneado(item) {
            escaneados.push(item);
            actualizarListaEscaneados();
        }

        // Actualizar lista
        function actualizarListaEscaneados() {
            const lista = document.getElementById('lista-escaneados');
            const count = document.getElementById('count-escaneados');
            const countConfirm = document.getElementById('count-confirm');
            const confirmBar = document.getElementById('confirm-bar');
            
            count.textContent = escaneados.length;
            countConfirm.textContent = escaneados.length;
            
            if (escaneados.length === 0) {
                lista.innerHTML = '<div class="empty-state">Escanea marbetes para agregarlos</div>';
                confirmBar.classList.remove('show');
            } else {
                confirmBar.classList.add('show');
                lista.innerHTML = escaneados.map((item, index) => `
                    <div class="scanned-item">
                        <div class="info">
                            <span class="folio">${item.folio}</span>
                            <span class="details">${item.sap} ‚Ä¢ Alm ${item.almacen}</span>
                        </div>
                        <span class="qty">${item.cantidad}</span>
                        <button class="btn-remove" onclick="removerEscaneado(${index})">‚úï</button>
                    </div>
                `).join('');
            }
        }

        function removerEscaneado(index) {
            escaneados.splice(index, 1);
            actualizarListaEscaneados();
        }

        // Confirmar escaneos
        async function confirmarEscaneos() {
            const total = escaneados.length;
            
            // VALIDAR que haya registros
            if (total === 0) {
                alert('‚ö†Ô∏è No hay registros para guardar');
                return;
            }
            
            // Obtener bot√≥n de confirmaci√≥n
            const btnConfirmar = document.querySelector('.btn-confirm');
            if (!btnConfirmar) {
                console.error('‚ùå No se encontr√≥ bot√≥n confirmar');
                return;
            }
            
            // BLOQUEAR BOT√ìN inmediatamente (prevenir doble clic)
            btnConfirmar.disabled = true;
            const textoOriginal = btnConfirmar.textContent;
            
            try {
                console.log(`üì¶ Guardando ${total} registros...`);
                
                // Guardar cada registro en Firebase
                const { collection, addDoc } = window.firebaseCollections;
                const db = window.firebaseDB;
                const coleccion = esSegundoConteo ? 'registros_segundo_conteo' : 'registros';
                
                for (let i = 0; i < total; i++) {
                    // INDICADOR VISUAL - Mostrar progreso
                    btnConfirmar.textContent = `‚è≥ Guardando ${i + 1}/${total}`;
                    
                    const registro = escaneados[i];
                    
                    // Guardar en Firebase
                    await addDoc(collection(db, coleccion), {
                        ...registro,
                        timestamp: new Date().toISOString(),
                        sincronizado: true
                    });
                    
                    console.log(`‚úÖ Registro ${i + 1}/${total} guardado en Firebase`);
                }
                
                // ESCRIBIR EN GOOGLE SHEETS (solo primer conteo)
                if (!esSegundoConteo) {
                    btnConfirmar.textContent = 'üìä Sincronizando Sheets...';
                    
                    for (let i = 0; i < total; i++) {
                        await enviarAGoogleSheets(escaneados[i]);
                        console.log(`‚úÖ Registro ${i + 1}/${total} enviado a Sheets`);
                    }
                }
                
                // Guardar tambi√©n en memoria local
                if (esSegundoConteo) {
                    registrosSegundoConteo.push(...escaneados);
                } else {
                    registrosGuardados.push(...escaneados);
                }
                
                // Sonido de confirmaci√≥n
                reproducirSonido('success');
                
                // Mostrar overlay de √©xito
                document.getElementById('success-overlay').classList.add('show');
                
                setTimeout(() => {
                    document.getElementById('success-overlay').classList.remove('show');
                }, 2000);
                
                console.log(`‚úÖ ${total} registros guardados correctamente`);
                
            } catch (error) {
                console.error('‚ùå Error al guardar registros:', error);
                alert('‚ö†Ô∏è Error al guardar registros:\n\n' + error.message + '\n\nVerifica tu conexi√≥n.');
                
            } finally {
                // SIEMPRE ejecutar (haya error o no):
                // 1. Limpiar lista
                escaneados = [];
                actualizarListaEscaneados();
                
                // 2. Restaurar bot√≥n
                btnConfirmar.disabled = false;
                btnConfirmar.textContent = textoOriginal;
                
                console.log('üîÑ Lista limpiada y bot√≥n restaurado');
            }
        }
        
        // Reproducir sonidos
        function reproducirSonido(tipo) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (tipo === 'scan') {
                    // Beep corto para escaneo
                    oscillator.frequency.value = 800;
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                } else if (tipo === 'success') {
                    // Sonido de √©xito
                    oscillator.frequency.value = 1000;
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                }
            } catch (error) {
                console.log('No se pudo reproducir sonido:', error);
            }
        }

        // File upload
        async function handleFileUpload(input, type) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                // Mostrar preview con nombre
                document.getElementById('preview-' + type).classList.add('show');
                document.getElementById('name-' + type).textContent = file.name + ' (Procesando...)';
                
                // Leer archivo
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if (type === 'kardex') {
                    // Guardar Kardex SAP
                    kardexSAP = jsonData.map(row => ({
                        codigo: String(row['C√≥digo Art√≠culo'] || row['Codigo'] || row['C√≥digo'] || row['CODIGO'] || row['ItemCode'] || '').trim(),
                        descripcion: String(row['Descripci√≥n'] || row['DESCRIPCION'] || row['ItemName'] || '').trim(),
                        serie: String(row['N√∫mero de Serie'] || row['Serie'] || '').trim(),
                        tieneSerie: String(row['Tiene Serie'] || '').trim(),
                        almacen: String(row['Almac√©n'] || row['Almacen'] || row['ALMACEN'] || row['WhsCode'] || '').trim().padStart(2, '0'),
                        cantidad: parseFloat(row['Cantidad'] || row['CANTIDAD'] || row['OnHand'] || 0),
                        costoUnitario: parseFloat(row['Costo Unitario'] || row['CostoUnitario'] || 0),
                        costoTotal: parseFloat(row['Costo Total'] || row['CostoTotal'] || 0),
                        unidadMedida: String(row['Unidad de Medida'] || row['UnidadMedida'] || row['InvntryUom'] || 'PZA').trim()
                    })).filter(item => item.codigo);
                    
                    document.getElementById('name-' + type).textContent = 
                        file.name + ` ‚úì (${kardexSAP.length} art√≠culos)`;
                    
                    console.log('Kardex cargado:', kardexSAP.length, 'art√≠culos');
                    
                } else if (type === 'descripciones') {
                    // Guardar Base de Descripciones
                    baseDescripciones = jsonData.map(row => ({
                        codigo: String(row['Codigo'] || row['C√≥digo SAP'] || row['C√≥digo Art√≠culo'] || row['C√≥digo'] || row['CODIGO'] || row['ItemCode'] || '').trim(),
                        descripcion: String(row['Descripcion'] || row['Descripci√≥n del material'] || row['Descripci√≥n'] || row['DESCRIPCION'] || row['ItemName'] || '').trim(),
                        grupo: String(row['Grupo'] || row['GRUPO'] || row['ItmsGrpNam'] || '').trim()
                    })).filter(item => item.codigo);
                    
                    document.getElementById('name-' + type).textContent = 
                        file.name + ` ‚úì (${baseDescripciones.length} art√≠culos)`;
                    
                    console.log('Base Descripciones cargada:', baseDescripciones.length, 'art√≠culos');
                }
                
                alert(`‚úì Archivo cargado exitosamente\n\n${jsonData.length} registros procesados`);
                
            } catch (error) {
                console.error('Error al leer Excel:', error);
                alert('‚ùå Error al leer el archivo Excel\n\n' + error.message);
                document.getElementById('name-' + type).textContent = file.name + ' (Error)';
            }
        }

        function removeFile(type) {
            document.getElementById('file-' + type).value = '';
            document.getElementById('preview-' + type).classList.remove('show');
            
            if (type === 'kardex') {
                kardexSAP = [];
            } else if (type === 'descripciones') {
                baseDescripciones = [];
            }
        }

        // Filtrar mis registros
        function filtrarMisRegistros() {
            const query = document.getElementById('search-mis-registros').value;
            alert('Buscando: ' + query);
        }

        // Filtros
        function toggleFilter(element, type) {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            element.classList.add('active');
            document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('show'));
            
            if (type !== 'todos' && type !== 'duplicados') {
                const dropdown = document.getElementById('filter-' + type);
                if (dropdown) dropdown.classList.add('show');
            }
            
            currentFilter = type;
            
            // Aplicar filtro inmediatamente
            buscarRegistros();
        }

        function selectAlmacen(almacen) {
            document.querySelectorAll('#filter-almacen .filter-option').forEach(o => o.classList.remove('selected'));
            event.target.classList.add('selected');
            currentAlmacen = almacen;
            document.getElementById('filter-almacen').classList.remove('show');
            buscarRegistros();
        }

        function selectUsuario(usuario) {
            document.querySelectorAll('#filter-usuario .filter-option').forEach(o => o.classList.remove('selected'));
            event.target.classList.add('selected');
            currentUsuario = usuario;
            document.getElementById('filter-usuario').classList.remove('show');
            buscarRegistros();
        }

        function buscarRegistros() {
            const query = document.getElementById('search-registros').value.toLowerCase();
            
            let registrosFiltrados = registrosGuardados.filter(r => !r.eliminado && !r.modificado && r.almacen !== '00');
            
            // Filtrar por b√∫squeda
            if (query) {
                registrosFiltrados = registrosFiltrados.filter(r => 
                    r.folio.toLowerCase().includes(query) ||
                    r.sap.toLowerCase().includes(query) ||
                    r.desc.toLowerCase().includes(query)
                );
            }
            
            // Filtrar por tipo
            if (currentFilter === 'duplicados') {
                registrosFiltrados = registrosFiltrados.filter(r => r.esDuplicado);
            }
            
            // Filtrar por almac√©n
            if (currentAlmacen !== 'todos') {
                registrosFiltrados = registrosFiltrados.filter(r => r.almacen === currentAlmacen);
            }
            
            // Filtrar por usuario
            if (currentUsuario !== 'todos') {
                registrosFiltrados = registrosFiltrados.filter(r => r.usuario === currentUsuario);
            }
            
            // Renderizar resultados
            const container = document.getElementById('container-todos-registros');
            const count = document.getElementById('count-registros');
            
            count.textContent = `${registrosFiltrados.length} registros encontrados`;
            
            if (registrosFiltrados.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #9e9e9e;">No se encontraron registros</div>';
                return;
            }
            
            container.innerHTML = registrosFiltrados.map((r) => `
                <div class="registro-card">
                    <div class="registro-header">
                        <span class="registro-folio">${r.folio}</span>
                        <span class="registro-badge almacen">üì¶ ${r.almacen}</span>
                        ${r.esDuplicado ? '<span class="registro-badge duplicado">DUPLICADO</span>' : ''}
                        ${r.esPositivo ? '<span class="registro-badge positivo">POSITIVO</span>' : ''}
                    </div>
                    <p class="registro-sap">${r.sap}</p>
                    <p class="registro-desc">${r.desc}</p>
                    <div class="registro-meta">
                        <span>Cant: <strong>${r.cantidad} ${r.unidadMedida || 'PZA'}</strong></span>
                        <span>Ubic: <strong>${r.ubicacion || 'N/A'}</strong></span>
                        <div class="registro-actions">
                            <button class="btn-icon" onclick="editarRegistro(${registrosGuardados.indexOf(r)})">‚úèÔ∏è</button>
                            <button class="btn-icon delete" onclick="eliminarRegistro(${registrosGuardados.indexOf(r)})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #9e9e9e; margin-top: 8px;">
                        üë§ ${r.usuario} ‚Ä¢ ${r.metodo === 'QR' ? 'üì±' : '‚úçÔ∏è'} ${r.metodo} ‚Ä¢ ${r.nombreContador || 'N/A'} ‚Ä¢ ${new Date(r.fecha).toLocaleString('es-MX', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'})}
                    </div>
                    ${r.esDuplicado ? '<div class="registro-nota"><strong>‚ö†Ô∏è DUPLICADO</strong> - Usuario continu√≥ despu√©s de alerta</div>' : ''}
                </div>
            `).join('');
        }

        // ========== EDITAR REGISTRO ==========
        function editarRegistro(index) {
            const registro = registrosGuardados[index];
            if (!registro || registro.eliminado) {
                alert('Registro no encontrado');
                return;
            }

            registroEnEdicion = index;
            
            document.getElementById('edit-folio').value = registro.folio;
            document.getElementById('edit-sap').value = registro.sap;
            document.getElementById('edit-desc').value = registro.desc;
            document.getElementById('edit-cantidad').value = registro.cantidad;
            document.getElementById('edit-ubicacion').value = registro.ubicacion || '';
            
            document.getElementById('modal-editar').classList.add('show');
        }

        function cerrarModalEditar() {
            document.getElementById('modal-editar').classList.remove('show');
            registroEnEdicion = null;
        }

        async function guardarEdicion() {
            const cantidad = document.getElementById('edit-cantidad').value;
            const ubicacion = document.getElementById('edit-ubicacion').value;

            if (!cantidad || cantidad <= 0) {
                alert('Ingresa una cantidad v√°lida');
                return;
            }

            if (registroEnEdicion !== null) {
                const registroViejo = registrosGuardados[registroEnEdicion];
                
                // Detectar cambios
                const cambios = [];
                if (parseFloat(cantidad) !== registroViejo.cantidad) {
                    cambios.push(`Cantidad: ${registroViejo.cantidad} ‚Üí ${cantidad}`);
                }
                if (ubicacion !== (registroViejo.ubicacion || '')) {
                    cambios.push(`Ubicaci√≥n: "${registroViejo.ubicacion || '(vac√≠o)'}" ‚Üí "${ubicacion}"`);
                }
                
                if (cambios.length === 0) {
                    alert('‚ö†Ô∏è No detect√© ning√∫n cambio');
                    return;
                }
                
                // PEDIR RAZ√ìN (opcional pero recomendado)
                const razon = prompt(
                    `üìù ¬øQu√© cambi√≥? (Opcional)\n\n` +
                    `Cambios detectados:\n` +
                    cambios.map(c => `‚Ä¢ ${c}`).join('\n') + `\n\n` +
                    `Ejemplos:\n` +
                    `- "Conteo incorrecto"\n` +
                    `- "Faltaban m√°s unidades"\n` +
                    `- "Error de captura"\n\n` +
                    `Presiona OK para continuar sin raz√≥n,\n` +
                    `o escribe la raz√≥n:`
                );
                
                // BLOQUEAR BOT√ìN
                const btnGuardar = document.getElementById('btn-guardar-edicion');
                if (!btnGuardar) {
                    console.error('‚ùå Bot√≥n guardar edici√≥n no encontrado');
                    return;
                }
                
                btnGuardar.disabled = true;
                const textoOriginal = btnGuardar.textContent;
                btnGuardar.textContent = '‚è≥ Guardando...';
                
                try {
                    // Guardar en historial del registro VIEJO
                    if (!registroViejo.versiones) {
                        registroViejo.versiones = [{
                            version: 1,
                            fecha: registroViejo.fecha || new Date().toISOString(),
                            accion: 'CREADO',
                            usuario: registroViejo.usuario,
                            datos: {
                                cantidad: registroViejo.cantidad,
                                ubicacion: registroViejo.ubicacion
                            }
                        }];
                    }
                    
                    // MARCAR TODOS LOS REGISTROS CON MISMO FOLIO+ALMACEN+SAP COMO EDITADO
                    registrosGuardados.forEach((r, i) => {
                        if (r.folio === registroViejo.folio && 
                            r.almacen === registroViejo.almacen && 
                            r.sap === registroViejo.sap && 
                            !r.eliminado) {
                            
                            r.modificado = true;
                            r.fechaModificacion = new Date().toISOString();
                            r.modificadoPor = currentRole || selectedUser;
                            
                            // Enviar a Google Sheets como EDITADO
                            enviarAGoogleSheets({
                                ...r,
                                eliminado: false,
                                modificado: true
                            });
                        }
                    });
                    
                    // Crear NUEVA versi√≥n con el MISMO FOLIO
                    const registroNuevo = {
                        ...registroViejo,
                        folio: registroViejo.folio,
                        cantidad: parseFloat(cantidad),
                        ubicacion: ubicacion,
                        fecha: new Date().toISOString(),
                        eliminado: false,
                        modificado: false, // El NUEVO es ACTIVO
                        editadoDe: registroViejo.fecha,
                        razonEdicion: razon && razon.trim() !== '' ? razon.trim() : 'Sin raz√≥n especificada',
                        editadoPor: currentRole || selectedUser,
                        cambiosRealizados: cambios,
                        versiones: [
                            ...registroViejo.versiones,
                            {
                                version: registroViejo.versiones.length + 1,
                                fecha: new Date().toISOString(),
                                accion: 'EDITADO',
                                usuario: currentRole || selectedUser,
                                razon: razon && razon.trim() !== '' ? razon.trim() : 'Sin raz√≥n',
                                cambios: cambios,
                                datosAnteriores: {
                                    cantidad: registroViejo.cantidad,
                                    ubicacion: registroViejo.ubicacion
                                },
                                datosNuevos: {
                                    cantidad: parseFloat(cantidad),
                                    ubicacion: ubicacion
                                }
                            }
                        ]
                    };
                    
                    btnGuardar.textContent = 'üìä Guardando en Firebase...';
                    
                    // Guardar en Firebase
                    const { collection, addDoc } = window.firebaseCollections;
                    const db = window.firebaseDB;
                    
                    await addDoc(collection(db, 'registros'), {
                        ...registroNuevo,
                        timestamp: new Date().toISOString(),
                        sincronizado: true
                    });
                    
                    btnGuardar.textContent = 'üìä Sincronizando Sheets...';
                    
                    // Enviar NUEVO registro a Google Sheets como ACTIVO
                    await enviarAGoogleSheets(registroNuevo);
                    
                    registrosGuardados.push(registroNuevo);
                    
                    console.log('‚úÖ Registro editado correctamente');
                    
                    // CONFIRMACI√ìN VISUAL MEJORADA
                    mostrarConfirmacionEdicion(
                        registroViejo.folio,
                        cambios,
                        razon && razon.trim() !== '' ? razon.trim() : 'Sin raz√≥n',
                        currentRole || selectedUser
                    );
                    
                    setTimeout(() => {
                        cerrarModalEditar();
                        renderizarMisRegistros();
                        renderizarTodosRegistros();
                    }, 2500);
                    
                } catch (error) {
                    console.error('‚ùå Error al editar:', error);
                    alert('‚ö†Ô∏è Error al guardar:\n\n' + error.message);
                    
                } finally {
                    // SIEMPRE restaurar bot√≥n
                    if (btnGuardar) {
                        btnGuardar.disabled = false;
                        btnGuardar.textContent = textoOriginal;
                    }
                }
            }
        }
        
        // Mostrar confirmaci√≥n visual de edici√≥n
        function mostrarConfirmacionEdicion(folio, cambios, razon, usuario) {
            const overlay = document.getElementById('success-overlay');
            const ahora = new Date();
            const hora = ahora.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'});
            const fecha = ahora.toLocaleDateString('es-MX', {day: '2-digit', month: 'short'});
            
            overlay.innerHTML = `
                <div style="text-align: center; max-width: 420px;">
                    <div style="font-size: 60px; margin-bottom: 16px;">‚úèÔ∏è</div>
                    <h2 style="color: #1976d2; margin: 0 0 8px 0; font-size: 22px;">EDITADO CORRECTAMENTE</h2>
                    <div style="background: #e3f2fd; border-radius: 12px; padding: 16px; margin: 16px 0; text-align: left; border: 2px solid #90caf9;">
                        <div style="margin-bottom: 8px;"><strong>Registro:</strong> ${folio}</div>
                        <div style="margin-bottom: 12px; padding: 8px; background: white; border-radius: 8px;">
                            <strong>Cambios:</strong><br>
                            ${cambios.map(c => `‚Ä¢ ${c}`).join('<br>')}
                        </div>
                        <div style="margin-bottom: 8px;"><strong>Raz√≥n:</strong> ${razon}</div>
                        <div style="margin-bottom: 8px;"><strong>Editado por:</strong> ${usuario}</div>
                        <div><strong>Hora:</strong> ${fecha} ${hora}</div>
                    </div>
                    <p style="font-size: 13px; color: #757575; margin: 0;">La versi√≥n anterior qued√≥ marcada como EDITADA</p>
                </div>
            `;
            
            overlay.classList.add('show');
            
            setTimeout(() => {
                overlay.classList.remove('show');
                // Restaurar contenido original del overlay
                overlay.innerHTML = `
                    <div style="text-align: center;">
                        <div class="success-icon">‚úì</div>
                        <h2>¬°Guardado!</h2>
                        <p id="success-message">Registro guardado correctamente</p>
                    </div>
                `;
            }, 3500);
        }

        // ========== ELIMINAR REGISTRO CON RAZ√ìN ==========
        async function eliminarRegistro(index) {
            const registro = registrosGuardados[index];
            if (!registro || registro.eliminado) {
                alert('Registro no encontrado');
                return;
            }

            // PASO 1: Confirmar eliminaci√≥n
            if (!confirm(`üóëÔ∏è ¬øELIMINAR este registro?\n\nFolio: ${registro.folio}\nSAP: ${registro.sap}\nCantidad: ${registro.cantidad} ${registro.unidadMedida || 'PZA'}\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer\n‚ö†Ô∏è Se borrar√° para TODOS los usuarios`)) {
                return;
            }
            
            // PASO 2: Pedir RAZ√ìN (obligatorio)
            const razon = prompt(
                `¬øPOR QU√â eliminas este registro?\n\n` +
                `Folio: ${registro.folio}\n` +
                `SAP: ${registro.sap}\n\n` +
                `Ejemplos:\n` +
                `- "Duplicado con F100"\n` +
                `- "Marbete mal capturado"\n` +
                `- "Material no existe"\n\n` +
                `Escribe la raz√≥n:`
            );
            
            if (!razon || razon.trim() === '') {
                alert('‚ö†Ô∏è Debes indicar la raz√≥n de la eliminaci√≥n');
                return;
            }
            
            try {
                // Guardar en historial ANTES de eliminar
                if (!registro.versiones) {
                    registro.versiones = [];
                }
                
                registro.versiones.push({
                    version: registro.versiones.length + 1,
                    fecha: new Date().toISOString(),
                    accion: 'ELIMINADO',
                    usuario: currentRole || selectedUser,
                    razon: razon.trim(),
                    datosAnteriores: {
                        folio: registro.folio,
                        sap: registro.sap,
                        cantidad: registro.cantidad,
                        ubicacion: registro.ubicacion,
                        almacen: registro.almacen
                    }
                });
                
                // Marcar como eliminado
                registro.eliminado = true;
                registro.fechaEliminacion = new Date().toISOString();
                registro.eliminadoPor = currentRole || selectedUser;
                registro.razonEliminacion = razon.trim();
                
                // Actualizar en Firebase
                if (registro.id && window.firebaseDB) {
                    const { doc, updateDoc } = window.firebaseCollections;
                    const db = window.firebaseDB;
                    
                    await updateDoc(doc(db, 'registros', registro.id), {
                        eliminado: true,
                        fechaEliminacion: registro.fechaEliminacion,
                        eliminadoPor: registro.eliminadoPor,
                        razonEliminacion: registro.razonEliminacion,
                        versiones: registro.versiones
                    });
                }
                
                // Enviar a Google Sheets como ELIMINADO
                await enviarAGoogleSheets({
                    ...registro,
                    eliminado: true,
                    modificado: false
                });
                
                console.log('‚úÖ Registro eliminado correctamente');
                
                // OVERLAY MEJORADO
                mostrarConfirmacionEliminacion(registro.folio, razon.trim(), currentRole || selectedUser);
                
                // Recargar vistas despu√©s de 2 segundos
                setTimeout(() => {
                    renderizarMisRegistros();
                    renderizarTodosRegistros();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error al eliminar:', error);
                alert('‚ö†Ô∏è Error al eliminar:\n\n' + error.message);
            }
        }
        
        // Mostrar confirmaci√≥n visual de eliminaci√≥n
        function mostrarConfirmacionEliminacion(folio, razon, usuario) {
            const overlay = document.getElementById('success-overlay');
            const ahora = new Date();
            const hora = ahora.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'});
            const fecha = ahora.toLocaleDateString('es-MX', {day: '2-digit', month: 'short'});
            
            overlay.innerHTML = `
                <div style="text-align: center; max-width: 400px;">
                    <div style="font-size: 60px; margin-bottom: 16px;">üóëÔ∏è</div>
                    <h2 style="color: #d32f2f; margin: 0 0 8px 0; font-size: 22px;">ELIMINADO CORRECTAMENTE</h2>
                    <div style="background: #ffebee; border-radius: 12px; padding: 16px; margin: 16px 0; text-align: left; border: 2px solid #ef9a9a;">
                        <div style="margin-bottom: 8px;"><strong>Registro:</strong> ${folio}</div>
                        <div style="margin-bottom: 8px;"><strong>Raz√≥n:</strong> ${razon}</div>
                        <div style="margin-bottom: 8px;"><strong>Eliminado por:</strong> ${usuario}</div>
                        <div><strong>Hora:</strong> ${fecha} ${hora}</div>
                    </div>
                    <p style="font-size: 13px; color: #757575; margin: 0;">El registro desapareci√≥ de todas las vistas normales</p>
                </div>
            `;
            
            overlay.classList.add('show');
            
            setTimeout(() => {
                overlay.classList.remove('show');
                // Restaurar contenido original del overlay
                overlay.innerHTML = `
                    <div style="text-align: center;">
                        <div class="success-icon">‚úì</div>
                        <h2>¬°Guardado!</h2>
                        <p id="success-message">Registro guardado correctamente</p>
                    </div>
                `;
            }, 3000);
        }

        // ========== COMPARATIVO SAP VS F√çSICO ==========
        function verComparativo() {
            if (kardexSAP.length === 0) {
                alert('‚ö†Ô∏è Debes cargar el Kardex SAP primero en Auditor√≠a');
                return;
            }

            if (registrosGuardados.length === 0) {
                alert('‚ö†Ô∏è No hay registros capturados a√∫n');
                return;
            }

            // Calcular diferencias
            const diferencias = [];

            kardexSAP.forEach(itemSAP => {
                // Sumar cantidades f√≠sicas del mismo c√≥digo en el mismo almac√©n
                const registrosFisicos = registrosGuardados.filter(r => 
                    !r.eliminado && 
                    r.sap === itemSAP.codigo && 
                    r.almacen === itemSAP.almacen
                );

                const cantidadFisica = registrosFisicos.reduce((sum, r) => sum + r.cantidad, 0);
                const diferencia = cantidadFisica - itemSAP.cantidad;
                const diferenciaCosto = diferencia * itemSAP.costoUnitario;

                if (Math.abs(diferencia) > 0) {
                    diferencias.push({
                        codigo: itemSAP.codigo,
                        descripcion: itemSAP.descripcion,
                        almacen: itemSAP.almacen,
                        cantidadSAP: itemSAP.cantidad,
                        cantidadFisica: cantidadFisica,
                        diferencia: diferencia,
                        costoUnitario: itemSAP.costoUnitario,
                        diferenciaCosto: diferenciaCosto
                    });
                }
            });

            // Ordenar por mayor diferencia en costo (valor absoluto)
            diferencias.sort((a, b) => Math.abs(b.diferenciaCosto) - Math.abs(a.diferenciaCosto));

            console.log('Comparativo generado:', diferencias.length, 'diferencias encontradas');
            console.log('Top 10 diferencias:', diferencias.slice(0, 10));

            // Generar Excel con todas las diferencias
            if (confirm(`üìä Comparativo SAP vs F√≠sico\n\n${diferencias.length} diferencias encontradas\n\nTop 3:\n` + 
                diferencias.slice(0, 3).map((d, i) => 
                    `${i+1}. ${d.codigo} - Dif: ${d.diferencia.toFixed(2)} (${d.diferenciaCosto.toFixed(2)} MXN)`
                ).join('\n') +
                '\n\n¬øDeseas descargar el comparativo completo en Excel?'
            )) {
                try {
                    // Preparar datos para Excel
                    const datos = diferencias.map(d => ({
                        'C√≥digo SAP': d.codigo,
                        'Descripci√≥n': d.descripcion,
                        'Almac√©n': d.almacen,
                        'Cant. SAP': d.cantidadSAP,
                        'Cant. F√≠sica': d.cantidadFisica,
                        'Diferencia': d.diferencia,
                        'Costo Unit.': d.costoUnitario,
                        'Dif. en Costo': d.diferenciaCosto,
                        'Status': d.diferencia > 0 ? 'SOBRANTE' : 'FALTANTE'
                    }));
                    
                    // Crear workbook
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(datos);
                    
                    // Ajustar anchos
                    ws['!cols'] = [
                        {wch: 12}, {wch: 50}, {wch: 10}, {wch: 12}, 
                        {wch: 12}, {wch: 12}, {wch: 12}, {wch: 15}, {wch: 12}
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, ws, "Comparativo");
                    
                    const fecha = new Date().toISOString().split('T')[0];
                    XLSX.writeFile(wb, `Comparativo_SAP_Fisico_${fecha}.xlsx`);
                    
                    console.log('‚úì Comparativo descargado');
                } catch (error) {
                    console.error('Error al generar Excel:', error);
                    alert('‚ö†Ô∏è Error al generar el archivo');
                }
            }
        }

        // ========== VER POSITIVOS ==========
        function verPositivos() {
            const positivos = registrosGuardados.filter(r => !r.eliminado && r.esPositivo);

            if (positivos.length === 0) {
                alert('‚úì No hay positivos\n\nTodos los c√≥digos SAP capturados existen en la base de descripciones.');
                return;
            }

            console.log('Positivos encontrados:', positivos);

            if (confirm(`‚ö†Ô∏è C√≥digos no encontrados en SAP\n\n${positivos.length} positivos encontrados:\n\n` +
                positivos.slice(0, 5).map((p, i) => 
                    `${i+1}. Folio ${p.folio} - SAP: ${p.sap} - Alm: ${p.almacen}`
                ).join('\n') +
                (positivos.length > 5 ? '\n\n... y ' + (positivos.length - 5) + ' m√°s' : '') +
                '\n\n¬øDeseas descargar la lista completa en Excel?'
            )) {
                try {
                    // Preparar datos para Excel
                    const datos = positivos.map(p => ({
                        'Folio': p.folio,
                        'Almac√©n': p.almacen,
                        'C√≥digo SAP': p.sap,
                        'Cantidad': p.cantidad,
                        'Unidad': p.unidadMedida || 'PZA',
                        'Ubicaci√≥n': p.ubicacion || '',
                        'Qui√©n Cont√≥': p.nombreContador || '',
                        'Usuario': p.usuario,
                        'M√©todo': p.metodo,
                        'Fecha': new Date(p.fecha).toLocaleString('es-MX')
                    }));
                    
                    // Crear workbook
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(datos);
                    
                    // Ajustar anchos
                    ws['!cols'] = [
                        {wch: 8}, {wch: 10}, {wch: 12}, {wch: 10}, {wch: 8},
                        {wch: 15}, {wch: 20}, {wch: 20}, {wch: 10}, {wch: 20}
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, ws, "Positivos");
                    
                    const fecha = new Date().toISOString().split('T')[0];
                    XLSX.writeFile(wb, `Positivos_NoEncontrados_${fecha}.xlsx`);
                    
                    console.log('‚úì Positivos descargados');
                } catch (error) {
                    console.error('Error al generar Excel:', error);
                    alert('‚ö†Ô∏è Error al generar el archivo');
                }
            }
        }
        
        // ========== GESTIONAR DUPLICADOS ==========
        function gestionarDuplicados() {
            const duplicados = registrosGuardados.filter(r => !r.eliminado && r.esDuplicado);
            
            if (duplicados.length === 0) {
                alert('‚úì No hay duplicados\n\nTodos los registros son √∫nicos.');
                return;
            }
            
            console.log('Duplicados encontrados:', duplicados);
            
            if (confirm(`‚ö†Ô∏è Registros Duplicados\n\n${duplicados.length} duplicados encontrados:\n\n` +
                duplicados.slice(0, 5).map((d, i) => 
                    `${i+1}. ${d.folio} - SAP: ${d.sap} - ${d.usuario}`
                ).join('\n') +
                (duplicados.length > 5 ? '\n\n... y ' + (duplicados.length - 5) + ' m√°s' : '') +
                '\n\n¬øDeseas descargar la lista completa en Excel?'
            )) {
                try {
                    const datos = duplicados.map(d => ({
                        'Folio': d.folio,
                        'Almac√©n': d.almacen,
                        'C√≥digo SAP': d.sap,
                        'Descripci√≥n': d.desc,
                        'Cantidad': d.cantidad,
                        'Unidad': d.unidadMedida || 'PZA',
                        'Ubicaci√≥n': d.ubicacion || '',
                        'Qui√©n Cont√≥': d.nombreContador || '',
                        'Usuario': d.usuario,
                        'Continu√≥': d.continuoDespuesAlerta ? 'S√ç' : 'NO',
                        'Fecha': new Date(d.fecha).toLocaleString('es-MX')
                    }));
                    
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(datos);
                    
                    ws['!cols'] = [
                        {wch: 8}, {wch: 10}, {wch: 12}, {wch: 50}, {wch: 10},
                        {wch: 8}, {wch: 15}, {wch: 20}, {wch: 20}, {wch: 10}, {wch: 20}
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, ws, "Duplicados");
                    
                    const fecha = new Date().toISOString().split('T')[0];
                    XLSX.writeFile(wb, `Registros_Duplicados_${fecha}.xlsx`);
                    
                    console.log('‚úì Duplicados descargados');
                } catch (error) {
                    console.error('Error al generar Excel:', error);
                    alert('‚ö†Ô∏è Error al generar el archivo');
                }
            }
        }

        // ========== BLOQUEO DE ALMACENES ==========
        async function toggleBloqueoAlmacen(almacen) {
            const checkbox = document.getElementById('bloqueo-' + almacen);
            almacenesBloqueados[almacen] = checkbox.checked;
            
            try {
                // Guardar estado en Firebase
                const { collection, addDoc } = window.firebaseCollections;
                const db = window.firebaseDB;
                
                await addDoc(collection(db, 'control_almacenes'), {
                    almacen: almacen,
                    bloqueado: checkbox.checked,
                    timestamp: new Date().toISOString(),
                    usuario: currentRole || selectedUser
                });
                
                if (checkbox.checked) {
                    alert(`üîí Almac√©n ${almacen} BLOQUEADO\n\nYa no se pueden agregar nuevos registros del primer conteo a este almac√©n.`);
                } else {
                    alert(`üîì Almac√©n ${almacen} DESBLOQUEADO\n\nSe pueden agregar registros nuevamente.`);
                }
            } catch (error) {
                console.error('Error al actualizar estado de almac√©n:', error);
                alert('‚ö†Ô∏è Error al sincronizar. Verifica tu conexi√≥n.');
            }
        }

        // ========== SEGUNDO CONTEO ==========
        function liberarSegundoConteo(almacen) {
            if (kardexSAP.length === 0) {
                alert('‚ö†Ô∏è Debes cargar el Kardex SAP primero');
                return;
            }

            if (confirm(`¬øLiberar segundo conteo para almac√©n ${almacen}?\n\nEsto har√° lo siguiente:\n1. Bloquear√° el primer conteo de este almac√©n\n2. Generar√° lista de art√≠culos a recontar\n3. Los usuarios ver√°n "Segundo Conteo" en su men√∫`)) {
                
                // Bloquear primer conteo autom√°ticamente
                almacenesBloqueados[almacen] = true;
                document.getElementById('bloqueo-' + almacen).checked = true;
                
                // Marcar como liberado
                segundoConteoLiberado[almacen] = true;
                
                // Calcular art√≠culos a recontar
                const articulosRecontar = calcularArticulosRecontar(almacen);
                
                // Actualizar UI
                document.getElementById('status-2do-' + almacen).innerHTML = 
                    `‚úÖ Liberado (${articulosRecontar.length} art√≠culos a verificar)`;
                
                alert(`‚úì Segundo conteo liberado\n\n${articulosRecontar.length} art√≠culos requieren verificaci√≥n:\n- Diferencias de cantidad\n- No escaneados\n\nLos usuarios ya pueden acceder a "Segundo Conteo"`);
                
                console.log('Art√≠culos a recontar:', articulosRecontar);
            }
        }

        function calcularArticulosRecontar(almacen) {
            const articulosRecontar = [];
            
            // Recorrer Kardex del almac√©n
            kardexSAP.forEach(itemKardex => {
                if (itemKardex.almacen !== almacen) return;
                
                // Buscar registros f√≠sicos
                const registrosFisicos = registrosGuardados.filter(r => 
                    !r.eliminado && 
                    r.sap === itemKardex.codigo && 
                    r.almacen === almacen
                );
                
                const cantidadFisica = registrosFisicos.reduce((sum, r) => sum + r.cantidad, 0);
                const diferencia = cantidadFisica - itemKardex.cantidad;
                
                // Agregar si hay diferencia o no fue escaneado
                if (registrosFisicos.length === 0) {
                    // NO ESCANEADO
                    articulosRecontar.push({
                        codigo: itemKardex.codigo,
                        descripcion: itemKardex.descripcion,
                        cantidadKardex: itemKardex.cantidad,
                        cantidadFisica: 0,
                        tipo: 'NO_ESCANEADO'
                    });
                } else if (Math.abs(diferencia) > 0) {
                    // DIFERENCIA
                    articulosRecontar.push({
                        codigo: itemKardex.codigo,
                        descripcion: itemKardex.descripcion,
                        cantidadKardex: itemKardex.cantidad,
                        cantidadFisica: cantidadFisica,
                        diferencia: diferencia,
                        tipo: 'DIFERENCIA'
                    });
                }
            });
            
            return articulosRecontar;
        }

        // ========== RENDERIZAR MIS REGISTROS ==========
        // ========== RENDERIZAR MIS REGISTROS CON FILTROS ==========
        let filtroMisRegistros = 'activos'; // 'activos' | 'editados'
        
        function filtrarMisRegistrosPorTipo(tipo) {
            filtroMisRegistros = tipo;
            
            // Actualizar pesta√±as activas
            document.querySelectorAll('#screen-mis-registros .filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Renderizar
            renderizarMisRegistros();
        }
        
        function renderizarMisRegistros() {
            // FILTRAR seg√∫n pesta√±a activa
            let misRegistros = registrosGuardados.filter(r => 
                r.usuario === selectedUser && 
                !r.eliminado
            );
            
            // Aplicar filtro de tipo
            if (filtroMisRegistros === 'activos') {
                misRegistros = misRegistros.filter(r => !r.modificado);
            } else if (filtroMisRegistros === 'editados') {
                misRegistros = misRegistros.filter(r => r.modificado);
            }
            
            const container = document.getElementById('container-mis-registros');
            const count = document.getElementById('count-mis-registros');
            
            if (!container) return;
            
            // Actualizar contador
            count.textContent = `${misRegistros.length} registro${misRegistros.length !== 1 ? 's' : ''}`;
            
            if (misRegistros.length === 0) {
                const mensaje = filtroMisRegistros === 'editados' 
                    ? 'No tienes registros editados' 
                    : 'No hay registros activos';
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: #9e9e9e;">${mensaje}</div>`;
                return;
            }
            
            // Agrupar por folio para mostrar solo el m√°s reciente
            const registrosPorFolio = {};
            misRegistros.forEach(r => {
                const key = `${r.folio}-${r.almacen}-${r.sap}`;
                if (!registrosPorFolio[key] || new Date(r.fecha) > new Date(registrosPorFolio[key].fecha)) {
                    registrosPorFolio[key] = r;
                }
            });
            
            const registrosFinales = Object.values(registrosPorFolio);
            
            container.innerHTML = registrosFinales.map((r, index) => {
                let estadoVisual = '';
                let iconoEstado = '';
                
                if (r.modificado) {
                    // EDITADO
                    estadoVisual = '<span class="registro-badge" style="background: #ff9800; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;">‚úèÔ∏è EDITADO</span>';
                    iconoEstado = 'üü°';
                } else {
                    // ACTIVO
                    iconoEstado = 'üü¢';
                }
                
                if (r.esDuplicado) {
                    estadoVisual += ' <span class="registro-badge" style="background: #f44336; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;">‚ö†Ô∏è DUPLICADO</span>';
                }
                
                // Botones de acci√≥n
                const botonesAccion = `<div class="registro-actions">
                    <button class="btn-icon" onclick="editarRegistro(${registrosGuardados.indexOf(r)})" title="Editar">‚úèÔ∏è</button>
                    <button class="btn-icon delete" onclick="eliminarRegistro(${registrosGuardados.indexOf(r)})" title="Eliminar">üóëÔ∏è</button>
                </div>`;
                
                return `
                <div class="registro-card" style="position: relative;">
                    <div style="position: absolute; top: 12px; left: 12px; font-size: 24px;">${iconoEstado}</div>
                    <div class="registro-header" style="padding-left: 40px;">
                        <span class="registro-folio">${r.folio}</span>
                        <span class="registro-badge almacen">üì¶ ${r.almacen}</span>
                        ${estadoVisual}
                    </div>
                    <p class="registro-sap" style="padding-left: 40px;">${r.sap}</p>
                    <p class="registro-desc" style="padding-left: 40px;">${r.desc}</p>
                    <div class="registro-meta" style="padding-left: 40px;">
                        <span>Cant: <strong>${r.cantidad} ${r.unidadMedida || 'PZA'}</strong></span>
                        <span>Ubic: <strong>${r.ubicacion || 'N/A'}</strong></span>
                        ${botonesAccion}
                    </div>
                    ${r.razonEdicion ? `
                        <div style="background: #fff3e0; border-radius: 8px; padding: 8px; margin: 8px 0 0 40px; font-size: 12px; border-left: 3px solid #ff9800;">
                            <strong>Raz√≥n de edici√≥n:</strong> ${r.razonEdicion}
                        </div>
                    ` : ''}
                    <div style="font-size: 11px; color: #9e9e9e; margin-top: 8px; padding-left: 40px;">
                        ${r.metodo === 'QR' ? 'üì±' : '‚úçÔ∏è'} ${r.metodo} ‚Ä¢ ${r.nombreContador || 'N/A'} ‚Ä¢ ${new Date(r.fecha).toLocaleString('es-MX', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'})}
                    </div>
                </div>
            `}).join('');
        }
        
        // ========== RENDERIZAR TODOS LOS REGISTROS (AUDITOR√çA/MESA) ==========
        function renderizarTodosRegistros() {
            console.log('üîç Renderizando Todos los Registros...');
            console.log('üìä Total en sistema:', registrosGuardados.length);
            
            const container = document.getElementById('container-todos-registros');
            const count = document.getElementById('count-registros');
            
            if (!container) {
                console.error('‚ùå Container no encontrado');
                return;
            }
            
            // Si no hay datos a√∫n, mostrar mensaje de carga
            if (registrosGuardados.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #9e9e9e;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                        <div style="font-size: 16px; color: #424242; margin-bottom: 8px;">Cargando registros...</div>
                        <div style="font-size: 13px;">Si no aparecen datos en 5 segundos, recarga la p√°gina.</div>
                    </div>
                `;
                count.textContent = '0 registros';
                
                // Reintentar despu√©s de 2 segundos
                setTimeout(() => {
                    if (document.getElementById('screen-registros').classList.contains('active')) {
                        renderizarTodosRegistros();
                    }
                }, 2000);
                return;
            }
            
            // Filtrar registros ACTIVOS (no eliminados ni modificados)
            const todosRegistros = registrosGuardados.filter(r => !r.eliminado && !r.modificado && r.almacen !== '00');
            
            console.log('‚úÖ Registros activos:', todosRegistros.length);
            console.log('üóëÔ∏è Eliminados:', registrosGuardados.filter(r => r.eliminado).length);
            console.log('‚úèÔ∏è Modificados:', registrosGuardados.filter(r => r.modificado).length);
            
            count.textContent = `${todosRegistros.length} registros activos`;
            
            if (todosRegistros.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #9e9e9e;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                        <div style="font-size: 16px; color: #424242; margin-bottom: 8px;">No hay registros activos</div>
                        <div style="font-size: 13px;">Total en sistema: ${registrosGuardados.length}</div>
                        <div style="font-size: 13px; color: #757575; margin-top: 8px;">
                            (Eliminados: ${registrosGuardados.filter(r => r.eliminado).length} | 
                            Editados: ${registrosGuardados.filter(r => r.modificado).length})
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = todosRegistros.map((r, index) => {
                // Determinar √≠cono de estado
                let iconoEstado = 'üü¢'; // ACTIVO por defecto
                let estadoVisual = '';
                
                // Buscar si hay versi√≥n m√°s nueva de este registro
                const hayVersionNueva = registrosGuardados.some(newer => 
                    newer.folio === r.folio && 
                    newer.almacen === r.almacen && 
                    newer.sap === r.sap && 
                    !newer.eliminado && 
                    !newer.modificado &&
                    new Date(newer.fecha) > new Date(r.fecha)
                );
                
                if (hayVersionNueva) {
                    iconoEstado = 'üü°';
                    estadoVisual = '<span class="registro-badge" style="background: #ff9800; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;">‚úèÔ∏è EDITADO</span>';
                }
                
                return `
                <div class="registro-card" style="position: relative;">
                    <div style="position: absolute; top: 12px; left: 12px; font-size: 24px;">${iconoEstado}</div>
                    <div class="registro-header" style="padding-left: 40px;">
                        <span class="registro-folio">${r.folio}</span>
                        <span class="registro-badge almacen">üì¶ ${r.almacen}</span>
                        ${estadoVisual}
                        ${r.esDuplicado ? '<span class="registro-badge duplicado">DUPLICADO</span>' : ''}
                        ${r.esPositivo ? '<span class="registro-badge positivo">POSITIVO</span>' : ''}
                    </div>
                    <p class="registro-sap" style="padding-left: 40px;">${r.sap}</p>
                    <p class="registro-desc" style="padding-left: 40px;">${r.desc}</p>
                    <div class="registro-meta" style="padding-left: 40px;">
                        <span>Cant: <strong>${r.cantidad} ${r.unidadMedida || 'PZA'}</strong></span>
                        <span>Ubic: <strong>${r.ubicacion || 'N/A'}</strong></span>
                        <div class="registro-actions">
                            <button class="btn-icon" onclick="editarRegistro(${registrosGuardados.indexOf(r)})">‚úèÔ∏è</button>
                            <button class="btn-icon delete" onclick="eliminarRegistro(${registrosGuardados.indexOf(r)})">üóëÔ∏è</button>
                        </div>
                    </div>
                    ${r.razonEdicion ? `
                        <div style="background: #fff3e0; border-radius: 8px; padding: 8px; margin: 8px 0 0 40px; font-size: 12px; border-left: 3px solid #ff9800;">
                            <strong>Raz√≥n de edici√≥n:</strong> ${r.razonEdicion}
                        </div>
                    ` : ''}
                    ${r.razonEliminacion ? `
                        <div style="background: #ffebee; border-radius: 8px; padding: 8px; margin: 8px 0 0 40px; font-size: 12px; border-left: 3px solid #f44336;">
                            <strong>Raz√≥n de eliminaci√≥n:</strong> ${r.razonEliminacion}
                        </div>
                    ` : ''}
                    <div style="font-size: 11px; color: #9e9e9e; margin-top: 8px; padding-left: 40px;">
                        üë§ ${r.usuario} ‚Ä¢ ${r.metodo === 'QR' ? 'üì±' : '‚úçÔ∏è'} ${r.metodo} ‚Ä¢ ${r.nombreContador || 'N/A'} ‚Ä¢ ${new Date(r.fecha).toLocaleString('es-MX', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'})}
                    </div>
                    ${r.esDuplicado ? '<div class="registro-nota" style="margin-left: 40px;"><strong>‚ö†Ô∏è DUPLICADO</strong> - Usuario continu√≥ despu√©s de alerta</div>' : ''}
                </div>
            `}).join('');
        }

        // ========== DESCARGAS ==========
        function descargarPrimerConteo() {
            if (registrosGuardados.filter(r => !r.eliminado && !r.modificado && r.almacen !== '00').length === 0) {
                alert('‚ö†Ô∏è No hay registros para descargar');
                return;
            }
            
            try {
                // Preparar datos para Excel
                const datos = registrosGuardados.filter(r => !r.eliminado && !r.modificado && r.almacen !== '00').map(r => ({
                    'Folio': r.folio,
                    'Almac√©n': r.almacen,
                    'C√≥digo SAP': r.sap,
                    'Descripci√≥n': r.desc,
                    'Cantidad': r.cantidad,
                    'Unidad': r.unidadMedida || 'PZA',
                    'Ubicaci√≥n': r.ubicacion || '',
                    'Qui√©n Cont√≥': r.nombreContador || '',
                    'Usuario Sistema': r.usuario,
                    'M√©todo': r.metodo,
                    'Duplicado': r.esDuplicado ? 'S√ç' : 'NO',
                    'Positivo': r.esPositivo ? 'S√ç' : 'NO',
                    'Fecha': new Date(r.fecha).toLocaleString('es-MX')
                }));
                
                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(datos);
                
                // Ajustar anchos de columna
                ws['!cols'] = [
                    {wch: 8},  // Folio
                    {wch: 10}, // Almac√©n
                    {wch: 12}, // SAP
                    {wch: 50}, // Descripci√≥n
                    {wch: 10}, // Cantidad
                    {wch: 8},  // Unidad
                    {wch: 15}, // Ubicaci√≥n
                    {wch: 20}, // Qui√©n Cont√≥
                    {wch: 20}, // Usuario
                    {wch: 10}, // M√©todo
                    {wch: 10}, // Duplicado
                    {wch: 10}, // Positivo
                    {wch: 20}  // Fecha
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, "Primer Conteo");
                
                // Descargar archivo
                const fecha = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Inventario_PrimerConteo_${fecha}.xlsx`);
                
                console.log('‚úì Excel descargado:', datos.length, 'registros');
                
            } catch (error) {
                console.error('Error al generar Excel:', error);
                alert('‚ö†Ô∏è Error al generar el archivo. Verifica que XLSX est√© cargado.');
            }
        }

        function descargarSegundoConteo() {
            if (registrosSegundoConteo.filter(r => !r.eliminado && !r.modificado && r.almacen !== '00').length === 0) {
                alert('‚ö†Ô∏è No hay registros de segundo conteo para descargar');
                return;
            }
            
            try {
                // Preparar datos para Excel
                const datos = registrosSegundoConteo.filter(r => !r.eliminado && !r.modificado && r.almacen !== '00').map(r => ({
                    'Folio': r.folio,
                    'Almac√©n': r.almacen,
                    'C√≥digo SAP': r.sap,
                    'Descripci√≥n': r.desc,
                    'Cantidad': r.cantidad,
                    'Unidad': r.unidadMedida || 'PZA',
                    'Ubicaci√≥n': r.ubicacion || '',
                    'Qui√©n Cont√≥': r.nombreContador || '',
                    'Usuario Sistema': r.usuario,
                    'M√©todo': r.metodo,
                    'Duplicado': r.esDuplicado ? 'S√ç' : 'NO',
                    'Positivo': r.esPositivo ? 'S√ç' : 'NO',
                    'Fecha': new Date(r.fecha).toLocaleString('es-MX')
                }));
                
                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(datos);
                
                // Ajustar anchos de columna
                ws['!cols'] = [
                    {wch: 8}, {wch: 10}, {wch: 12}, {wch: 50}, {wch: 10}, 
                    {wch: 8}, {wch: 15}, {wch: 20}, {wch: 20}, {wch: 10},
                    {wch: 10}, {wch: 10}, {wch: 20}
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, "Segundo Conteo");
                
                // Descargar archivo
                const fecha = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Inventario_SegundoConteo_${fecha}.xlsx`);
                
                console.log('‚úì Excel descargado:', datos.length, 'registros');
                
            } catch (error) {
                console.error('Error al generar Excel:', error);
                alert('‚ö†Ô∏è Error al generar el archivo. Verifica que XLSX est√© cargado.');
            }
        }
        
        // ========== REPORTES NUEVOS ==========
        
        // 3. Reporte de Duplicados
        function descargarDuplicados() {
            const registrosActivos = registrosGuardados.filter(r => !r.eliminado && !r.modificado && r.almacen !== '00');
            
            // Detectar duplicados
            const duplicados = [];
            const vistosMap = {};
            
            registrosActivos.forEach(r => {
                const key = `${r.folio}_${r.almacen}_${r.sap}`;
                if (vistosMap[key]) {
                    duplicados.push({
                        'Folio': r.folio,
                        'Almac√©n': r.almacen,
                        'SAP': r.sap,
                        'Descripci√≥n': r.desc,
                        'Cantidad 1': vistosMap[key].cantidad,
                        'Usuario 1': vistosMap[key].usuario,
                        'Fecha 1': new Date(vistosMap[key].fecha).toLocaleString('es-MX'),
                        'Cantidad 2': r.cantidad,
                        'Usuario 2': r.usuario,
                        'Fecha 2': new Date(r.fecha).toLocaleString('es-MX'),
                        'Diferencia': Math.abs(r.cantidad - vistosMap[key].cantidad)
                    });
                } else {
                    vistosMap[key] = r;
                }
            });
            
            if (duplicados.length === 0) {
                alert('‚úÖ No hay duplicados');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(duplicados);
            ws['!cols'] = [{wch:8},{wch:10},{wch:12},{wch:40},{wch:12},{wch:25},{wch:20},{wch:12},{wch:25},{wch:20},{wch:12}];
            XLSX.utils.book_append_sheet(wb, ws, "Duplicados");
            XLSX.writeFile(wb, `Reporte_Duplicados_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // 4. Reporte de Positivos
        function descargarPositivos() {
            const positivos = registrosGuardados.filter(r => !r.eliminado && r.esPositivo).map(r => ({
                'SAP': r.sap,
                'Descripci√≥n Capturada': r.desc,
                'Almac√©n': r.almacen,
                'Folio': r.folio,
                'Cantidad': r.cantidad,
                'Unidad': r.unidadMedida || 'PZA',
                'Ubicaci√≥n': r.ubicacion || '',
                'Usuario': r.usuario,
                'Fecha': new Date(r.fecha).toLocaleString('es-MX')
            }));
            
            if (positivos.length === 0) {
                alert('‚úÖ No hay positivos');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(positivos);
            ws['!cols'] = [{wch:12},{wch:50},{wch:10},{wch:8},{wch:12},{wch:8},{wch:15},{wch:25},{wch:20}];
            XLSX.utils.book_append_sheet(wb, ws, "Positivos");
            XLSX.writeFile(wb, `Reporte_Positivos_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // 5. Reporte de Auditor√≠as de Conteo
        function descargarAuditoriasConteo() {
            if (validacionesAuditoria.length === 0) {
                alert('‚ö†Ô∏è No hay auditor√≠as de conteo registradas');
                return;
            }
            
            const datos = validacionesAuditoria.map(v => ({
                'SAP': v.sap,
                'Descripci√≥n': v.desc,
                'Almac√©n': v.almacen,
                'Folio': v.folio,
                'Cantidad Original': v.cantidadOriginal,
                'Cantidad Validada': v.cantidadValidada,
                'Diferencia': v.diferencia,
                '% Diferencia': v.porcentajeDif + '%',
                'Estado': v.diferencia === 0 ? 'OK' : 'CON DIFERENCIA',
                'Auditor': v.auditor,
                'Observaciones': v.observaciones || '',
                'Fecha Validaci√≥n': new Date(v.fecha).toLocaleString('es-MX')
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datos);
            ws['!cols'] = [{wch:12},{wch:40},{wch:10},{wch:8},{wch:15},{wch:15},{wch:12},{wch:12},{wch:15},{wch:25},{wch:30},{wch:20}];
            XLSX.utils.book_append_sheet(wb, ws, "Auditor√≠as");
            XLSX.writeFile(wb, `Reporte_Auditorias_Conteo_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // 6. Comparativo SAP vs F√≠sico
        function descargarComparativoSAP() {
            if (kardexSAP.length === 0) {
                alert('‚ö†Ô∏è Primero carga el Kardex SAP');
                return;
            }
            
            const comparativo = [];
            const registrosActivos = registrosGuardados.filter(r => !r.eliminado && !r.modificado && r.almacen !== '00');
            
            // Agrupar f√≠sico por SAP
            const fisicoMap = {};
            registrosActivos.forEach(r => {
                const key = `${r.sap}_${r.almacen}`;
                if (!fisicoMap[key]) {
                    fisicoMap[key] = { cantidad: 0, sap: r.sap, almacen: r.almacen, desc: r.desc };
                }
                fisicoMap[key].cantidad += r.cantidad;
            });
            
            // Comparar con Kardex
            kardexSAP.forEach(k => {
                const key = `${k.codigo}_${k.almacen}`;
                const fisico = fisicoMap[key] || { cantidad: 0 };
                const diferencia = fisico.cantidad - (k.cantidad || 0);
                const pctDif = k.cantidad > 0 ? ((diferencia / k.cantidad) * 100).toFixed(2) : 0;
                
                // Obtener costos
                const costoUnit = k.costoUnitario || 0;
                const valorKardex = (k.cantidad || 0) * costoUnit;
                const valorFisico = fisico.cantidad * costoUnit;
                const valorDiferencia = diferencia * costoUnit;
                
                comparativo.push({
                    'SAP': k.codigo,
                    'Descripci√≥n': k.descripcion,
                    'Almac√©n': k.almacen,
                    'Unidad': k.unidadMedida || 'PZA',
                    'Cant. Kardex': k.cantidad || 0,
                    'Cant. F√≠sica': fisico.cantidad,
                    'Diferencia': diferencia,
                    '% Diferencia': pctDif + '%',
                    'Costo Unitario': costoUnit,
                    'Valor Kardex': valorKardex.toFixed(2),
                    'Valor F√≠sico': valorFisico.toFixed(2),
                    'Valor Diferencia': valorDiferencia.toFixed(2),
                    'Estado': diferencia < 0 ? 'FALTANTE' : diferencia > 0 ? 'SOBRANTE' : 'OK'
                });
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(comparativo);
            ws['!cols'] = [{wch:12},{wch:40},{wch:10},{wch:8},{wch:12},{wch:12},{wch:12},{wch:12},{wch:15},{wch:15},{wch:15},{wch:15},{wch:12}];
            XLSX.utils.book_append_sheet(wb, ws, "Comparativo");
            XLSX.writeFile(wb, `Comparativo_SAP_vs_Fisico_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // 7. Diferencias Significativas
        function descargarDiferenciasSignificativas() {
            if (validacionesAuditoria.length === 0) {
                alert('‚ö†Ô∏è No hay auditor√≠as de conteo registradas');
                return;
            }
            
            // Filtrar solo diferencias > 5% o > 10 unidades
            const significativas = validacionesAuditoria.filter(v => 
                Math.abs(v.diferencia) > 10 || Math.abs(parseFloat(v.porcentajeDif)) > 5
            ).map(v => {
                // Buscar costo en Kardex
                const itemKardex = kardexSAP.find(k => k.codigo === v.sap && k.almacen === v.almacen);
                const costoUnit = itemKardex ? (itemKardex.costoUnitario || 0) : 0;
                const valorDif = v.diferencia * costoUnit;
                
                return {
                    'SAP': v.sap,
                    'Descripci√≥n': v.desc,
                    'Almac√©n': v.almacen,
                    'Folio': v.folio,
                    'Cantidad Capturada': v.cantidadOriginal,
                    'Cantidad Validada': v.cantidadValidada,
                    'Diferencia': v.diferencia,
                    '% Diferencia': v.porcentajeDif + '%',
                    'Costo Unitario': costoUnit,
                    'Valor Diferencia': valorDif.toFixed(2),
                    'Auditor': v.auditor,
                    'Observaciones': v.observaciones || '',
                    'Fecha': new Date(v.fecha).toLocaleString('es-MX')
                };
            });
            
            if (significativas.length === 0) {
                alert('‚úÖ No hay diferencias significativas (>5% o >10 unidades)');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(significativas);
            ws['!cols'] = [{wch:12},{wch:40},{wch:10},{wch:8},{wch:15},{wch:15},{wch:12},{wch:12},{wch:15},{wch:15},{wch:25},{wch:30},{wch:20}];
            XLSX.utils.book_append_sheet(wb, ws, "Diferencias");
            XLSX.writeFile(wb, `Diferencias_Significativas_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // 8. Avance por Almac√©n
        function descargarAvancePorAlmacen() {
            const registrosActivos = registrosGuardados.filter(r => !r.eliminado && !r.modificado && r.almacen !== '00');
            
            const almacenes = {
                '00': { nombre: '00 - L√≠neas Producci√≥n', capturados: 0, esperados: 0, positivos: 0, duplicados: 0, usuarios: new Set() },
                '01': { nombre: '01 - Resto Materia Prima', capturados: 0, esperados: 0, positivos: 0, duplicados: 0, usuarios: new Set() },
                '30': { nombre: '30 - Transformadores', capturados: 0, esperados: 0, positivos: 0, duplicados: 0, usuarios: new Set() },
                '31': { nombre: '31 - Placas', capturados: 0, esperados: 0, positivos: 0, duplicados: 0, usuarios: new Set() },
                '32': { nombre: '32 - Arneses', capturados: 0, esperados: 0, positivos: 0, duplicados: 0, usuarios: new Set() },
                '33': { nombre: '33 - Gabinetes', capturados: 0, esperados: 0, positivos: 0, duplicados: 0, usuarios: new Set() },
                'MAQUILA': { nombre: 'MAQUILA', capturados: 0, esperados: 0, positivos: 0, duplicados: 0, usuarios: new Set() }
            };
            
            // Contar capturados
            registrosActivos.forEach(r => {
                if (almacenes[r.almacen]) {
                    almacenes[r.almacen].capturados++;
                    if (r.esPositivo) almacenes[r.almacen].positivos++;
                    if (r.esDuplicado) almacenes[r.almacen].duplicados++;
                    almacenes[r.almacen].usuarios.add(r.usuario);
                }
            });
            
            // Contar esperados del Kardex
            if (kardexSAP.length > 0) {
                kardexSAP.forEach(k => {
                    if (almacenes[k.almacen]) {
                        almacenes[k.almacen].esperados++;
                    }
                });
            }
            
            const datos = Object.entries(almacenes).map(([cod, a]) => ({
                'Almac√©n': a.nombre,
                'Art√≠culos Capturados': a.capturados,
                'Art√≠culos Esperados': a.esperados,
                '% Avance': a.esperados > 0 ? ((a.capturados / a.esperados) * 100).toFixed(1) + '%' : 'N/A',
                'Positivos': a.positivos,
                'Duplicados': a.duplicados,
                'Usuarios Activos': a.usuarios.size
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datos);
            ws['!cols'] = [{wch:25},{wch:18},{wch:18},{wch:12},{wch:12},{wch:12},{wch:15}];
            XLSX.utils.book_append_sheet(wb, ws, "Avance por Almac√©n");
            XLSX.writeFile(wb, `Avance_por_Almacen_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // 9. Resumen por Auditor
        function descargarResumenAuditores() {
            if (sapsAuditoria.length === 0) {
                alert('‚ö†Ô∏è No hay SAPs asignados a auditores');
                return;
            }
            
            const resumen = {};
            
            sapsAuditoria.forEach(s => {
                if (!resumen[s.auditor]) {
                    resumen[s.auditor] = {
                        auditor: s.auditor,
                        almacen: s.almacen,
                        totalAsignados: 0,
                        validados: 0,
                        foliosValidados: 0,
                        foliosConDiferencia: 0
                    };
                }
                resumen[s.auditor].totalAsignados++;
                if (s.validado) resumen[s.auditor].validados++;
            });
            
            // Contar folios validados
            validacionesAuditoria.forEach(v => {
                if (resumen[v.auditor]) {
                    resumen[v.auditor].foliosValidados++;
                    if (v.diferencia !== 0) resumen[v.auditor].foliosConDiferencia++;
                }
            });
            
            const datos = Object.values(resumen).map(r => ({
                'Auditor': r.auditor,
                'Almac√©n': r.almacen,
                'SAPs Asignados': r.totalAsignados,
                'SAPs Validados': r.validados,
                '% Completitud': r.totalAsignados > 0 ? ((r.validados / r.totalAsignados) * 100).toFixed(1) + '%' : '0%',
                'Folios Validados': r.foliosValidados,
                'Folios con Diferencia': r.foliosConDiferencia,
                '% Exactitud': r.foliosValidados > 0 ? (((r.foliosValidados - r.foliosConDiferencia) / r.foliosValidados) * 100).toFixed(1) + '%' : '100%'
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datos);
            ws['!cols'] = [{wch:35},{wch:25},{wch:15},{wch:15},{wch:15},{wch:15},{wch:18},{wch:12}];
            XLSX.utils.book_append_sheet(wb, ws, "Resumen Auditores");
            XLSX.writeFile(wb, `Resumen_Auditores_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // 10. Dashboard Ejecutivo (Todo en Uno)
        function descargarDashboardEjecutivo() {
            const wb = XLSX.utils.book_new();
            const registrosActivos = registrosGuardados.filter(r => !r.eliminado && !r.modificado && r.almacen !== '00');
            
            // PESTA√ëA 1: Resumen General
            const resumenGeneral = [{
                'M√©trica': 'Total Art√≠culos Capturados',
                'Valor': registrosActivos.length
            }, {
                'M√©trica': 'Total Esperado (Kardex)',
                'Valor': kardexSAP.length
            }, {
                'M√©trica': '% Avance General',
                'Valor': kardexSAP.length > 0 ? ((registrosActivos.length / kardexSAP.length) * 100).toFixed(1) + '%' : 'N/A'
            }, {
                'M√©trica': 'Total Positivos',
                'Valor': registrosActivos.filter(r => r.esPositivo).length
            }, {
                'M√©trica': 'Total Duplicados',
                'Valor': registrosActivos.filter(r => r.esDuplicado).length
            }, {
                'M√©trica': 'Total Auditor√≠as Realizadas',
                'Valor': validacionesAuditoria.length
            }, {
                'M√©trica': 'Auditor√≠as con Diferencia',
                'Valor': validacionesAuditoria.filter(v => v.diferencia !== 0).length
            }];
            
            const ws1 = XLSX.utils.json_to_sheet(resumenGeneral);
            ws1['!cols'] = [{wch:35},{wch:20}];
            XLSX.utils.book_append_sheet(wb, ws1, "Resumen General");
            
            // PESTA√ëA 2: Avance por Almac√©n (reutilizar l√≥gica)
            const almacenes = {
                '00': { nombre: '00 - L√≠neas', cap: 0, esp: 0 },
                '01': { nombre: '01 - MP', cap: 0, esp: 0 },
                '30': { nombre: '30 - Transformadores', cap: 0, esp: 0 },
                '31': { nombre: '31 - Placas', cap: 0, esp: 0 },
                '32': { nombre: '32 - Arneses', cap: 0, esp: 0 },
                '33': { nombre: '33 - Gabinetes', cap: 0, esp: 0 }
            };
            
            registrosActivos.forEach(r => {
                if (almacenes[r.almacen]) almacenes[r.almacen].cap++;
            });
            
            kardexSAP.forEach(k => {
                if (almacenes[k.almacen]) almacenes[k.almacen].esp++;
            });
            
            const avanceAlm = Object.values(almacenes).map(a => ({
                'Almac√©n': a.nombre,
                'Capturados': a.cap,
                'Esperados': a.esp,
                '% Avance': a.esp > 0 ? ((a.cap / a.esp) * 100).toFixed(1) + '%' : 'N/A'
            }));
            
            const ws2 = XLSX.utils.json_to_sheet(avanceAlm);
            ws2['!cols'] = [{wch:20},{wch:12},{wch:12},{wch:12}];
            XLSX.utils.book_append_sheet(wb, ws2, "Avance por Almac√©n");
            
            // PESTA√ëA 3: Top 10 Usuarios
            const usuarioStats = {};
            registrosActivos.forEach(r => {
                if (!usuarioStats[r.usuario]) usuarioStats[r.usuario] = 0;
                usuarioStats[r.usuario]++;
            });
            
            const top10 = Object.entries(usuarioStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([usuario, cantidad], index) => ({
                    'Posici√≥n': index + 1,
                    'Usuario': usuario,
                    'Total Capturado': cantidad,
                    '% del Total': ((cantidad / registrosActivos.length) * 100).toFixed(1) + '%'
                }));
            
            const ws3 = XLSX.utils.json_to_sheet(top10);
            ws3['!cols'] = [{wch:10},{wch:35},{wch:15},{wch:12}];
            XLSX.utils.book_append_sheet(wb, ws3, "Top 10 Usuarios");
            
            // PESTA√ëA 4: Positivos (resumen)
            const positivos = registrosActivos.filter(r => r.esPositivo).map(r => ({
                'SAP': r.sap,
                'Descripci√≥n': r.desc,
                'Almac√©n': r.almacen,
                'Cantidad': r.cantidad
            }));
            
            if (positivos.length > 0) {
                const ws4 = XLSX.utils.json_to_sheet(positivos);
                ws4['!cols'] = [{wch:12},{wch:40},{wch:10},{wch:12}];
                XLSX.utils.book_append_sheet(wb, ws4, "Positivos");
            }
            
            // PESTA√ëA 5: Diferencias Auditor√≠a
            const difSignificativas = validacionesAuditoria.filter(v => 
                Math.abs(v.diferencia) > 10 || Math.abs(parseFloat(v.porcentajeDif)) > 5
            ).map(v => ({
                'SAP': v.sap,
                'Folio': v.folio,
                'Original': v.cantidadOriginal,
                'Validada': v.cantidadValidada,
                'Diferencia': v.diferencia,
                '% Dif': v.porcentajeDif + '%'
            }));
            
            if (difSignificativas.length > 0) {
                const ws5 = XLSX.utils.json_to_sheet(difSignificativas);
                ws5['!cols'] = [{wch:12},{wch:8},{wch:12},{wch:12},{wch:12},{wch:10}];
                XLSX.utils.book_append_sheet(wb, ws5, "Diferencias Auditor√≠a");
            }
            
            XLSX.writeFile(wb, `Dashboard_Ejecutivo_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // ========== BORRAR TODOS LOS REGISTROS (SOLO PRUEBAS) ==========
        // ========== RESETEAR TODO EL SISTEMA (Firebase + Sheets + Cach√©) ==========
        async function resetearTodoElSistema() {
            const confirmacion1 = confirm(
                '‚ö†Ô∏è RESETEAR TODO EL SISTEMA\n\n' +
                'Esto borrar√° PERMANENTEMENTE:\n\n' +
                '‚úì Todos los registros de Firebase\n' +
                '‚úì Todos los datos de Google Sheets\n' +
                '‚úì Toda la memoria local\n' +
                '‚úì Control de almacenes\n' +
                '‚úì Validaciones de auditor√≠a\n\n' +
                '‚ö†Ô∏è ESTA ACCI√ìN NO SE PUEDE DESHACER\n\n' +
                '¬øEst√°s seguro?'
            );
            
            if (!confirmacion1) return;
            
            const confirmacion2 = confirm(
                'üö® √öLTIMA CONFIRMACI√ìN\n\n' +
                'Una vez que presiones OK, se borrar√° TODO.\n\n' +
                'Esto dejar√° el sistema completamente LIMPIO\n' +
                'para empezar el inventario real desde CERO.\n\n' +
                '¬øREALMENTE deseas continuar?'
            );
            
            if (!confirmacion2) return;
            
            try {
                // Mostrar overlay de carga
                const loadingDiv = document.createElement('div');
                loadingDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;';
                loadingDiv.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 20px;">üóëÔ∏è</div>
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 10px;">Limpiando sistema...</div>
                    <div id="reset-status" style="font-size: 14px; color: #90caf9;"></div>
                `;
                document.body.appendChild(loadingDiv);
                
                const updateStatus = (msg) => {
                    document.getElementById('reset-status').textContent = msg;
                };
                
                // 1. BORRAR FIREBASE
                updateStatus('1/5 - Eliminando registros de Firebase...');
                if (window.firebaseDB) {
                    const { collection, getDocs, deleteDoc, doc } = window.firebaseCollections;
                    const db = window.firebaseDB;
                    
                    // Borrar colecci√≥n "registros"
                    const registrosSnapshot = await getDocs(collection(db, 'registros'));
                    let count = 0;
                    for (const documento of registrosSnapshot.docs) {
                        await deleteDoc(doc(db, 'registros', documento.id));
                        count++;
                        if (count % 10 === 0) updateStatus(`1/5 - Eliminados ${count} registros...`);
                    }
                    
                    // Borrar colecci√≥n "registros_segundo_conteo"
                    updateStatus('2/5 - Eliminando segundo conteo...');
                    const segundoConteoSnapshot = await getDocs(collection(db, 'registros_segundo_conteo'));
                    for (const documento of segundoConteoSnapshot.docs) {
                        await deleteDoc(doc(db, 'registros_segundo_conteo', documento.id));
                    }
                    
                    // Borrar colecci√≥n "control_almacenes"
                    updateStatus('3/5 - Eliminando control de almacenes...');
                    const controlSnapshot = await getDocs(collection(db, 'control_almacenes'));
                    for (const documento of controlSnapshot.docs) {
                        await deleteDoc(doc(db, 'control_almacenes', documento.id));
                    }
                    
                    // Borrar colecci√≥n "validaciones-auditoria"
                    updateStatus('4/5 - Eliminando validaciones...');
                    const validacionesSnapshot = await getDocs(collection(db, 'validaciones-auditoria'));
                    for (const documento of validacionesSnapshot.docs) {
                        await deleteDoc(doc(db, 'validaciones-auditoria', documento.id));
                    }
                }
                
                // 2. NOTIFICAR A GOOGLE SHEETS (para que borre todo)
                updateStatus('5/5 - Limpiando Google Sheets...');
                try {
                    await fetch(GOOGLE_SCRIPT_URL + '?action=reset_all', {
                        method: 'GET',
                        redirect: 'follow'
                    });
                } catch (e) {
                    console.log('Sheets reset solicitado (revisar manualmente)');
                }
                
                // 3. LIMPIAR MEMORIA LOCAL
                registrosGuardados = [];
                registrosSegundoConteo = [];
                escaneados = [];
                almacenesBloqueados = {};
                validacionesAuditoria = [];
                
                // 4. MOSTRAR √âXITO
                loadingDiv.innerHTML = `
                    <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
                    <div style="font-size: 28px; font-weight: 700; margin-bottom: 10px;">¬°Sistema completamente limpio!</div>
                    <div style="font-size: 14px; color: #90caf9; margin-bottom: 20px;">Firebase, Sheets y cach√© local borrados</div>
                    <button onclick="location.reload()" style="background: #4caf50; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer;">
                        üîÑ Recargar App
                    </button>
                `;
                
                console.log('‚úÖ Sistema reseteado completamente');
                
            } catch (error) {
                console.error('‚ùå Error al resetear:', error);
                alert('‚ö†Ô∏è Error al resetear el sistema:\n\n' + error.message + '\n\nRevisa Firebase Console manualmente.');
            }
        }
        
        // ========== INICIALIZACI√ìN FIREBASE ==========
        async function inicializarFirebase() {
            try {
                const { collection, onSnapshot, query, orderBy, doc } = window.firebaseCollections;
                const db = window.firebaseDB;
                
                // Escuchar cambios en registros en tiempo real
                const qRegistros = query(collection(db, 'registros'), orderBy('timestamp', 'desc'));
                onSnapshot(qRegistros, (snapshot) => {
                    registrosGuardados = [];
                    snapshot.forEach((doc) => {
                        registrosGuardados.push({ id: doc.id, ...doc.data() });
                    });
                    console.log('üì• Registros sincronizados:', registrosGuardados.length);
                    
                    // Actualizar vista si est√° abierta
                    if (document.getElementById('screen-mis-registros')?.classList.contains('active')) {
                        renderizarMisRegistros();
                    }
                });
                
                // Escuchar bloqueos de almacenes
                const qControl = query(collection(db, 'control_almacenes'), orderBy('timestamp', 'desc'));
                onSnapshot(qControl, (snapshot) => {
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        almacenesBloqueados[data.almacen] = data.bloqueado;
                        
                        // Actualizar UI si est√° en auditor√≠a
                        const checkbox = document.getElementById('bloqueo-' + data.almacen);
                        if (checkbox && checkbox.checked !== data.bloqueado) {
                            checkbox.checked = data.bloqueado;
                        }
                    });
                    console.log('üîí Control de almacenes sincronizado');
                });
                
                // NUEVO: Escuchar asignaciones de SAPs para auditores
                onSnapshot(doc(db, 'asignaciones', 'saps-auditoria'), (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        sapsAuditoria = data.saps || [];
                        console.log('üìã SAPs asignados sincronizados:', sapsAuditoria.length);
                        
                        // Actualizar vista si auditor est√° viendo sus SAPs
                        if (document.getElementById('screen-menu-auditoria-conteo')?.classList.contains('active')) {
                            cargarSAPsAsignados();
                        }
                        
                        // Actualizar lista en Mesa de Control si est√° viendo
                        if (document.getElementById('screen-asignar-saps')?.classList.contains('active')) {
                            mostrarSAPsAsignados();
                        }
                    } else {
                        console.log('üìã No hay asignaciones a√∫n');
                        sapsAuditoria = [];
                    }
                });
                
                // NUEVO: Escuchar liberaciones de auditor√≠a por almac√©n
                const qLiberaciones = query(collection(db, 'liberaciones_auditoria'), orderBy('timestamp', 'desc'));
                onSnapshot(qLiberaciones, (snapshot) => {
                    auditoriasLiberadasPorAlmacen = {};
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        auditoriasLiberadasPorAlmacen[data.almacen] = data.liberado;
                    });
                    console.log('üîì Liberaciones sincronizadas:', auditoriasLiberadasPorAlmacen);
                    
                    // Actualizar panel de Mesa Control si est√° abierto
                    if (document.getElementById('screen-mesa')?.classList.contains('active')) {
                        actualizarPanelPorAlmacen();
                    }
                });
                
                console.log('‚úÖ Firebase inicializado correctamente con todos los listeners');
                
            } catch (error) {
                console.error('‚ùå Error al inicializar Firebase:', error);
            }
        }
        
        // ========== TALLER - GUARDAR DIRECTO (SIN LISTA) ==========
        let html5QrCodeTaller = null;
        let tallerScanData = {
            sap: '',
            descripcion: '',
            unidadMedida: 'PZA',
            esPositivo: false
        };
        
        // Activar c√°mara para escanear c√≥digo SAP en Taller
        function activarCamaraTaller() {
            console.log('üì∑ TALLER: Activando c√°mara para escanear SAP');
            
            const readerDiv = document.getElementById('qr-reader-taller');
            const btnEscanear = document.getElementById('btn-escanear-sap-taller');
            
            // Si ya est√° escaneando, detener
            if (html5QrCodeTaller && html5QrCodeTaller.isScanning) {
                console.log('üõë TALLER: Deteniendo esc√°ner');
                
                html5QrCodeTaller.stop()
                    .then(() => {
                        console.log('‚úÖ TALLER: Esc√°ner detenido correctamente');
                    })
                    .catch((err) => {
                        console.error('‚ö†Ô∏è TALLER: Error al detener:', err);
                    })
                    .finally(() => {
                        // SIEMPRE restaurar bot√≥n
                        readerDiv.style.display = 'none';
                        btnEscanear.textContent = 'üì∑ Escanear';
                        btnEscanear.style.background = '#1976d2';
                    });
                
                return;
            }
            
            // Mostrar √°rea de escaneo
            readerDiv.style.display = 'block';
            btnEscanear.textContent = '‚èπÔ∏è Detener';
            btnEscanear.style.background = '#d32f2f';
            
            // Inicializar esc√°ner si no existe
            if (!html5QrCodeTaller) {
                html5QrCodeTaller = new Html5Qrcode("qr-reader-taller");
            }
            
            // Configuraci√≥n del esc√°ner
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };
            
            // Iniciar escaneo
            html5QrCodeTaller.start(
                { facingMode: "environment" },
                config,
                (decodedText) => {
                    console.log('‚úÖ TALLER: C√≥digo escaneado:', decodedText);
                    procesarCodigoSAPTaller(decodedText);
                },
                (error) => {
                    // Ignorar errores de escaneo continuo
                }
            ).catch((err) => {
                console.error('‚ùå TALLER: Error al iniciar c√°mara:', err);
                alert('‚ö†Ô∏è No se pudo activar la c√°mara\n\n' + err.message);
                readerDiv.style.display = 'none';
                btnEscanear.textContent = 'üì∑ Escanear';
                btnEscanear.style.background = '#1976d2';
            });
        }
        
        // Procesar c√≥digo SAP escaneado
        function procesarCodigoSAPTaller(texto) {
            console.log('üîç TALLER: Procesando c√≥digo:', texto);
            
            const readerDiv = document.getElementById('qr-reader-taller');
            const btnEscanear = document.getElementById('btn-escanear-sap-taller');
            
            // Detener esc√°ner con manejo robusto
            if (html5QrCodeTaller && html5QrCodeTaller.isScanning) {
                html5QrCodeTaller.stop()
                    .then(() => {
                        console.log('‚úÖ TALLER: Esc√°ner detenido despu√©s de escaneo');
                    })
                    .catch((err) => {
                        console.error('‚ö†Ô∏è TALLER: Error al detener despu√©s de escaneo:', err);
                    })
                    .finally(() => {
                        // SIEMPRE restaurar bot√≥n
                        readerDiv.style.display = 'none';
                        btnEscanear.textContent = 'üì∑ Escanear';
                        btnEscanear.style.background = '#1976d2';
                    });
            }
            
            // Extraer SAP del c√≥digo (formato: "CODIGO : 263234.")
            const match = texto.match(/CODIGO\s*:\s*(\d+)\.?/i);
            
            if (!match) {
                console.error('‚ùå TALLER: No se pudo extraer SAP');
                alert('‚ö†Ô∏è C√≥digo no v√°lido\n\nFormato esperado: "CODIGO : 123456"');
                return;
            }
            
            const sap = match[1];
            console.log('‚úÖ TALLER: SAP extra√≠do:', sap);
            
            // BEEP al escanear
            reproducirSonido('scan');
            
            // Actualizar campo SAP
            document.getElementById('taller-sap').value = sap;
            
            // Buscar descripci√≥n
            let descripcion = 'Sin descripci√≥n';
            let esPositivo = false;
            
            if (baseDescripciones.length > 0) {
                const encontrado = baseDescripciones.find(item => item.codigo === sap);
                if (!encontrado) {
                    esPositivo = true;
                    descripcion = '‚ö†Ô∏è MATERIAL NO ENCONTRADO EN SAP';
                    console.warn('‚ö†Ô∏è TALLER: SAP no encontrado (POSITIVO)');
                } else {
                    descripcion = encontrado.descripcion;
                    console.log('‚úÖ TALLER: Descripci√≥n encontrada');
                }
            }
            
            // Buscar UM en Kardex
            let unidadMedida = 'PZA';
            if (kardexSAP.length > 0) {
                const itemKardex = kardexSAP.find(item => item.codigo === sap);
                if (itemKardex && itemKardex.unidadMedida) {
                    unidadMedida = itemKardex.unidadMedida;
                    console.log('‚úÖ TALLER: UM encontrada:', unidadMedida);
                }
            }
            
            // Actualizar campos del formulario
            const descDiv = document.getElementById('taller-desc');
            descDiv.textContent = descripcion;
            descDiv.style.color = esPositivo ? '#e65100' : '#424242';
            descDiv.style.fontWeight = esPositivo ? '700' : 'normal';
            
            document.getElementById('taller-unidad').value = unidadMedida;
            
            // Guardar datos
            tallerScanData = {
                sap: sap,
                descripcion: descripcion,
                unidadMedida: unidadMedida,
                esPositivo: esPositivo
            };
            
            console.log('üì¶ TALLER: Datos preparados:', tallerScanData);
            
            // Enfocar en cantidad
            setTimeout(() => {
                document.getElementById('taller-cantidad').focus();
            }, 100);
        }
        
        // Guardar registro de Taller DIRECTO (sin lista)
        async function guardarRegistroTaller() {
            console.log('üíæ TALLER: Intentando guardar registro...');
            
            // Validar almac√©n bloqueado
            if (!esSegundoConteo && almacenesBloqueados['33']) {
                alert('‚ö†Ô∏è Almac√©n 33 cerrado\n\nNo se pueden agregar m√°s registros al primer conteo.');
                return;
            }
            
            // Obtener valores del formulario
            const folio = document.getElementById('taller-folio').value.trim().toUpperCase();
            const sap = document.getElementById('taller-sap').value.trim();
            const cantidad = parseFloat(document.getElementById('taller-cantidad').value);
            const ubicacion = document.getElementById('taller-ubicacion').value.trim();
            const contador = document.getElementById('taller-contador').value.trim();
            
            // Validaciones
            if (!folio) {
                alert('‚ö†Ô∏è Falta el FOLIO del marbete');
                document.getElementById('taller-folio').focus();
                return;
            }
            
            if (!sap) {
                alert('‚ö†Ô∏è Falta escanear el C√ìDIGO SAP\n\nPresiona el bot√≥n üì∑ Escanear');
                return;
            }
            
            if (!cantidad || cantidad <= 0) {
                alert('‚ö†Ô∏è Ingresa una CANTIDAD v√°lida');
                document.getElementById('taller-cantidad').focus();
                return;
            }
            
            if (!ubicacion) {
                alert('‚ö†Ô∏è Falta la UBICACI√ìN');
                document.getElementById('taller-ubicacion').focus();
                return;
            }
            
            if (!contador) {
                alert('‚ö†Ô∏è Falta el nombre de quien cont√≥');
                document.getElementById('taller-contador').focus();
                return;
            }
            
            // Crear registro
            const registro = {
                folio: folio,
                almacen: '33',
                sap: sap,
                desc: tallerScanData.descripcion,
                cantidad: cantidad,
                unidadMedida: tallerScanData.unidadMedida,
                ubicacion: ubicacion,
                usuario: selectedUser || 'Taller',
                nombreContador: contador,
                metodo: 'QR SAP (Alm 33)',
                fecha: new Date().toISOString(),
                timestamp: new Date().toISOString(),
                eliminado: false,
                modificado: false,
                esDuplicado: false,
                esPositivo: tallerScanData.esPositivo,
                areaMaquila: false,
                sincronizado: false
            };
            
            // Obtener bot√≥n
            const btnGuardar = document.getElementById('btn-guardar-taller');
            if (!btnGuardar) {
                console.error('‚ùå No se encontr√≥ bot√≥n guardar');
                return;
            }
            
            // BLOQUEAR BOT√ìN
            btnGuardar.disabled = true;
            const textoOriginal = btnGuardar.textContent;
            
            try {
                console.log('üì¶ TALLER: Guardando registro...');
                btnGuardar.textContent = '‚è≥ Guardando...';
                
                // Guardar en Firebase
                const { collection, addDoc } = window.firebaseCollections;
                const db = window.firebaseDB;
                const coleccion = esSegundoConteo ? 'registros_segundo_conteo' : 'registros';
                
                await addDoc(collection(db, coleccion), {
                    ...registro,
                    sincronizado: true
                });
                
                console.log('‚úÖ TALLER: Guardado en Firebase');
                
                // Enviar a Google Sheets (solo primer conteo)
                if (!esSegundoConteo) {
                    btnGuardar.textContent = 'üìä Sincronizando Sheets...';
                    await enviarAGoogleSheets(registro);
                    console.log('‚úÖ TALLER: Enviado a Google Sheets');
                }
                
                // Guardar en memoria local
                if (esSegundoConteo) {
                    registrosSegundoConteo.push(registro);
                } else {
                    registrosGuardados.push(registro);
                }
                
                // Sonido de √©xito
                reproducirSonido('success');
                
                console.log('‚úÖ TALLER: Registro guardado correctamente');
                
            } catch (error) {
                console.error('‚ùå TALLER: Error al guardar:', error);
                alert('‚ö†Ô∏è Error al guardar:\n\n' + error.message + '\n\nVerifica tu conexi√≥n.');
                
            } finally {
                // SIEMPRE:
                // 1. Limpiar formulario
                limpiarFormularioTaller();
                
                // 2. Restaurar bot√≥n
                btnGuardar.disabled = false;
                btnGuardar.textContent = textoOriginal;
                
                console.log('üîÑ TALLER: Formulario limpiado y bot√≥n restaurado');
            }
        }
        
        // Limpiar formulario de Taller
        function limpiarFormularioTaller() {
            console.log('üóëÔ∏è TALLER: Limpiando formulario');
            
            document.getElementById('taller-folio').value = '';
            document.getElementById('taller-sap').value = '';
            document.getElementById('taller-desc').textContent = 'Escanea el c√≥digo SAP para ver la descripci√≥n';
            document.getElementById('taller-desc').style.color = '#666';
            document.getElementById('taller-desc').style.fontWeight = 'normal';
            document.getElementById('taller-cantidad').value = '';
            document.getElementById('taller-unidad').value = 'PZA';
            document.getElementById('taller-ubicacion').value = '';
            document.getElementById('taller-contador').value = '';
            
            tallerScanData = {
                sap: '',
                descripcion: '',
                unidadMedida: 'PZA',
                esPositivo: false
            };
            
            document.getElementById('taller-folio').focus();
        }
        
        // ========== MANUAL - GUARDAR DIRECTO (SIN LISTA) ==========
        async function guardarManualDirecto() {
            console.log('üíæ MANUAL: Intentando guardar registro...');
            
            const folio = document.getElementById('manual-folio').value.toUpperCase().trim();
            const almacenSeleccionado = document.getElementById('manual-almacen').value;
            const sap = document.getElementById('manual-sap').value.trim();
            const cantidad = parseFloat(document.getElementById('manual-cantidad').value);
            const ubicacion = document.getElementById('manual-ubicacion').value.trim();
            const nombreContador = document.getElementById('manual-contador').value.trim();

            // Convertir MAQUILA a 01
            const almacen = almacenSeleccionado === '01-MAQUILA' ? '01' : almacenSeleccionado;

            // Validar campos requeridos
            if (!folio || !sap || !almacen) {
                alert('‚ö†Ô∏è Debes llenar Folio, Almac√©n y C√≥digo SAP');
                return;
            }
            
            if (!nombreContador) {
                alert('‚ö†Ô∏è Debes indicar qui√©n hizo el conteo');
                document.getElementById('manual-contador').focus();
                return;
            }
            
            if (cantidad === '' || cantidad === null || isNaN(cantidad)) {
                alert('‚ö†Ô∏è Ingresa una cantidad v√°lida');
                return;
            }
            
            if (cantidad < 0) {
                alert('La cantidad no puede ser negativa');
                return;
            }
            
            // Confirmaci√≥n si cantidad es 0
            if (cantidad === 0) {
                if (!confirm('‚ö†Ô∏è ¬øConfirmas que la cantidad es 0?\n\nEsto significa que el art√≠culo NO existe f√≠sicamente.')) {
                    return;
                }
            }
            
            // VALIDAR SI ALMAC√âN EST√Å BLOQUEADO
            if (!esSegundoConteo && almacenesBloqueados[almacen]) {
                alert('‚ö†Ô∏è Este almac√©n ya fue cerrado por Auditor√≠a\n\nNo se pueden agregar m√°s registros al primer conteo.');
                return;
            }
            
            // Obtener descripci√≥n y UM de la base
            let descripcion = 'Captura manual';
            let unidadMedida = 'PZA';
            let esPositivo = false;
            
            if (baseDescripciones.length > 0) {
                const encontrado = baseDescripciones.find(item => item.codigo === sap);
                if (!encontrado) {
                    esPositivo = true;
                    descripcion = '‚ö†Ô∏è MATERIAL NO ENCONTRADO EN SAP';
                } else {
                    descripcion = encontrado.descripcion || 'Captura manual';
                }
            }
            
            if (kardexSAP.length > 0) {
                const itemKardex = kardexSAP.find(item => item.codigo === sap);
                if (itemKardex && itemKardex.unidadMedida) {
                    unidadMedida = itemKardex.unidadMedida;
                }
            }

            const registro = {
                folio: folio,
                almacen: almacen,
                sap: sap,
                desc: descripcion,
                cantidad: cantidad,
                unidadMedida: unidadMedida,
                ubicacion: ubicacion,
                nombreContador: nombreContador,
                usuario: selectedUser,
                metodo: 'Manual',
                fecha: new Date().toISOString(),
                timestamp: new Date().toISOString(),
                eliminado: false,
                modificado: false,
                esDuplicado: false,
                esPositivo: esPositivo,
                areaMaquila: almacenSeleccionado === '01-MAQUILA',
                sincronizado: false
            };
            
            // Obtener bot√≥n
            const btnGuardar = document.getElementById('btn-guardar-manual');
            if (!btnGuardar) {
                console.error('‚ùå No se encontr√≥ bot√≥n guardar');
                return;
            }
            
            // BLOQUEAR BOT√ìN
            btnGuardar.disabled = true;
            const textoOriginal = btnGuardar.textContent;
            
            try {
                console.log('üì¶ MANUAL: Guardando registro...');
                btnGuardar.textContent = '‚è≥ Guardando...';
                
                // Guardar en Firebase
                const { collection, addDoc } = window.firebaseCollections;
                const db = window.firebaseDB;
                const coleccion = esSegundoConteo ? 'registros_segundo_conteo' : 'registros';
                
                await addDoc(collection(db, coleccion), {
                    ...registro,
                    sincronizado: true
                });
                
                console.log('‚úÖ MANUAL: Guardado en Firebase');
                
                // Enviar a Google Sheets (solo primer conteo)
                if (!esSegundoConteo) {
                    btnGuardar.textContent = 'üìä Sincronizando Sheets...';
                    await enviarAGoogleSheets(registro);
                    console.log('‚úÖ MANUAL: Enviado a Google Sheets');
                }
                
                // Guardar en memoria local
                if (esSegundoConteo) {
                    registrosSegundoConteo.push(registro);
                } else {
                    registrosGuardados.push(registro);
                }
                
                // Sonido de √©xito
                reproducirSonido('success');
                
                console.log('‚úÖ MANUAL: Registro guardado correctamente');
                
            } catch (error) {
                console.error('‚ùå MANUAL: Error al guardar:', error);
                alert('‚ö†Ô∏è Error al guardar:\n\n' + error.message + '\n\nVerifica tu conexi√≥n.');
                
            } finally {
                // SIEMPRE:
                // 1. Limpiar formulario
                document.getElementById('manual-folio').value = '';
                document.getElementById('manual-sap').value = '';
                document.getElementById('manual-descripcion').value = '';
                document.getElementById('manual-descripcion').style.color = '#000';
                document.getElementById('manual-cantidad').value = '';
                document.getElementById('manual-ubicacion').value = '';
                document.getElementById('manual-contador').value = '';
                
                // 2. Restaurar bot√≥n
                btnGuardar.disabled = false;
                btnGuardar.textContent = textoOriginal;
                
                // 3. Enfocar en folio
                document.getElementById('manual-folio').focus();
                
                console.log('üîÑ MANUAL: Formulario limpiado y bot√≥n restaurado');
            }
        }
        
        // ========== QR NORMAL - GUARDAR DIRECTO (SIN LISTA) ==========
        async function guardarQRDirecto() {
            console.log('üíæ QR: Intentando guardar registro...');
            
            const cantidad = parseFloat(document.getElementById('form-cantidad').value);
            const ubicacion = document.getElementById('form-ubicacion').value;
            const nombreContador = document.getElementById('form-contador').value.trim();
            const almacenSeleccionado = document.getElementById('form-almacen-select').value;
            
            // Convertir MAQUILA a 01
            const almacenFinal = almacenSeleccionado === '01-MAQUILA' ? '01' : almacenSeleccionado;
            
            // Validar folio
            const folioInput = document.getElementById('form-folio').value.trim().toUpperCase();
            if (!currentScanData.folio && !folioInput) {
                alert('‚ö†Ô∏è Debes ingresar el folio del marbete');
                document.getElementById('form-folio').focus();
                return;
            }
            
            // Validar contador
            if (!nombreContador) {
                alert('‚ö†Ô∏è Debes indicar qui√©n hizo el conteo');
                document.getElementById('form-contador').focus();
                return;
            }
            
            // Validar cantidad
            if (cantidad === '' || cantidad === null || isNaN(cantidad)) {
                alert('Ingresa una cantidad v√°lida');
                return;
            }
            
            if (cantidad < 0) {
                alert('La cantidad no puede ser negativa');
                return;
            }
            
            // Confirmaci√≥n si cantidad es 0
            if (cantidad === 0) {
                if (!confirm('‚ö†Ô∏è ¬øConfirmas que la cantidad es 0?\n\nEsto significa que el art√≠culo NO existe f√≠sicamente.')) {
                    return;
                }
            }
            
            // Validar almac√©n bloqueado
            if (!esSegundoConteo && almacenesBloqueados[almacenFinal]) {
                alert('‚ö†Ô∏è Este almac√©n ya fue cerrado por Auditor√≠a\n\nNo se pueden agregar m√°s registros al primer conteo.');
                return;
            }
            
            const registro = {
                folio: currentScanData.folio || folioInput,
                almacen: almacenFinal,
                sap: currentScanData.sap,
                desc: currentScanData.desc,
                cantidad: cantidad,
                unidadMedida: currentScanData.unidadMedida || 'PZA',
                ubicacion: ubicacion,
                nombreContador: nombreContador,
                usuario: selectedUser,
                metodo: currentScanData.metodo,
                fecha: new Date().toISOString(),
                timestamp: new Date().toISOString(),
                eliminado: false,
                modificado: false,
                esDuplicado: false,
                esPositivo: currentScanData.esPositivo || false,
                areaMaquila: almacenSeleccionado === '01-MAQUILA',
                sincronizado: false
            };
            
            // Obtener bot√≥n
            const btnGuardar = document.getElementById('btn-guardar-qr');
            if (!btnGuardar) {
                console.error('‚ùå No se encontr√≥ bot√≥n guardar');
                return;
            }
            
            // BLOQUEAR BOT√ìN
            btnGuardar.disabled = true;
            const textoOriginal = btnGuardar.textContent;
            
            try {
                console.log('üì¶ QR: Guardando registro...');
                btnGuardar.textContent = '‚è≥ Guardando...';
                
                // Guardar en Firebase
                const { collection, addDoc } = window.firebaseCollections;
                const db = window.firebaseDB;
                const coleccion = esSegundoConteo ? 'registros_segundo_conteo' : 'registros';
                
                await addDoc(collection(db, coleccion), {
                    ...registro,
                    sincronizado: true
                });
                
                console.log('‚úÖ QR: Guardado en Firebase');
                
                // Enviar a Google Sheets (solo primer conteo)
                if (!esSegundoConteo) {
                    btnGuardar.textContent = 'üìä Sincronizando Sheets...';
                    await enviarAGoogleSheets(registro);
                    console.log('‚úÖ QR: Enviado a Google Sheets');
                }
                
                // Guardar en memoria local
                if (esSegundoConteo) {
                    registrosSegundoConteo.push(registro);
                } else {
                    registrosGuardados.push(registro);
                }
                
                // Sonido de √©xito
                reproducirSonido('success');
                
                console.log('‚úÖ QR: Registro guardado correctamente');
                
            } catch (error) {
                console.error('‚ùå QR: Error al guardar:', error);
                alert('‚ö†Ô∏è Error al guardar:\n\n' + error.message + '\n\nVerifica tu conexi√≥n.');
                
            } finally {
                // SIEMPRE:
                // 1. Ocultar formulario
                document.getElementById('scan-form-container').style.display = 'none';
                
                // 2. Limpiar currentScanData
                currentScanData = null;
                
                // 3. Restaurar bot√≥n
                btnGuardar.disabled = false;
                btnGuardar.textContent = textoOriginal;
                
                // 4. Mostrar bot√≥n de escanear de nuevo
                document.getElementById('scan-button').style.display = 'flex';
                
                console.log('üîÑ QR: Formulario limpiado y listo para siguiente escaneo');
            }
        }
        
        // ========== FUNCIONES ANTIGUAS DE TALLER (IGNORAR) ==========
        function procesarQRAlmacen33(texto) {
            console.log('üîß TALLER: Procesando c√≥digo de barras');
            console.log('üìÑ Texto recibido:', texto);
            
            // Extraer c√≥digo SAP despu√©s de "CODIGO :" o "CODIGO:"
            const match = texto.match(/CODIGO\s*:\s*(\d+)\.?/i);
            
            if (!match) {
                console.error('‚ùå TALLER: No se pudo extraer SAP del texto');
                alert('‚ö†Ô∏è No se pudo extraer el c√≥digo SAP del QR\n\nFormato esperado: "CODIGO : 123456"');
                return;
            }
            
            const sap = match[1]; // C√≥digo limpio sin punto
            console.log('‚úÖ TALLER: SAP extra√≠do:', sap);
            
            // FORZAR ALMAC√âN 33
            const almacenCod = '33';
            console.log('üè≠ TALLER: Almac√©n forzado a:', almacenCod);
            
            // VALIDAR SI ALMAC√âN 33 EST√Å BLOQUEADO
            if (!esSegundoConteo && almacenesBloqueados[almacenCod]) {
                console.error('üîí TALLER: Almac√©n 33 bloqueado');
                alert('‚ö†Ô∏è Almac√©n 33 (Gabinetes) cerrado\n\nNo se pueden agregar m√°s registros al primer conteo.');
                return;
            }
            
            console.log('‚úÖ TALLER: Almac√©n 33 abierto, continuando...');
            
            // Buscar descripci√≥n y UM
            let descripcion = 'Sin descripci√≥n';
            let unidadMedida = 'PZA';
            let esPositivo = false;
            
            console.log('üîç TALLER: Buscando descripci√≥n para SAP:', sap);
            console.log('üìä TALLER: Base descripciones tiene', baseDescripciones.length, 'registros');
            
            if (baseDescripciones.length > 0) {
                const encontrado = baseDescripciones.find(item => item.codigo === sap);
                if (!encontrado) {
                    esPositivo = true;
                    descripcion = '‚ö†Ô∏è MATERIAL NO ENCONTRADO EN SAP';
                    console.warn('‚ö†Ô∏è TALLER: SAP no encontrado en base de descripciones (POSITIVO)');
                } else {
                    descripcion = encontrado.descripcion;
                    console.log('‚úÖ TALLER: Descripci√≥n encontrada:', descripcion);
                }
            } else {
                console.warn('‚ö†Ô∏è TALLER: Base de descripciones vac√≠a');
            }
            
            console.log('üîç TALLER: Buscando UM en Kardex SAP');
            console.log('üìä TALLER: Kardex tiene', kardexSAP.length, 'registros');
            
            if (kardexSAP.length > 0) {
                const itemKardex = kardexSAP.find(item => item.codigo === sap);
                if (itemKardex && itemKardex.unidadMedida) {
                    unidadMedida = itemKardex.unidadMedida;
                    console.log('‚úÖ TALLER: UM encontrada:', unidadMedida);
                } else {
                    console.warn('‚ö†Ô∏è TALLER: UM no encontrada, usando PZA por defecto');
                }
            } else {
                console.warn('‚ö†Ô∏è TALLER: Kardex SAP vac√≠o');
            }
            
            // Mostrar formulario especial para Almac√©n 33
            currentScanData = {
                folio: '', // MANUAL
                almacen: '33 - Gabinetes',
                almacenCod: '33',
                sap: sap,
                desc: descripcion,
                metodo: 'QR SAP (Alm 33)',
                esPositivo: esPositivo,
                unidadMedida: unidadMedida
            };
            
            console.log('üì¶ TALLER: currentScanData preparado:', currentScanData);
            console.log('üöÄ TALLER: Llamando a mostrarFormularioAlmacen33()...');
            
            mostrarFormularioAlmacen33();
        }
        
        function mostrarFormularioAlmacen33() {
            console.log('üìù FORMULARIO: Iniciando mostrarFormularioAlmacen33()');
            console.log('üì¶ FORMULARIO: currentScanData recibido:', currentScanData);
            
            // Cambiar a tab de formulario
            console.log('üîÑ FORMULARIO: Cambiando tabs...');
            document.getElementById('tab-qr').classList.remove('active');
            document.getElementById('tab-manual').classList.remove('active');
            document.getElementById('tab-form').classList.add('active');
            document.getElementById('tab-scan').style.display = 'none';
            document.getElementById('tab-manual').style.display = 'none';
            document.getElementById('tab-form-container').style.display = 'block';
            console.log('‚úÖ FORMULARIO: Tabs actualizados');
            
            // Llenar campos
            console.log('‚úçÔ∏è FORMULARIO: Llenando campos...');
            document.getElementById('form-folio').value = ''; // VAC√çO para ingreso manual
            document.getElementById('form-folio').disabled = false; // HABILITADO
            document.getElementById('form-folio').placeholder = 'Ej: G-001';
            
            document.getElementById('form-almacen-select').value = currentScanData.almacenCod;
            document.getElementById('form-almacen-select').disabled = true; // Fijo en 33
            
            document.getElementById('form-sap').textContent = currentScanData.sap;
            document.getElementById('form-desc').textContent = currentScanData.desc;
            console.log('‚úÖ FORMULARIO: Campos b√°sicos llenados');
            
            // Color especial si es positivo
            if (currentScanData.esPositivo) {
                document.getElementById('form-desc').style.color = '#e65100';
                document.getElementById('form-desc').style.fontWeight = '700';
                console.log('‚ö†Ô∏è FORMULARIO: Aplicado estilo POSITIVO');
            } else {
                document.getElementById('form-desc').style.color = '#424242';
                document.getElementById('form-desc').style.fontWeight = 'normal';
            }
            
            // Limpiar y enfocar
            document.getElementById('form-cantidad').value = '';
            document.getElementById('form-ubicacion').value = '';
            document.getElementById('form-contador').value = selectedUser || '';
            console.log('‚úÖ FORMULARIO: Campos limpiados');
            
            // Enfocar en FOLIO (campo manual)
            setTimeout(() => {
                document.getElementById('form-folio').focus();
                console.log('‚úÖ FORMULARIO: Focus en campo FOLIO');
            }, 100);
            
            // Detener esc√°ner
            if (window.html5QrCode && window.html5QrCode.isScanning) {
                window.html5QrCode.stop();
                console.log('üõë FORMULARIO: Esc√°ner detenido');
            }
            
            console.log('‚úÖ FORMULARIO: Proceso completado - Formulario visible');
        }
        
        // ========== GOOGLE SHEETS INTEGRATION ==========
        const GOOGLE_SHEETS_WEBHOOK = 'https://script.google.com/macros/s/AKfycbxaT_mU2y2nQ_0eHPP4fIwa_bEQUtksJcalu35XdhhOlBxmrdKjxmY--XrXBZPOdWDA/exec';
        
        async function enviarAGoogleSheets(registro) {
            try {
                const response = await fetch(GOOGLE_SHEETS_WEBHOOK, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'add',
                        registro: registro
                    })
                });
                
                console.log('‚úÖ Enviado a Google Sheets');
            } catch (error) {
                console.error('‚ùå Error al enviar a Google Sheets:', error);
            }
        }
        
        // NUEVA: Enviar correcciones de auditor√≠a a pesta√±a espec√≠fica
        async function enviarCorreccionAuditoria(correccion) {
            try {
                const response = await fetch(GOOGLE_SHEETS_WEBHOOK, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'correccion_auditoria',
                        correccion: {
                            tipo: 'CORRECCI√ìN AUDITOR√çA',
                            fecha: new Date().toISOString(),
                            folio: correccion.folio,
                            almacen: correccion.almacen,
                            sap: correccion.sap,
                            descripcion: correccion.desc,
                            cantidadOriginal: correccion.cantidadOriginal,
                            cantidadCorrecta: correccion.cantidadCorrecta,
                            diferencia: correccion.diferencia,
                            porcentajeDif: correccion.porcentajeDif || '',
                            observaciones: correccion.observaciones || '',
                            auditor: correccion.auditor,
                            fechaHora: new Date().toLocaleString('es-MX')
                        }
                    })
                });
                
                console.log('‚úÖ Correcci√≥n enviada a Google Sheets (pesta√±a CORRECCIONES)');
            } catch (error) {
                console.error('‚ùå Error al enviar correcci√≥n a Sheets:', error);
            }
        }
        
        // ========== CONTROL DE FASES POR ALMAC√âN ==========
        let almacenSeleccionadoFases = '01';
        let faseActual = 1;
        let capturaGeneralBloqueada = false;
        let auditoriaLiberada = false;
        let auditoriasLiberadasPorAlmacen = {}; // {almacen: true/false}
        
        function actualizarPanelPorAlmacen() {
            almacenSeleccionadoFases = document.getElementById('select-almacen-fases').value;
            
            // Filtrar registros seg√∫n almac√©n seleccionado
            let registrosActivos;
            if (almacenSeleccionadoFases === '01-MAQUILA') {
                // Solo registros de MAQUILA (areaMaquila = true)
                registrosActivos = registrosGuardados.filter(r => 
                    !r.eliminado && 
                    !r.modificado && 
                    r.almacen === '01' && 
                    r.areaMaquila === true
                );
            } else if (almacenSeleccionadoFases === '01') {
                // Solo registros de Materia Prima (areaMaquila = false o undefined)
                registrosActivos = registrosGuardados.filter(r => 
                    !r.eliminado && 
                    !r.modificado && 
                    r.almacen === '01' && 
                    (r.areaMaquila === false || r.areaMaquila === undefined)
                );
            } else {
                // Otros almacenes (30, 31, 32, 33)
                registrosActivos = registrosGuardados.filter(r => 
                    !r.eliminado && 
                    !r.modificado && 
                    r.almacen === almacenSeleccionadoFases
                );
            }
            
            // Detectar duplicados del almac√©n
            const duplicadosMap = {};
            registrosActivos.forEach(r => {
                const key = `${r.folio}_${r.almacen}_${r.sap}`;
                if (!duplicadosMap[key]) duplicadosMap[key] = [];
                duplicadosMap[key].push(r);
            });
            
            let duplicadosPendientes = 0;
            Object.values(duplicadosMap).forEach(grupo => {
                if (grupo.length > 1 && !grupo[0].duplicadoResuelto) {
                    duplicadosPendientes++;
                }
            });
            
            // SAPs asignados a este almac√©n
            const sapsDelAlmacen = sapsAuditoria.filter(s => s.almacen === almacenSeleccionadoFases).length;
            
            // Actualizar contadores
            document.getElementById('count-captura-alm').textContent = registrosActivos.length.toLocaleString();
            document.getElementById('count-dup-alm').textContent = duplicadosPendientes;
            document.getElementById('count-saps-alm').textContent = sapsDelAlmacen;
            
            // Estado de bloqueo del almac√©n
            const btnBloquear = document.getElementById('btn-bloquear-alm');
            const statusFase1 = document.getElementById('status-fase1-alm');
            if (almacenesBloqueados[almacenSeleccionadoFases]) {
                btnBloquear.innerHTML = 'üîì Desbloquear Captura';
                btnBloquear.style.background = '#ffebee';
                btnBloquear.style.color = '#c62828';
                btnBloquear.style.borderColor = '#ef9a9a';
                statusFase1.textContent = 'BLOQUEADA';
                statusFase1.style.background = '#ffcdd2';
                statusFase1.style.color = '#c62828';
            } else {
                btnBloquear.innerHTML = 'üîí Bloquear Captura';
                btnBloquear.style.background = '#e3f2fd';
                btnBloquear.style.color = '#1565c0';
                btnBloquear.style.borderColor = '#90caf9';
                statusFase1.textContent = 'ACTIVA';
                statusFase1.style.background = '#c8e6c9';
                statusFase1.style.color = '#2e7d32';
            }
            
            // Estado de duplicados
            const statusFase2 = document.getElementById('status-fase2-alm');
            if (duplicadosPendientes === 0) {
                statusFase2.textContent = 'COMPLETADA';
                statusFase2.style.background = '#c8e6c9';
                statusFase2.style.color = '#2e7d32';
            } else {
                statusFase2.textContent = `${duplicadosPendientes} PENDIENTES`;
                statusFase2.style.background = '#fff9c4';
                statusFase2.style.color = '#f57f17';
            }
            
            // Habilitar bot√≥n de liberar si duplicados = 0
            const btnLiberar = document.getElementById('btn-liberar-alm');
            const statusFase3 = document.getElementById('status-fase3-alm');
            const infoLiberacion = document.getElementById('info-liberacion-alm');
            
            if (duplicadosPendientes === 0 && !auditoriasLiberadasPorAlmacen[almacenSeleccionadoFases]) {
                btnLiberar.disabled = false;
                btnLiberar.style.opacity = '1';
                btnLiberar.style.cursor = 'pointer';
                btnLiberar.style.background = '#1a237e';
                btnLiberar.style.color = 'white';
                infoLiberacion.textContent = 'Lista para liberar';
                infoLiberacion.style.color = '#4caf50';
            } else if (auditoriasLiberadasPorAlmacen[almacenSeleccionadoFases]) {
                btnLiberar.disabled = true;
                btnLiberar.textContent = '‚úÖ Visibilidad Liberada';
                btnLiberar.style.background = '#c8e6c9';
                btnLiberar.style.color = '#2e7d32';
                btnLiberar.style.cursor = 'default';
                statusFase3.textContent = 'LIBERADA';
                statusFase3.style.background = '#c8e6c9';
                statusFase3.style.color = '#2e7d32';
                infoLiberacion.textContent = 'Auditores pueden validar';
                infoLiberacion.style.color = '#4caf50';
            } else {
                btnLiberar.textContent = 'üîì Liberar Visibilidad para Auditores';
                infoLiberacion.textContent = 'Visibilidad bloqueada hasta resolver duplicados';
                infoLiberacion.style.color = '#757575';
            }
            
            // RENDERIZAR PROGRESO INTEGRADO SI EST√Å LIBERADO
            renderizarProgresoIntegrado(almacenSeleccionadoFases);
        }
        
        // Renderizar progreso dentro de Fase 3
        function renderizarProgresoIntegrado(almacen) {
            const container = document.getElementById('progreso-auditoria-alm');
            const sapsDelAlmacen = sapsAuditoria.filter(s => s.almacen === almacen);
            const liberado = auditoriasLiberadasPorAlmacen[almacen] === true;
            
            if (!liberado || sapsDelAlmacen.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            // Agrupar por auditor
            const porAuditor = {};
            sapsDelAlmacen.forEach(s => {
                if (!porAuditor[s.auditor]) porAuditor[s.auditor] = [];
                porAuditor[s.auditor].push(s);
            });
            
            let html = '<div style="font-size: 13px; font-weight: 700; color: #1a237e; margin-bottom: 12px;">üìã Progreso por Auditor:</div>';
            
            Object.keys(porAuditor).forEach(auditor => {
                const saps = porAuditor[auditor];
                const nombreCorto = auditor.split(' ')[0] + ' ' + (auditor.split(' ')[1] || '');
                
                html += `
                    <div style="background: #f5f5f5; border-radius: 8px; padding: 10px; margin-bottom: 8px;">
                        <div style="font-size: 12px; font-weight: 600; color: #424242; margin-bottom: 8px;">
                            üë§ ${nombreCorto}
                        </div>
                `;
                
                saps.forEach(s => {
                    const progreso = calcularProgresoSAP(s.sap);
                    const estaCompleto = progreso.validados === progreso.total && progreso.total > 0;
                    const icono = estaCompleto ? '‚úÖ' : progreso.validados > 0 ? '‚è≥' : '‚¨ú';
                    const color = estaCompleto ? '#4caf50' : progreso.validados > 0 ? '#2196f3' : '#bdbdbd';
                    
                    // Calcular diferencias de este SAP
                    const validacionesSAP = validacionesAuditoria.filter(v => v.sap === s.sap);
                    const conDiferencia = validacionesSAP.filter(v => v.diferencia !== 0);
                    const totalDiferencia = conDiferencia.reduce((sum, v) => sum + v.diferencia, 0);
                    
                    let infoDiferencias = '';
                    if (estaCompleto && conDiferencia.length > 0) {
                        const signo = totalDiferencia > 0 ? '+' : '';
                        infoDiferencias = `
                            <div style="font-size: 10px; color: #ff6f00; margin-top: 4px; font-weight: 600;">
                                ‚ö†Ô∏è ${conDiferencia.length} difs (Total: ${signo}${totalDiferencia} PZA)
                            </div>
                        `;
                    } else if (estaCompleto && conDiferencia.length === 0) {
                        infoDiferencias = `
                            <div style="font-size: 10px; color: #4caf50; margin-top: 4px; font-weight: 600;">
                                ‚úì Sin diferencias
                            </div>
                        `;
                    }
                    
                    html += `
                        <div style="background: white; border-radius: 6px; padding: 8px; margin-bottom: 6px; border-left: 3px solid ${color};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <div style="font-size: 11px; font-weight: 700; color: #1a237e;">
                                    ${icono} ${s.sap}
                                </div>
                                <div style="font-size: 11px; font-weight: 700; color: ${color};">
                                    ${progreso.porcentaje}%
                                </div>
                            </div>
                            <div style="font-size: 10px; color: #757575; margin-bottom: 4px;">
                                ${progreso.validados}/${progreso.total} folios
                            </div>
                            ${infoDiferencias}
                            <div style="background: #e0e0e0; border-radius: 4px; height: 4px; overflow: hidden; margin-top: 4px;">
                                <div style="width: ${progreso.porcentaje}%; height: 100%; background: ${color}; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            // Resumen total
            const totalSAPs = sapsDelAlmacen.length;
            const completados = sapsDelAlmacen.filter(s => {
                const prog = calcularProgresoSAP(s.sap);
                return prog.validados === prog.total && prog.total > 0;
            }).length;
            
            html += `
                <div style="background: #e3f2fd; border-radius: 6px; padding: 8px; text-align: center; margin-top: 8px;">
                    <div style="font-size: 11px; color: #1565c0; font-weight: 600;">
                        ‚úÖ Completados: ${completados} / ${totalSAPs}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function toggleBloqueoAlmacen() {
            const alm = almacenSeleccionadoFases;
            almacenesBloqueados[alm] = !almacenesBloqueados[alm];
            
            if (almacenesBloqueados[alm]) {
                alert(`‚úÖ Almac√©n ${alm} BLOQUEADO\n\nNo se permiten m√°s capturas en primer conteo`);
            } else {
                alert(`‚úÖ Almac√©n ${alm} DESBLOQUEADO\n\nSe permite captura nuevamente`);
            }
            
            actualizarPanelPorAlmacen();
        }
        
        function abrirDuplicadosPorAlmacen() {
            currentAlmacenDup = almacenSeleccionadoFases;
            showScreen('duplicados');
            document.getElementById('titulo-duplicados').textContent = `Duplicados - Almac√©n ${almacenSeleccionadoFases}`;
            renderizarDuplicadosResolucion();
        }
        
        function abrirAsignarPorAlmacen() {
            showScreen('asignar-saps');
            // Pre-seleccionar el almac√©n en la pantalla de asignar
            setTimeout(() => {
                const selectAlm = document.getElementById('almacen-auditoria');
                if (selectAlm) {
                    selectAlm.value = almacenSeleccionadoFases;
                    mostrarAuditoresAlmacen();
                }
                mostrarSAPsAsignados(); // Mostrar SAPs ya asignados
            }, 100);
        }
        
        async function liberarAuditoriaPorAlmacen() {
            const alm = almacenSeleccionadoFases;
            
            if (!confirm(`üîì Liberar Visibilidad para Almac√©n ${alm}\n\nLos auditores de este almac√©n podr√°n ver sus SAPs asignados.\n\n¬øContinuar?`)) {
                return;
            }
            
            try {
                // Actualizar estado local
                auditoriasLiberadasPorAlmacen[alm] = true;
                auditoriaLiberada = true;
                
                // Guardar en Firebase
                if (window.firebaseDB) {
                    const { setDoc, doc } = window.firebaseCollections;
                    const db = window.firebaseDB;
                    
                    await setDoc(doc(db, 'liberaciones_auditoria', alm), {
                        almacen: alm,
                        liberado: true,
                        liberadoPor: selectedUser || 'Mesa Control',
                        timestamp: new Date().toISOString()
                    });
                    
                    console.log(`‚úÖ Auditor√≠a del almac√©n ${alm} liberada en Firebase`);
                }
                
                alert(`‚úÖ Auditor√≠a del Almac√©n ${alm} LIBERADA\n\nLos auditores asignados a este almac√©n ya pueden ver sus SAPs`);
                actualizarPanelPorAlmacen();
                
            } catch (error) {
                console.error('‚ùå Error al liberar auditor√≠a:', error);
                alert('‚ö†Ô∏è Error al liberar auditor√≠a. Revisa la consola.');
            }
        }
        
        function volverAMesa() {
            actualizarPanelPorAlmacen();
            showScreen('mesa');
        }
        
        // ========== VISTAS CON FILTROS ==========
        function abrirResolucionDuplicados() {
            showScreen('duplicados');
            renderizarDuplicadosResolucion();
        }
        
        function renderizarDuplicadosResolucion() {
            // FILTRAR SOLO POR ALMAC√âN SELECCIONADO
            const registros = registrosGuardados.filter(r => 
                !r.eliminado && 
                !r.modificado && 
                r.almacen === almacenSeleccionadoFases
            );
            const duplicadosMap = {};
            
            registros.forEach(r => {
                const key = `${r.folio}_${r.almacen}_${r.sap}`;
                if (!duplicadosMap[key]) duplicadosMap[key] = [];
                duplicadosMap[key].push(r);
            });
            
            let duplicados = [];
            Object.values(duplicadosMap).forEach(grupo => {
                if (grupo.length > 1 && !grupo[0].duplicadoResuelto) {
                    duplicados.push(grupo);
                }
            });
            
            document.getElementById('count-dup-header').textContent = duplicados.length;
            document.getElementById('count-duplicados').textContent = `${duplicados.length} duplicados del almac√©n ${almacenSeleccionadoFases}`;
            
            if (duplicados.length === 0) {
                document.getElementById('container-duplicados').innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 64px; margin-bottom: 16px;">‚úÖ</div>
                        <h3 style="color: #4caf50; margin-bottom: 8px;">¬°Sin duplicados en almac√©n ${almacenSeleccionadoFases}!</h3>
                        <p style="color: #757575;">Ya puedes liberar la auditor√≠a de este almac√©n</p>
                    </div>`;
                return;
            }
            
            let html = '';
            duplicados.forEach((grupo, idx) => {
                const r1 = grupo[0];
                html += `<div style="background: white; margin: 8px; border-radius: 12px; padding: 16px; border-left: 4px solid #ff9800;">
                    <div style="font-weight: 700; color: #1a237e; margin-bottom: 8px;">‚ö†Ô∏è Folio ${r1.folio} | ${r1.almacen} | SAP ${r1.sap}</div>
                    <div style="font-size: 13px; color: #757575; margin-bottom: 12px;">${r1.desc}</div>`;
                
                grupo.forEach((r, i) => {
                    const index = registrosGuardados.indexOf(r);
                    html += `<label style="display: block; background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" onmouseover="this.style.borderColor='#2196f3'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='transparent'">
                        <input type="radio" name="dup-${idx}" value="${index}" style="margin-right: 8px; transform: scale(1.2);" onchange="this.parentElement.style.borderColor='#2196f3'">
                        <strong>Registro ${i+1}:</strong> ${r.cantidad} ${r.unidadMedida || 'PZA'} | ${r.usuario} | ${new Date(r.fecha).toLocaleString('es-MX', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'})}
                    </label>`;
                });
                
                html += `<button class="btn-primary" onclick="resolverDuplicado(${idx})" style="width: 100%; margin-top: 8px; background: #1a237e;">‚úÖ Resolver y Liberar</button></div>`;
            });
            
            document.getElementById('container-duplicados').innerHTML = html;
        }
        
        function resolverDuplicado(grupoIndex) {
            const radios = document.querySelectorAll(`input[name="dup-${grupoIndex}"]`);
            let seleccionado = null;
            radios.forEach(r => { if (r.checked) seleccionado = parseInt(r.value); });
            
            if (seleccionado === null) {
                alert('‚ö†Ô∏è Selecciona cu√°l es el registro correcto');
                return;
            }
            
            const correcto = registrosGuardados[seleccionado];
            
            if (confirm(`¬øConfirmar?\n\nSe mantendr√°:\n${correcto.cantidad} ${correcto.unidadMedida || 'PZA'} | ${correcto.usuario}\n\nSe eliminar√°n los dem√°s registros duplicados.`)) {
                // Marcar correcto como resuelto (ACTIVO)
                correcto.duplicadoResuelto = true;
                correcto.esDuplicado = false;
                
                // Enviar actualizaci√≥n a Google Sheets: registro correcto pasa a ACTIVO
                enviarAGoogleSheets({
                    ...correcto,
                    eliminado: false,
                    modificado: false
                });
                
                // Eliminar los dem√°s y marcarlos como DUPLICADO
                registrosGuardados.forEach((r, i) => {
                    if (r.folio === correcto.folio && r.almacen === correcto.almacen && r.sap === correcto.sap && i !== seleccionado && !r.eliminado) {
                        r.eliminado = true;
                        r.motivoEliminacion = 'Duplicado resuelto - versi√≥n incorrecta';
                        r.eliminadoPor = currentRole || selectedUser;
                        r.fechaEliminacion = new Date().toISOString();
                        
                        // Enviar a Google Sheets como DUPLICADO (no ACTIVO)
                        enviarAGoogleSheets({
                            ...r,
                            eliminado: true
                        });
                    }
                });
                
                alert('‚úÖ Duplicado resuelto correctamente\n\n‚úì Registro correcto marcado como ACTIVO\n‚úì Duplicados marcados como ELIMINADO');
                renderizarDuplicadosResolucion();
                actualizarPanelPorAlmacen();
            }
        }
        
        // POSITIVOS - Solo visualizaci√≥n (NO resoluci√≥n)
        function abrirResolucionPositivos() {
            showScreen('positivos-vista');
            renderizarPositivosVisualizacion();
        }
        
        function renderizarPositivosVisualizacion() {
            let positivos = registrosGuardados.filter(r => !r.eliminado && !r.modificado && r.almacen !== '00' && r.esPositivo);
            
            document.getElementById('count-pos-header').textContent = positivos.length;
            document.getElementById('count-positivos').textContent = `${positivos.length} positivos encontrados`;
            
            if (positivos.length === 0) {
                document.getElementById('container-positivos').innerHTML = '<div style="text-align: center; padding: 40px; color: #9e9e9e;">No hay positivos</div>';
                return;
            }
            
            let html = '';
            positivos.forEach(p => {
                html += `<div style="background: white; margin: 8px; border-radius: 12px; padding: 16px; border-left: 4px solid #9c27b0;">
                    <div style="font-weight: 700; color: #1a237e; margin-bottom: 4px;">‚ùì SAP ${p.sap}</div>
                    <div style="font-size: 13px; color: #757575; margin-bottom: 8px;">${p.desc}</div>
                    <div style="font-size: 12px; color: #424242;">Folio: ${p.folio} | Almac√©n: ${p.almacen} | Cantidad: ${p.cantidad} ${p.unidadMedida || 'PZA'}</div>
                    <div style="font-size: 12px; color: #757575; margin-top: 4px;">Usuario: ${p.usuario} | ${new Date(p.fecha).toLocaleString('es-MX')}</div>
                </div>`;
            });
            
            document.getElementById('container-positivos').innerHTML = html;
        }
        
        // ========== VISTAS CON FILTROS ==========
        let currentFilterDup = 'todos', currentAlmacenDup = 'todos', currentUsuarioDup = 'todos';
        let currentFilterPos = 'todos', currentAlmacenPos = 'todos', currentUsuarioPos = 'todos';
        let currentFilterComp = 'todos', currentAlmacenComp = 'todos', currentOrdenComp = 'costo';
        let currentFilterHist = 'todos', currentAlmacenHist = 'todos', currentUsuarioHist = 'todos', currentAccionHist = 'todos';
        let pantallaOrigenHistorial = 'mesa';
        
        // DUPLICADOS
        function abrirDuplicados() {
            showScreen('duplicados');
            cargarUsuariosFiltro('dup');
            renderizarDuplicados();
        }
        
        function toggleFilterDuplicados(el, type) {
            document.querySelectorAll('#screen-duplicados .filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('#screen-duplicados .filter-dropdown').forEach(d => d.classList.remove('show'));
            if (type !== 'todos') document.getElementById('filter-' + type + '-dup')?.classList.add('show');
            currentFilterDup = type;
            renderizarDuplicados();
        }
        
        function selectAlmacenDup(alm) {
            currentAlmacenDup = alm;
            document.querySelectorAll('#filter-almacen-dup .filter-option').forEach(o => o.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('filter-almacen-dup').classList.remove('show');
            renderizarDuplicados();
        }
        
        function selectUsuarioDup(usr) {
            currentUsuarioDup = usr;
            document.querySelectorAll('#filter-usuario-dup .filter-option').forEach(o => o.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('filter-usuario-dup').classList.remove('show');
            renderizarDuplicados();
        }
        
        function buscarDuplicados() {
            renderizarDuplicados();
        }
        
        function renderizarDuplicados() {
            const query = document.getElementById('search-duplicados').value.toLowerCase();
            let registros = registrosGuardados.filter(r => !r.eliminado && !r.modificado && r.almacen !== '00');
            
            // Detectar duplicados
            const duplicadosMap = {};
            registros.forEach(r => {
                const key = `${r.folio}_${r.almacen}_${r.sap}`;
                if (!duplicadosMap[key]) duplicadosMap[key] = [];
                duplicadosMap[key].push(r);
            });
            
            let duplicados = [];
            Object.values(duplicadosMap).forEach(grupo => {
                if (grupo.length > 1) {
                    duplicados.push(...grupo);
                }
            });
            
            // Filtros
            if (currentAlmacenDup !== 'todos') duplicados = duplicados.filter(r => r.almacen === currentAlmacenDup);
            if (currentUsuarioDup !== 'todos') duplicados = duplicados.filter(r => r.usuario === currentUsuarioDup);
            if (query) duplicados = duplicados.filter(r => r.folio.toLowerCase().includes(query) || r.sap.toLowerCase().includes(query));
            
            document.getElementById('count-duplicados').textContent = `${duplicados.length} duplicados encontrados`;
            
            if (duplicados.length === 0) {
                document.getElementById('container-duplicados').innerHTML = '<div style="text-align: center; padding: 40px; color: #9e9e9e;">No hay duplicados</div>';
                return;
            }
            
            let html = '';
            const grupos = {};
            duplicados.forEach(r => {
                const key = `${r.folio}_${r.almacen}_${r.sap}`;
                if (!grupos[key]) grupos[key] = [];
                grupos[key].push(r);
            });
            
            Object.values(grupos).forEach(grupo => {
                if (grupo.length < 2) return;
                const r1 = grupo[0];
                html += `<div style="background: white; margin: 8px; border-radius: 12px; padding: 16px; border-left: 4px solid #f57c00;">
                    <div style="font-weight: 700; color: #1a237e; margin-bottom: 8px;">‚ö†Ô∏è Folio ${r1.folio} | ${r1.almacen} | SAP ${r1.sap}</div>
                    <div style="font-size: 13px; color: #757575; margin-bottom: 12px;">${r1.desc}</div>`;
                
                grupo.forEach((r, i) => {
                    html += `<div style="background: #f5f5f5; padding: 8px; border-radius: 6px; margin-bottom: 6px;">
                        <div style="font-size: 13px;"><strong>Registro ${i+1}:</strong> ${r.cantidad} ${r.unidadMedida || 'PZA'}</div>
                        <div style="font-size: 12px; color: #757575;">Usuario: ${r.usuario} | ${new Date(r.fecha).toLocaleString('es-MX')}</div>
                    </div>`;
                });
                
                html += `</div>`;
            });
            
            document.getElementById('container-duplicados').innerHTML = html;
        }
        
        // POSITIVOS
        function abrirPositivos() {
            showScreen('positivos-vista');
            cargarUsuariosFiltro('pos');
            renderizarPositivos();
        }
        
        function toggleFilterPositivos(el, type) {
            document.querySelectorAll('#screen-positivos-vista .filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('#screen-positivos-vista .filter-dropdown').forEach(d => d.classList.remove('show'));
            if (type !== 'todos') document.getElementById('filter-' + type + '-pos')?.classList.add('show');
            currentFilterPos = type;
            renderizarPositivos();
        }
        
        function selectAlmacenPos(alm) {
            currentAlmacenPos = alm;
            document.querySelectorAll('#filter-almacen-pos .filter-option').forEach(o => o.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('filter-almacen-pos').classList.remove('show');
            renderizarPositivos();
        }
        
        function selectUsuarioPos(usr) {
            currentUsuarioPos = usr;
            document.querySelectorAll('#filter-usuario-pos .filter-option').forEach(o => o.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('filter-usuario-pos').classList.remove('show');
            renderizarPositivos();
        }
        
        function buscarPositivos() {
            renderizarPositivos();
        }
        
        function renderizarPositivos() {
            const query = document.getElementById('search-positivos').value.toLowerCase();
            let positivos = registrosGuardados.filter(r => !r.eliminado && r.esPositivo);
            
            if (currentAlmacenPos !== 'todos') positivos = positivos.filter(r => r.almacen === currentAlmacenPos);
            if (currentUsuarioPos !== 'todos') positivos = positivos.filter(r => r.usuario === currentUsuarioPos);
            if (query) positivos = positivos.filter(r => r.sap.toLowerCase().includes(query));
            
            document.getElementById('count-positivos').textContent = `${positivos.length} positivos encontrados`;
            
            if (positivos.length === 0) {
                document.getElementById('container-positivos').innerHTML = '<div style="text-align: center; padding: 40px; color: #9e9e9e;">No hay positivos</div>';
                return;
            }
            
            let html = '';
            positivos.forEach(p => {
                html += `<div style="background: white; margin: 8px; border-radius: 12px; padding: 16px; border-left: 4px solid #9c27b0;">
                    <div style="font-weight: 700; color: #1a237e; margin-bottom: 4px;">‚ùì SAP ${p.sap}</div>
                    <div style="font-size: 13px; color: #757575; margin-bottom: 8px;">${p.desc}</div>
                    <div style="font-size: 12px; color: #424242;">Folio: ${p.folio} | Almac√©n: ${p.almacen} | Cantidad: ${p.cantidad} ${p.unidadMedida || 'PZA'}</div>
                    <div style="font-size: 12px; color: #757575; margin-top: 4px;">Usuario: ${p.usuario} | ${new Date(p.fecha).toLocaleString('es-MX')}</div>
                </div>`;
            });
            
            document.getElementById('container-positivos').innerHTML = html;
        }
        
        // COMPARATIVO
        function abrirComparativo() {
            if (kardexSAP.length === 0) {
                alert('‚ö†Ô∏è Debes cargar el Kardex SAP primero en Auditor√≠a');
                return;
            }
            showScreen('comparativo-vista');
            renderizarComparativo();
        }
        
        function toggleFilterComparativo(el, type) {
            document.querySelectorAll('#screen-comparativo-vista .filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('#screen-comparativo-vista .filter-dropdown').forEach(d => d.classList.remove('show'));
            if (type !== 'todos') document.getElementById('filter-' + type + '-comp')?.classList.add('show');
            currentFilterComp = type;
            renderizarComparativo();
        }
        
        function selectAlmacenComp(alm) {
            currentAlmacenComp = alm;
            document.querySelectorAll('#filter-almacen-comp .filter-option').forEach(o => o.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('filter-almacen-comp').classList.remove('show');
            renderizarComparativo();
        }
        
        function selectOrdenComp(orden) {
            currentOrdenComp = orden;
            document.querySelectorAll('#filter-ordenar-comp .filter-option').forEach(o => o.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('filter-ordenar-comp').classList.remove('show');
            renderizarComparativo();
        }
        
        function buscarComparativo() {
            renderizarComparativo();
        }
        
        function renderizarComparativo() {
            const query = document.getElementById('search-comparativo').value.toLowerCase();
            const registrosActivos = registrosGuardados.filter(r => !r.eliminado && !r.modificado && r.almacen !== '00');
            
            const fisicoMap = {};
            registrosActivos.forEach(r => {
                const key = `${r.sap}_${r.almacen}`;
                if (!fisicoMap[key]) fisicoMap[key] = 0;
                fisicoMap[key] += r.cantidad;
            });
            
            let diferencias = [];
            kardexSAP.forEach(k => {
                const key = `${k.codigo}_${k.almacen}`;
                const fis = fisicoMap[key] || 0;
                const dif = fis - (k.cantidad || 0);
                const costoUnit = k.costoUnitario || 0;
                const valorDif = dif * costoUnit;
                const pct = k.cantidad > 0 ? ((dif / k.cantidad) * 100).toFixed(1) : 0;
                
                if (Math.abs(dif) > 0) {
                    diferencias.push({
                        sap: k.codigo,
                        desc: k.descripcion,
                        almacen: k.almacen,
                        kardex: k.cantidad || 0,
                        fisico: fis,
                        dif: dif,
                        costoUnit: costoUnit,
                        valorDif: valorDif,
                        pct: parseFloat(pct)
                    });
                }
            });
            
            if (currentAlmacenComp !== 'todos') diferencias = diferencias.filter(d => d.almacen === currentAlmacenComp);
            if (query) diferencias = diferencias.filter(d => d.sap.toLowerCase().includes(query));
            
            if (currentOrdenComp === 'costo') diferencias.sort((a,b) => Math.abs(b.valorDif) - Math.abs(a.valorDif));
            else if (currentOrdenComp === 'cantidad') diferencias.sort((a,b) => Math.abs(b.dif) - Math.abs(a.dif));
            else diferencias.sort((a,b) => Math.abs(b.pct) - Math.abs(a.pct));
            
            const top10 = diferencias.slice(0, 10);
            
            document.getElementById('stats-comp-total').textContent = `${kardexSAP.length} art√≠culos`;
            document.getElementById('stats-comp-dif').textContent = `${diferencias.length} con diferencias`;
            
            if (top10.length === 0) {
                document.getElementById('container-comparativo').innerHTML = '<div style="text-align: center; padding: 40px; color: #9e9e9e;">No hay diferencias</div>';
                return;
            }
            
            let html = '';
            top10.forEach((d, i) => {
                const color = d.dif < 0 ? '#d32f2f' : '#2e7d32';
                html += `<div style="background: white; margin: 8px; border-radius: 12px; padding: 16px; border-left: 4px solid ${color};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-size: 11px; color: #9e9e9e; margin-bottom: 2px;">TOP ${i+1}</div>
                            <div style="font-weight: 700; color: #1a237e; margin-bottom: 4px;">SAP ${d.sap} | ${d.almacen}</div>
                            <div style="font-size: 13px; color: #757575; margin-bottom: 8px;">${d.desc}</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                                <div><span style="color: #9e9e9e;">Kardex:</span> <strong>${d.kardex}</strong></div>
                                <div><span style="color: #9e9e9e;">F√≠sico:</span> <strong>${d.fisico}</strong></div>
                                <div><span style="color: #9e9e9e;">Dif Cant:</span> <strong style="color: ${color};">${d.dif > 0 ? '+' : ''}${d.dif.toFixed(2)}</strong></div>
                                <div><span style="color: #9e9e9e;">Dif %:</span> <strong style="color: ${color};">${d.pct > 0 ? '+' : ''}${d.pct}%</strong></div>
                            </div>
                        </div>
                        <div style="text-align: right; margin-left: 16px;">
                            <div style="font-size: 11px; color: #9e9e9e;">Valor Diferencia</div>
                            <div style="font-size: 18px; font-weight: 700; color: ${color};">$${Math.abs(d.valorDif).toFixed(2)}</div>
                            <div style="font-size: 11px; color: #9e9e9e;">${d.dif < 0 ? 'FALTANTE' : 'SOBRANTE'}</div>
                        </div>
                    </div>
                </div>`;
            });
            
            document.getElementById('container-comparativo').innerHTML = html;
        }
        
        // HISTORIAL
        function abrirHistorial(origen) {
            pantallaOrigenHistorial = origen;
            showScreen('historial');
            cargarUsuariosFiltro('hist');
            renderizarHistorial();
        }
        
        function volverDesdeHistorial() {
            showScreen(pantallaOrigenHistorial);
        }
        
        function toggleFilterHistorial(el, type) {
            document.querySelectorAll('#screen-historial .filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('#screen-historial .filter-dropdown').forEach(d => d.classList.remove('show'));
            if (type !== 'todos') document.getElementById('filter-' + type + '-hist')?.classList.add('show');
            currentFilterHist = type;
            renderizarHistorial();
        }
        
        function selectAlmacenHist(alm) {
            currentAlmacenHist = alm;
            document.querySelectorAll('#filter-almacen-hist .filter-option').forEach(o => o.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('filter-almacen-hist').classList.remove('show');
            renderizarHistorial();
        }
        
        function selectUsuarioHist(usr) {
            currentUsuarioHist = usr;
            document.querySelectorAll('#filter-usuario-hist .filter-option').forEach(o => o.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('filter-usuario-hist').classList.remove('show');
            renderizarHistorial();
        }
        
        function selectAccionHist(acc) {
            currentAccionHist = acc;
            document.querySelectorAll('#filter-accion-hist .filter-option').forEach(o => o.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('filter-accion-hist').classList.remove('show');
            renderizarHistorial();
        }
        
        function buscarHistorial() {
            renderizarHistorial();
        }
        
        function renderizarHistorial() {
            const query = document.getElementById('search-historial').value.toLowerCase();
            // Filtrar por modificados O eliminados
            let cambios = registrosGuardados.filter(r => r.eliminado || r.modificado);
            
            if (currentAlmacenHist !== 'todos') cambios = cambios.filter(r => r.almacen === currentAlmacenHist);
            if (currentUsuarioHist !== 'todos') cambios = cambios.filter(r => (r.eliminadoPor || r.usuario) === currentUsuarioHist);
            if (currentAccionHist !== 'todos') {
                if (currentAccionHist === 'ELIMINADO') cambios = cambios.filter(r => r.eliminado);
                else cambios = cambios.filter(r => r.modificado && !r.eliminado);
            }
            if (query) cambios = cambios.filter(r => r.folio.toLowerCase().includes(query) || r.sap.toLowerCase().includes(query));
            
            cambios.sort((a,b) => new Date(b.fechaModificacion || b.fechaEliminacion || b.fecha) - new Date(a.fechaModificacion || a.fechaEliminacion || a.fecha));
            
            console.log('Total cambios:', cambios.length);
            console.log('Cambios:', cambios);
            
            document.getElementById('count-historial').textContent = `${cambios.length} cambios encontrados`;
            
            if (cambios.length === 0) {
                document.getElementById('container-historial').innerHTML = '<div style="text-align: center; padding: 40px; color: #9e9e9e;">No hay cambios registrados.<br><br>Se mostrar√°n aqu√≠ los registros editados y eliminados.</div>';
                return;
            }
            
            let html = '';
            cambios.forEach(r => {
                const accion = r.eliminado ? 'ELIMINADO' : 'EDITADO';
                const color = r.eliminado ? '#d32f2f' : '#ff9800';
                const icon = r.eliminado ? 'üóëÔ∏è' : '‚úèÔ∏è';
                const usuario = r.eliminado ? r.eliminadoPor : r.usuario;
                const fecha = r.eliminado ? r.fechaEliminacion : r.fechaModificacion;
                
                // Buscar la versi√≥n NUEVA (ACTIVA) si est√° editado
                let versionNueva = null;
                if (r.modificado && !r.eliminado) {
                    versionNueva = registrosGuardados.find(reg => 
                        reg.folio === r.folio && 
                        reg.almacen === r.almacen && 
                        reg.sap === r.sap && 
                        !reg.eliminado && 
                        !reg.modificado &&
                        new Date(reg.fecha) > new Date(r.fecha)
                    );
                }
                
                html += `<div style="background: white; margin: 8px; border-radius: 12px; padding: 16px; border-left: 4px solid ${color};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div><span style="background: ${color}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">${icon} ${accion}</span></div>
                        <div style="font-size: 11px; color: #9e9e9e;">${new Date(fecha || r.fecha).toLocaleString('es-MX')}</div>
                    </div>
                    <div style="font-weight: 700; color: #1a237e; margin-bottom: 8px;">Folio ${r.folio} | Almac√©n ${r.almacen} | SAP ${r.sap}</div>
                    <div style="font-size: 13px; color: #757575; margin-bottom: 8px;">${r.desc}</div>`;
                
                if (versionNueva) {
                    // Mostrar ANTES y DESPU√âS
                    const diferencia = versionNueva.cantidad - r.cantidad;
                    const signo = diferencia > 0 ? '+' : '';
                    html += `
                    <div style="background: #f5f5f5; border-radius: 8px; padding: 12px; margin-top: 8px;">
                        <div style="font-size: 12px; color: #424242; margin-bottom: 4px;">
                            <strong>ANTES:</strong> ${r.cantidad} ${r.unidadMedida || 'PZA'}
                        </div>
                        <div style="font-size: 12px; color: #424242; margin-bottom: 4px;">
                            <strong>DESPU√âS:</strong> ${versionNueva.cantidad} ${versionNueva.unidadMedida || 'PZA'}
                        </div>
                        <div style="font-size: 12px; color: ${diferencia >= 0 ? '#388e3c' : '#d32f2f'}; font-weight: 700;">
                            <strong>CAMBIO:</strong> ${signo}${diferencia} ${r.unidadMedida || 'PZA'}
                        </div>
                        ${versionNueva.razonEdicion ? `
                        <div style="font-size: 12px; color: #424242; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0;">
                            <strong>üìù Raz√≥n:</strong> ${versionNueva.razonEdicion}
                        </div>
                        ` : ''}
                    </div>`;
                } else if (r.eliminado) {
                    // Mostrar info del eliminado
                    html += `
                    <div style="background: #ffebee; border-radius: 8px; padding: 12px; margin-top: 8px;">
                        <div style="font-size: 12px; color: #424242; margin-bottom: 4px;">
                            <strong>Cantidad:</strong> ${r.cantidad} ${r.unidadMedida || 'PZA'}
                        </div>
                        ${r.razonEliminacion ? `
                        <div style="font-size: 12px; color: #d32f2f; margin-top: 8px; font-weight: 600;">
                            <strong>üóëÔ∏è Raz√≥n:</strong> ${r.razonEliminacion}
                        </div>
                        ` : `
                        <div style="font-size: 12px; color: #757575;">
                            <strong>Motivo:</strong> ${r.motivoEliminacion || 'No especificado'}
                        </div>
                        `}
                    </div>`;
                } else {
                    // Solo mostrar cantidad si no se encontr√≥ la nueva versi√≥n
                    html += `<div style="font-size: 12px; color: #424242; margin-top: 8px;">Cantidad: ${r.cantidad} ${r.unidadMedida || 'PZA'}</div>`;
                }
                
                html += `<div style="font-size: 12px; color: #9e9e9e; margin-top: 8px;">Modificado por: ${usuario || 'N/A'}</div>
                </div>`;
            });
            
            document.getElementById('container-historial').innerHTML = html;
        }
        
        function cargarUsuariosFiltro(tipo) {
            const usuarios = [...new Set(registrosGuardados.map(r => r.usuario))].sort();
            let html = '';
            usuarios.forEach(u => {
                html += `<div class="filter-option" onclick="selectUsuario${tipo.charAt(0).toUpperCase() + tipo.slice(1)}('${u}')">${u}</div>`;
            });
            document.getElementById('usuarios-' + tipo + '-list').innerHTML = html;
        }
        
        // ========== AUDITOR√çA DE CONTEO ==========
        let sapsAuditoria = []; // SAPs asignados con sus auditores
        let validacionesAuditoria = []; // Validaciones realizadas
        let sapActualValidando = null;
        let folioActualValidando = null;
        
        // Mostrar auditores del almac√©n seleccionado
        function mostrarAuditoresAlmacen() {
            const almacen = document.getElementById('almacen-auditoria').value;
            
            if (!almacen) {
                document.getElementById('info-auditores-almacen').style.display = 'none';
                return;
            }
            
            const auditoresPorAlmacen = {
                '31': ['ERICK ORLANDO CORTEZ GONZALEZ'],
                '30': ['YARELLI GUADALUPE HERNANDEZ GARCIA', 'ENRIQUE CORTEZ RIOS'],
                '32': ['ENRIQUE CORTEZ RIOS', 'LOLIS PEREZ SIMANCAS'],
                'MAQUILA': ['LOLIS PEREZ SIMANCAS', 'BRENDA ABIGAIL AGUI√ëAGA GALLARDO'],
                '33': ['BLANCA ALICIA AVALOS ROMO', 'ENRIQUE CORTEZ RIOS', 'LOLIS PEREZ SIMANCAS', 'ERICK ORLANDO CORTEZ GONZALEZ'],
                '01': ['DANIEL OMAR ARENAS SOLORIO', 'EDSON ALEJANDRO ENCINIA HERNANDEZ', 'MARIO (CALIDAD)', 'JOSE NAPOLEON PEREZ', 'HIRAM ENRIQUE CORTEZ GARZA'],
                '00': [] // Por definir
            };
            
            const auditores = auditoresPorAlmacen[almacen] || [];
            
            if (auditores.length === 0) {
                document.getElementById('lista-auditores-almacen').innerHTML = '<em>No hay auditores asignados a este almac√©n</em>';
            } else {
                let html = '<ul style="margin: 8px 0; padding-left: 20px;">';
                auditores.forEach(a => {
                    html += `<li style="margin: 4px 0;">${a}</li>`;
                });
                html += '</ul>';
                document.getElementById('lista-auditores-almacen').innerHTML = html;
            }
            
            document.getElementById('info-auditores-almacen').style.display = 'block';
        }
        
        // Asignar SAPs a auditores
        async function asignarSAPsAuditores() {
            const almacen = document.getElementById('almacen-auditoria').value;
            const input = document.getElementById('saps-input').value.trim();
            
            if (!almacen) {
                alert('Selecciona primero el almac√©n');
                return;
            }
            
            if (!input) {
                alert('Ingresa al menos un SAP');
                return;
            }
            
            const saps = input.split('\n').map(s => s.trim()).filter(s => s.length > 0);
            
            if (saps.length === 0) {
                alert('No se encontraron SAPs v√°lidos');
                return;
            }
            
            // Lista de auditores POR ALMAC√âN
            const auditoresPorAlmacen = {
                '31': ['ERICK ORLANDO CORTEZ GONZALEZ'],
                '30': ['YARELLI GUADALUPE HERNANDEZ GARCIA', 'ENRIQUE CORTEZ RIOS'],
                '32': ['ENRIQUE CORTEZ RIOS', 'LOLIS PEREZ SIMANCAS'],
                '33': ['BLANCA ALICIA AVALOS ROMO', 'ENRIQUE CORTEZ RIOS', 'LOLIS PEREZ SIMANCAS', 'ERICK ORLANDO CORTEZ GONZALEZ'],
                '01': ['DANIEL OMAR ARENAS SOLORIO', 'EDSON ALEJANDRO ENCINIA HERNANDEZ', 'MARIO (CALIDAD)', 'JOSE NAPOLEON PEREZ', 'HIRAM ENRIQUE CORTEZ GARZA', 'LOLIS PEREZ SIMANCAS', 'BRENDA ABIGAIL AGUI√ëAGA GALLARDO'],
                '00': [] // No se usa (l√≠neas producci√≥n)
            };
            
            const auditores = auditoresPorAlmacen[almacen];
            
            if (!auditores || auditores.length === 0) {
                alert('No hay auditores asignados a este almac√©n');
                return;
            }
            
            // Asignar equitativamente entre auditores del almac√©n
            const sapsAsignados = [];
            saps.forEach((sap, index) => {
                const auditorIndex = index % auditores.length;
                const auditor = auditores[auditorIndex];
                
                // Buscar descripci√≥n del SAP
                let descripcion = '';
                if (baseDescripciones.length > 0) {
                    const item = baseDescripciones.find(b => b.codigo === sap);
                    descripcion = item ? item.descripcion : 'Sin descripci√≥n';
                } else if (kardexSAP.length > 0) {
                    const item = kardexSAP.find(k => k.codigo === sap);
                    descripcion = item ? item.descripcion : 'Sin descripci√≥n';
                }
                
                sapsAsignados.push({
                    sap: sap,
                    descripcion: descripcion,
                    almacen: almacen,
                    auditor: auditor,
                    validado: false
                });
            });
            
            // Agregar a lista existente (no reemplazar)
            sapsAuditoria = [...sapsAuditoria, ...sapsAsignados];
            
            // Guardar en Firebase
            try {
                if (window.firebaseDB) {
                    const { collection, doc, setDoc } = window.firebaseCollections;
                    const db = window.firebaseDB;
                    
                    await setDoc(doc(db, 'asignaciones', 'saps-auditoria'), {
                        saps: sapsAuditoria,
                        fecha: new Date().toISOString()
                    });
                    
                    console.log('‚úì SAPs asignados guardados en Firebase');
                }
            } catch (error) {
                console.error('Error al guardar asignaciones:', error);
            }
            
            // Mostrar resumen
            const conteo = {};
            auditores.forEach(a => conteo[a] = 0);
            sapsAsignados.forEach(s => conteo[s.auditor]++);
            
            const nombreAlmacen = document.getElementById('almacen-auditoria').options[document.getElementById('almacen-auditoria').selectedIndex].text;
            
            let html = '<div style="background: #e8f5e9; border-radius: 8px; padding: 16px; margin-top: 16px;">';
            html += '<h4 style="color: #2e7d32; margin-bottom: 12px;">‚úì Asignaci√≥n Completada</h4>';
            html += `<p style="margin-bottom: 8px;"><strong>Almac√©n:</strong> ${nombreAlmacen}</p>`;
            html += `<p style="margin-bottom: 12px;"><strong>Total SAPs:</strong> ${sapsAsignados.length}</p>`;
            html += '<div style="font-size: 13px;">';
            Object.entries(conteo).forEach(([auditor, cant]) => {
                if (cant > 0) {
                    const nombre = auditor.split(' ')[0] + ' ' + (auditor.split(' ')[1] || '');
                    html += `<div style="margin: 4px 0;">${nombre}: <strong>${cant} SAPs</strong></div>`;
                }
            });
            html += '</div></div>';
            
            document.getElementById('resumen-asignacion').innerHTML = html;
            document.getElementById('saps-input').value = '';
            
            mostrarSAPsAsignados();
        }
        
        // Mostrar SAPs asignados
        function mostrarSAPsAsignados() {
            if (sapsAuditoria.length === 0) {
                document.getElementById('lista-saps-asignados').innerHTML = '<p style="color: #9e9e9e;">No hay SAPs asignados</p>';
                return;
            }
            
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            sapsAuditoria.forEach((s, i) => {
                const nombreAlm = s.almacen === 'MAQUILA' ? 'MAQUILA' : (s.almacen === '00' ? '00 - L√≠neas' : 
                                  s.almacen === '01' ? '01 - MP' : 
                                  s.almacen === '30' ? '30 - Transformadores' : 
                                  s.almacen === '31' ? '31 - Placas' : 
                                  s.almacen === '32' ? '32 - Arneses' : 
                                  s.almacen === '33' ? '33 - Gabinetes' : s.almacen);
                
                html += `
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1a237e;">${s.sap} <span style="font-size: 12px; color: #757575;">| ${nombreAlm}</span></div>
                                <div style="font-size: 12px; color: #757575; margin-top: 4px;">${s.descripcion}</div>
                                <div style="font-size: 12px; color: #2196f3; margin-top: 4px;">üë§ ${s.auditor}</div>
                            </div>
                            <div>
                                ${s.validado ? '<span style="color: #4caf50;">‚úì</span>' : '<span style="color: #9e9e9e;">‚è≥</span>'}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            document.getElementById('lista-saps-asignados').innerHTML = html;
        }
        
        // Cargar SAPs asignados (al entrar auditor)
        async function cargarSAPsAsignados() {
            try {
                if (window.firebaseDB) {
                    const { doc, getDoc } = window.firebaseCollections;
                    const db = window.firebaseDB;
                    
                    const docSnap = await getDoc(doc(db, 'asignaciones', 'saps-auditoria'));
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        sapsAuditoria = data.saps || [];
                        console.log('‚úì SAPs cargados:', sapsAuditoria.length);
                    }
                }
            } catch (error) {
                console.error('Error al cargar SAPs:', error);
            }
            
            mostrarMisSAPsAsignados();
        }
        
        // Mostrar MIS SAPs asignados (para auditor)
        function mostrarMisSAPsAsignados() {
            // Filtrar SAPs del auditor Y que su almac√©n est√© liberado
            const misSAPs = sapsAuditoria.filter(s => 
                s.auditor === selectedUser && 
                auditoriasLiberadasPorAlmacen[s.almacen] === true
            );
            
            if (misSAPs.length === 0) {
                const todosmisSAPs = sapsAuditoria.filter(s => s.auditor === selectedUser);
                
                if (todosmisSAPs.length === 0) {
                    document.getElementById('mis-saps-asignados').innerHTML = '<p style="color: #9e9e9e; text-align: center; padding: 40px;">No tienes SAPs asignados a√∫n</p>';
                } else {
                    const almacenesBloqueados = [...new Set(todosmisSAPs.map(s => s.almacen))];
                    document.getElementById('mis-saps-asignados').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üîí</div>
                            <h3 style="color: #ff9800; margin-bottom: 8px;">Almacenes Bloqueados</h3>
                            <p style="color: #757575; font-size: 14px;">
                                Tienes ${todosmisSAPs.length} SAPs asignados en:<br>
                                <strong>${almacenesBloqueados.join(', ')}</strong>
                            </p>
                            <p style="color: #9e9e9e; font-size: 13px; margin-top: 12px;">
                                Mesa de Control debe liberar primero.
                            </p>
                        </div>
                    `;
                }
                return;
            }
            
            let html = '';
            misSAPs.forEach(s => {
                const progreso = calcularProgresoSAP(s.sap);
                const estaCompleto = progreso.validados === progreso.total && progreso.total > 0;
                
                html += `
                    <div onclick="abrirValidarSAP('${s.sap}')" style="background: white; border: 2px solid ${estaCompleto ? '#4caf50' : '#e0e0e0'}; border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-size: 18px; font-weight: 700; color: #1a237e; margin-bottom: 4px;">${s.sap}</div>
                                <div style="font-size: 13px; color: #757575; margin-bottom: 4px;">${s.descripcion}</div>
                                <div style="font-size: 11px; color: #9e9e9e; margin-bottom: 8px;">üì¶ Almac√©n ${s.almacen}</div>
                                <div style="font-size: 12px; color: #2196f3;">
                                    ${progreso.validados} / ${progreso.total} folios validados (${progreso.porcentaje}%)
                                </div>
                            </div>
                            <div style="font-size: 32px;">
                                ${estaCompleto ? '‚úÖ' : progreso.validados > 0 ? '‚è≥' : '‚¨ú'}
                            </div>
                        </div>
                        ${progreso.total > 0 ? `
                        <div style="margin-top: 12px; background: #f5f5f5; border-radius: 8px; height: 8px; overflow: hidden;">
                            <div style="width: ${progreso.porcentaje}%; height: 100%; background: ${estaCompleto ? '#4caf50' : '#2196f3'}; transition: width 0.3s;"></div>
                        </div>
                        ` : ''}
                        ${estaCompleto ? `
                        <div style="margin-top: 8px; text-align: center; font-size: 12px; color: #4caf50; font-weight: 600;">
                            ‚úÖ SAP COMPLETADO
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            document.getElementById('mis-saps-asignados').innerHTML = html;
        }
        
        // Calcular progreso de validaci√≥n de un SAP
        function calcularProgresoSAP(sap) {
            const foliosConSAP = registrosGuardados.filter(r => r.sap === sap && !r.eliminado);
            const foliosValidados = validacionesAuditoria.filter(v => v.sap === sap);
            
            const total = foliosConSAP.length;
            const validados = foliosValidados.length;
            const porcentaje = total > 0 ? Math.round((validados / total) * 100) : 0;
            
            return { total, validados, porcentaje };
        }
        
        // Abrir validar SAP
        function abrirValidarSAP(sap) {
            sapActualValidando = sap;
            const sapData = sapsAuditoria.find(s => s.sap === sap);
            
            document.getElementById('validar-sap-titulo').textContent = `SAP ${sap}`;
            
            // Info del SAP
            let htmlInfo = `
                <div style="background: #e3f2fd; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <div style="font-size: 20px; font-weight: 700; color: #1565c0; margin-bottom: 8px;">${sap}</div>
                    <div style="font-size: 14px; color: #424242;">${sapData ? sapData.descripcion : 'Sin descripci√≥n'}</div>
                </div>
            `;
            
            document.getElementById('info-sap-validar').innerHTML = htmlInfo;
            
            // Folios con este SAP
            const folios = registrosGuardados.filter(r => r.sap === sap && !r.eliminado);
            
            if (folios.length === 0) {
                document.getElementById('folios-sap-validar').innerHTML = '<p style="text-align: center; color: #9e9e9e; padding: 40px;">No hay folios capturados con este SAP</p>';
            } else {
                let htmlFolios = '<h3 style="margin-bottom: 12px;">Folios a Validar:</h3>';
                folios.forEach(f => {
                    const validado = validacionesAuditoria.find(v => v.folio === f.folio && v.almacen === f.almacen && v.sap === f.sap);
                    
                    htmlFolios += `
                        <div style="background: white; border: 2px solid ${validado ? '#4caf50' : '#e0e0e0'}; border-radius: 8px; padding: 12px; margin-bottom: 8px; position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;" onclick="abrirValidarFolio('${f.folio}', '${f.almacen}', '${f.sap}')" style="cursor: pointer;">
                                    <div style="font-weight: 600;">Folio: ${f.folio} | Almac√©n: ${f.almacen}</div>
                                    <div style="font-size: 13px; color: #757575; margin-top: 4px;">Cantidad capturada: ${f.cantidad} ${f.unidadMedida || 'PZA'}</div>
                                    <div style="font-size: 12px; color: #9e9e9e; margin-top: 4px;">Ubicaci√≥n: ${f.ubicacion || 'N/A'} | Cont√≥: ${f.nombreContador}</div>
                                    ${validado ? `<div style="font-size: 12px; color: #4caf50; margin-top: 4px;">‚úì Validado: ${validado.cantidadValidada} ${validado.diferencia !== 0 ? `(Dif: ${validado.diferencia > 0 ? '+' : ''}${validado.diferencia})` : ''}</div>` : ''}
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="font-size: 24px;">
                                        ${validado ? (validado.diferencia === 0 ? '‚úÖ' : '‚ö†Ô∏è') : '‚¨ú'}
                                    </div>
                                    <button onclick="event.stopPropagation(); eliminarFolioAuditoria(${registrosGuardados.indexOf(f)})" style="background: #ffebee; color: #c62828; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('folios-sap-validar').innerHTML = htmlFolios;
            }
            
            showScreen('validar-sap');
        }
        
        // Abrir validar folio espec√≠fico
        function abrirValidarFolio(folio, almacen, sap) {
            folioActualValidando = { folio, almacen, sap };
            
            const registro = registrosGuardados.find(r => r.folio === folio && r.almacen === almacen && r.sap === sap && !r.eliminado);
            const validacionPrevia = validacionesAuditoria.find(v => v.folio === folio && v.almacen === almacen && v.sap === sap);
            
            let html = `
                <div style="background: #f5f5f5; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 12px;">Informaci√≥n Original</h4>
                    <div style="font-size: 14px; margin: 8px 0;"><strong>Folio:</strong> ${folio}</div>
                    <div style="font-size: 14px; margin: 8px 0;"><strong>Almac√©n:</strong> ${almacen}</div>
                    <div style="font-size: 14px; margin: 8px 0;"><strong>SAP:</strong> ${sap}</div>
                    <div style="font-size: 14px; margin: 8px 0;"><strong>Descripci√≥n:</strong> ${registro.desc}</div>
                    <div style="font-size: 14px; margin: 8px 0;"><strong>Cantidad Capturada:</strong> ${registro.cantidad} ${registro.unidadMedida || 'PZA'}</div>
                    <div style="font-size: 14px; margin: 8px 0;"><strong>Ubicaci√≥n:</strong> ${registro.ubicacion || 'N/A'}</div>
                    <div style="font-size: 14px; margin: 8px 0;"><strong>Cont√≥:</strong> ${registro.nombreContador}</div>
                </div>
                
                <h4 style="margin-bottom: 12px;">Validaci√≥n</h4>
                <div class="input-group">
                    <label>Cantidad F√≠sica Validada *</label>
                    <input type="number" id="cantidad-validada" value="${validacionPrevia ? validacionPrevia.cantidadValidada : registro.cantidad}" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                </div>
                
                <div class="input-group" style="margin-top: 16px;">
                    <label>Observaciones (Opcional)</label>
                    <textarea id="observaciones-validacion" rows="3" placeholder="Ej: Faltan 5 piezas en rack..." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">${validacionPrevia ? validacionPrevia.observaciones : ''}</textarea>
                </div>
                
                <button class="btn-primary" onclick="guardarValidacion()" style="margin-top: 24px; width: 100%;">
                    ${validacionPrevia ? 'Actualizar Validaci√≥n' : 'Guardar Validaci√≥n'}
                </button>
            `;
            
            document.getElementById('form-validacion-folio').innerHTML = html;
            showScreen('validar-folio');
        }
        
        // Guardar validaci√≥n
        async function guardarValidacion() {
            const cantidadValidada = parseFloat(document.getElementById('cantidad-validada').value);
            const observaciones = document.getElementById('observaciones-validacion').value.trim();
            
            if (isNaN(cantidadValidada) || cantidadValidada < 0) {
                alert('Ingresa una cantidad v√°lida');
                return;
            }
            
            const { folio, almacen, sap } = folioActualValidando;
            const registro = registrosGuardados.find(r => r.folio === folio && r.almacen === almacen && r.sap === sap && !r.eliminado);
            
            const diferencia = cantidadValidada - registro.cantidad;
            const porcentajeDif = registro.cantidad > 0 ? ((diferencia / registro.cantidad) * 100).toFixed(1) : 0;
            
            const validacion = {
                folio,
                almacen,
                sap,
                desc: registro.desc,
                cantidadOriginal: registro.cantidad,
                cantidadValidada,
                diferencia,
                porcentajeDif,
                observaciones,
                auditor: selectedUser,
                fecha: new Date().toISOString(),
                tieneDiferencia: diferencia !== 0
            };
            
            // Actualizar o agregar
            const index = validacionesAuditoria.findIndex(v => v.folio === folio && v.almacen === almacen && v.sap === sap);
            if (index >= 0) {
                validacionesAuditoria[index] = validacion;
            } else {
                validacionesAuditoria.push(validacion);
            }
            
            // Guardar en Firebase
            try {
                if (window.firebaseDB) {
                    const { collection, addDoc } = window.firebaseCollections;
                    const db = window.firebaseDB;
                    
                    await addDoc(collection(db, 'validaciones-auditoria'), validacion);
                    console.log('‚úÖ Validaci√≥n guardada en Firebase');
                }
            } catch (error) {
                console.error('‚ùå Error al guardar validaci√≥n:', error);
            }
            
            // SI HAY DIFERENCIA, enviar correcci√≥n a Google Sheets
            if (diferencia !== 0) {
                try {
                    const porcentajeDif = registro.cantidad > 0 ? ((diferencia / registro.cantidad) * 100).toFixed(1) : 0;
                    
                    const correccion = {
                        folio,
                        almacen,
                        sap,
                        desc: registro.desc,
                        cantidadOriginal: registro.cantidad,
                        cantidadCorrecta: cantidadValidada,
                        diferencia,
                        porcentajeDif,
                        observaciones,
                        auditor: selectedUser
                    };
                    
                    await enviarCorreccionAuditoria(correccion);
                    console.log('‚úÖ Correcci√≥n enviada a Google Sheets (pesta√±a CORRECCIONES)');
                } catch (error) {
                    console.error('‚ùå Error al enviar correcci√≥n a Sheets:', error);
                }
            }
            
            // Marcar SAP como validado si todos sus folios est√°n validados
            const folios = registrosGuardados.filter(r => r.sap === sap && !r.eliminado);
            const validados = validacionesAuditoria.filter(v => v.sap === sap);
            
            if (folios.length === validados.length) {
                const sapIndex = sapsAuditoria.findIndex(s => s.sap === sap);
                if (sapIndex >= 0) {
                    sapsAuditoria[sapIndex].validado = true;
                    
                    // Actualizar en Firebase
                    try {
                        if (window.firebaseDB) {
                            const { setDoc, doc } = window.firebaseCollections;
                            const db = window.firebaseDB;
                            
                            await setDoc(doc(db, 'asignaciones', 'saps-auditoria'), {
                                saps: sapsAuditoria,
                                fecha: new Date().toISOString()
                            });
                            console.log('‚úÖ SAP marcado como validado en Firebase');
                        }
                    } catch (error) {
                        console.error('‚ùå Error al actualizar SAP:', error);
                    }
                }
            }
            
            // Mensaje mejorado con emoji y detalles
            if (diferencia === 0) {
                alert('‚úÖ VALIDACI√ìN CORRECTA\n\nNo hay diferencias.\nFolio verificado correctamente.');
            } else {
                alert(`‚ö†Ô∏è DIFERENCIA DETECTADA\n\nDiferencia: ${diferencia > 0 ? '+' : ''}${diferencia}\nCantidad original: ${registro.cantidad}\nCantidad correcta: ${cantidadValidada}\n\n‚úÖ Correcci√≥n enviada a Google Sheets`);
            }
            
            abrirValidarSAP(sap);
        }
        
        // Eliminar folio individual desde auditor√≠a
        async function eliminarFolioAuditoria(index) {
            const registro = registrosGuardados[index];
            if (!registro || registro.eliminado) {
                alert('Registro no encontrado');
                return;
            }

            // Confirmar eliminaci√≥n
            if (!confirm(`üóëÔ∏è ¬øELIMINAR este folio?\n\nFolio: ${registro.folio}\nSAP: ${registro.sap}\nCantidad: ${registro.cantidad} ${registro.unidadMedida || 'PZA'}\n\n‚ö†Ô∏è Se eliminar√° de la lista de validaci√≥n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer`)) {
                return;
            }
            
            // Pedir RAZ√ìN (obligatorio)
            const razon = prompt(
                `¬øPOR QU√â eliminas este folio?\n\n` +
                `Folio: ${registro.folio}\n` +
                `SAP: ${registro.sap}\n\n` +
                `Ejemplos:\n` +
                `- "Duplicado con F100"\n` +
                `- "Marbete incorrecto"\n` +
                `- "Material no corresponde"\n\n` +
                `Escribe la raz√≥n:`
            );
            
            if (!razon || razon.trim() === '') {
                alert('‚ö†Ô∏è Debes indicar la raz√≥n de la eliminaci√≥n');
                return;
            }
            
            try {
                // Guardar en historial
                if (!registro.versiones) {
                    registro.versiones = [];
                }
                
                registro.versiones.push({
                    version: registro.versiones.length + 1,
                    fecha: new Date().toISOString(),
                    accion: 'ELIMINADO EN AUDITOR√çA',
                    usuario: selectedUser,
                    razon: razon.trim(),
                    datosAnteriores: {
                        folio: registro.folio,
                        sap: registro.sap,
                        cantidad: registro.cantidad,
                        ubicacion: registro.ubicacion
                    }
                });
                
                // Marcar como eliminado
                registro.eliminado = true;
                registro.fechaEliminacion = new Date().toISOString();
                registro.eliminadoPor = selectedUser;
                registro.razonEliminacion = razon.trim();
                
                // Actualizar en Firebase
                if (registro.id && window.firebaseDB) {
                    const { doc, updateDoc } = window.firebaseCollections;
                    const db = window.firebaseDB;
                    
                    await updateDoc(doc(db, 'registros', registro.id), {
                        eliminado: true,
                        fechaEliminacion: registro.fechaEliminacion,
                        eliminadoPor: registro.eliminadoPor,
                        razonEliminacion: registro.razonEliminacion,
                        versiones: registro.versiones
                    });
                }
                
                // Enviar a Google Sheets
                await enviarAGoogleSheets({
                    ...registro,
                    eliminado: true,
                    modificado: false
                });
                
                console.log('‚úÖ Folio eliminado desde auditor√≠a');
                
                // Confirmaci√≥n visual
                alert(`‚úÖ FOLIO ELIMINADO\n\nFolio: ${registro.folio}\nRaz√≥n: ${razon.trim()}\n\n‚úì Ya no aparecer√° en validaci√≥n`);
                
                // Recargar vista de SAP
                abrirValidarSAP(sapActualValidando);
                
            } catch (error) {
                console.error('‚ùå Error al eliminar folio:', error);
                alert('‚ö†Ô∏è Error al eliminar:\n\n' + error.message);
            }
        }
        
        // Volver a validar SAP
        function volverValidarSAP() {
            if (sapActualValidando) {
                abrirValidarSAP(sapActualValidando);
            }
        }
        
        // ========== DASHBOARD DIN√ÅMICO ==========
        function actualizarDashboard() {
            const registrosActivos = registrosGuardados.filter(r => !r.eliminado && !r.modificado && r.almacen !== '00');
            
            // Total art√≠culos capturados
            const totalCapturado = registrosActivos.length;
            
            // Total esperado (del Kardex si existe)
            let totalEsperado = kardexSAP.length > 0 ? kardexSAP.length : 10000;
            
            // Porcentaje
            const porcentaje = totalEsperado > 0 ? ((totalCapturado / totalEsperado) * 100).toFixed(1) : 0;
            
            // Positivos
            const totalPositivos = registrosActivos.filter(r => r.esPositivo).length;
            
            // Actualizar elementos principales
            document.getElementById('dash-total').textContent = totalCapturado.toLocaleString();
            document.getElementById('dash-esperado').textContent = totalEsperado.toLocaleString();
            document.getElementById('dash-progress-bar').style.width = porcentaje + '%';
            document.getElementById('dash-porcentaje').textContent = porcentaje + '% completado';
            document.getElementById('dash-positivos').textContent = totalPositivos;
            
            // Calcular velocidad (escaneos/hora aproximado - √∫ltimos registros)
            const ahora = new Date();
            const hace1Hora = new Date(ahora - 60 * 60 * 1000);
            const ultimaHora = registrosActivos.filter(r => new Date(r.fecha) > hace1Hora).length;
            document.getElementById('dash-velocidad').textContent = '~' + ultimaHora;
            
            // Avance por almac√©n
            const almacenes = {
                '00': { nombre: '00 - L√≠neas Producci√≥n', color: '#9c27b0', total: 0, esperado: 0 },
                '01': { nombre: '01 - Materia Prima', color: '#fbc02d', total: 0, esperado: 0 },
                '30': { nombre: '30 - Transformadores', color: '#1976d2', total: 0, esperado: 0 },
                '31': { nombre: '31 - Placas', color: '#388e3c', total: 0, esperado: 0 },
                '32': { nombre: '32 - Arneses', color: '#c2185b', total: 0, esperado: 0 },
                '33': { nombre: '33 - Gabinetes', color: '#f57c00', total: 0, esperado: 0 }
            };
            
            // Contar capturados por almac√©n
            registrosActivos.forEach(r => {
                if (almacenes[r.almacen]) {
                    almacenes[r.almacen].total++;
                }
            });
            
            // Contar esperados por almac√©n (del Kardex)
            if (kardexSAP.length > 0) {
                kardexSAP.forEach(k => {
                    if (almacenes[k.almacen]) {
                        almacenes[k.almacen].esperado++;
                    }
                });
            } else {
                // Si no hay Kardex, distribuir proporcionalmente
                almacenes['01'].esperado = 3800;
                almacenes['30'].esperado = 300;
                almacenes['31'].esperado = 200;
                almacenes['32'].esperado = 300;
                almacenes['33'].esperado = 2000;
                almacenes['00'].esperado = 100;
            }
            
            // Renderizar almacenes
            let htmlAlmacenes = '';
            Object.keys(almacenes).forEach(codigo => {
                const alm = almacenes[codigo];
                if (alm.esperado === 0 && alm.total === 0) return; // Skip vac√≠os
                
                const pct = alm.esperado > 0 ? ((alm.total / alm.esperado) * 100).toFixed(1) : 0;
                
                htmlAlmacenes += `
                    <div class="almacen-item">
                        <div class="almacen-header">
                            <span class="almacen-name">
                                <span class="almacen-dot" style="background: ${alm.color};"></span>
                                ${alm.nombre}
                            </span>
                            <span class="almacen-percent">${alm.total} / ${alm.esperado} (${pct}%)</span>
                        </div>
                        <div class="almacen-bar">
                            <div class="almacen-fill" style="width: ${Math.min(pct, 100)}%; background: ${alm.color};"></div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('almacenes-dashboard').innerHTML = htmlAlmacenes;
            
            // Top usuarios
            const usuarioStats = {};
            registrosActivos.forEach(r => {
                if (!usuarioStats[r.usuario]) {
                    usuarioStats[r.usuario] = 0;
                }
                usuarioStats[r.usuario]++;
            });
            
            const topUsuarios = Object.entries(usuarioStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            let htmlUsuarios = '';
            topUsuarios.forEach(([usuario, cantidad], index) => {
                const pctTotal = totalCapturado > 0 ? ((cantidad / totalCapturado) * 100).toFixed(1) : 0;
                const medalla = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üë§';
                
                htmlUsuarios += `
                    <div class="almacen-item">
                        <div class="almacen-header">
                            <span class="almacen-name">
                                <span style="margin-right: 8px;">${medalla}</span>
                                ${usuario}
                            </span>
                            <span class="almacen-percent">${cantidad} (${pctTotal}%)</span>
                        </div>
                        <div class="almacen-bar">
                            <div class="almacen-fill" style="width: ${pctTotal}%; background: #1976d2;"></div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('top-usuarios-dashboard').innerHTML = htmlUsuarios || '<p style="text-align: center; color: #9e9e9e; padding: 20px;">No hay datos a√∫n</p>';
        }
        
        // ========== BUSCADOR SAP ==========
        function buscarSAP() {
            const sapBuscado = document.getElementById('input-buscar-sap').value.trim();
            const resultado = document.getElementById('resultado-buscador-sap');
            
            if (!sapBuscado) {
                alert('‚ö†Ô∏è Ingresa un c√≥digo SAP');
                return;
            }
            
            // Buscar registros ACTIVOS con ese SAP
            const registrosEncontrados = registrosGuardados.filter(r => 
                r.sap === sapBuscado && 
                !r.eliminado && 
                !r.modificado
            );
            
            if (registrosEncontrados.length === 0) {
                resultado.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #9e9e9e;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
                        <div style="font-size: 16px; color: #424242;">No se encontraron registros para el SAP: ${sapBuscado}</div>
                    </div>
                `;
                return;
            }
            
            // Calcular totales
            const totalContado = registrosEncontrados.reduce((sum, r) => sum + (r.cantidad || 0), 0);
            const unidad = registrosEncontrados[0].unidadMedida || 'PZA';
            const descripcion = registrosEncontrados[0].desc || 'Sin descripci√≥n';
            
            // Buscar en Kardex SAP
            const kardexItem = kardexSAP.find(k => k.sap === sapBuscado);
            const cantidadKardex = kardexItem ? kardexItem.cantidad : 0;
            const diferencia = totalContado - cantidadKardex;
            const colorDif = diferencia === 0 ? '#388e3c' : diferencia > 0 ? '#1976d2' : '#d32f2f';
            const iconoDif = diferencia === 0 ? '‚úÖ' : diferencia > 0 ? 'üìà' : 'üìâ';
            
            let html = `
                <!-- Resumen -->
                <div style="background: #e3f2fd; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <div style="font-size: 14px; color: #1565c0; font-weight: 700; margin-bottom: 8px;">SAP: ${sapBuscado}</div>
                    <div style="font-size: 13px; color: #424242; margin-bottom: 16px;">${descripcion}</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">REGISTROS</div>
                            <div style="font-size: 20px; font-weight: 700; color: #1a237e;">${registrosEncontrados.length}</div>
                        </div>
                        <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">TOTAL CONTADO</div>
                            <div style="font-size: 20px; font-weight: 700; color: #1976d2;">${totalContado} ${unidad}</div>
                        </div>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; padding: 12px;">
                        <div style="font-size: 11px; color: #757575; margin-bottom: 8px;">KARDEX SAP</div>
                        <div style="font-size: 18px; font-weight: 700; color: #424242; margin-bottom: 12px;">${cantidadKardex} ${unidad}</div>
                        
                        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">DIFERENCIA</div>
                        <div style="font-size: 22px; font-weight: 700; color: ${colorDif};">
                            ${iconoDif} ${diferencia > 0 ? '+' : ''}${diferencia} ${unidad}
                        </div>
                        <div style="font-size: 12px; color: ${colorDif}; margin-top: 4px;">
                            ${diferencia === 0 ? 'Exacto ‚úì' : diferencia > 0 ? 'Sobrante' : 'Faltante'}
                        </div>
                    </div>
                </div>
                
                <!-- Lista de registros -->
                <div style="margin-bottom: 8px;">
                    <strong style="font-size: 14px; color: #1a237e;">Detalle de Registros:</strong>
                </div>
            `;
            
            registrosEncontrados.forEach(r => {
                html += `
                    <div style="background: white; border-radius: 8px; padding: 12px; margin-bottom: 8px; border-left: 4px solid #1976d2;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <div style="font-weight: 700; color: #1a237e;">${r.folio}</div>
                            <div style="background: #e3f2fd; color: #1565c0; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">üì¶ ${r.almacen}</div>
                        </div>
                        <div style="font-size: 14px; color: #424242; margin-bottom: 4px;">
                            <strong>${r.cantidad} ${r.unidadMedida || 'PZA'}</strong>
                        </div>
                        <div style="font-size: 12px; color: #757575;">
                            Ubicaci√≥n: ${r.ubicacion || 'N/A'}
                        </div>
                        <div style="font-size: 11px; color: #9e9e9e; margin-top: 4px;">
                            üë§ ${r.usuario} ‚Ä¢ ${new Date(r.fecha).toLocaleString('es-MX', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'})}
                        </div>
                    </div>
                `;
            });
            
            resultado.innerHTML = html;
        }
        
        // Inicializar cuando se carga la p√°gina
        window.addEventListener('load', () => {
            setTimeout(inicializarFirebase, 1000);
        });
    </script>
</body>
</html>
